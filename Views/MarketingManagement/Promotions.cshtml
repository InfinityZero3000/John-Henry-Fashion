@model List<JohnHenryFashionWeb.Models.SystemPromotion>
@{
    ViewData["Title"] = "Quản lý Khuyến mãi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item\"><a href=\"/admin/marketing\">Marketing</a></li><li class=\"breadcrumb-item active\">Khuyến mãi</li>";
    
    var activePromos = Model.Count(p => p.IsActive);
    var totalUsage = Model.Sum(p => p.UsageCount);
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="tag"></i>
                Quản lý Khuyến mãi
            </h1>
            <a href="/admin/marketing/promotion/create" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Tạo khuyến mãi
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    <!-- Statistics -->
    <div class="admin-stats-grid" style="margin-bottom: var(--spacing-lg);">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng khuyến mãi</h3>
                    <p class="value">@Model.Count</p>
                    <p class="change">@activePromos đang hoạt động</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="tag"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Lượt sử dụng</h3>
                    <p class="value">@totalUsage.ToString("N0")</p>
                    <p class="change">Tổng số lần dùng</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="shopping-cart"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tỷ lệ hoạt động</h3>
                    <p class="value">@((Model.Count > 0 ? (activePromos * 100.0 / Model.Count).ToString("F0") : "0"))%</p>
                    <p class="change">Đang chạy</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="trending-up"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotions List -->
    @if (Model == null || !Model.Any())
    {
        <div class="admin-card">
            <div class="admin-card-body admin-text-center" style="padding: 3rem;">
                <i data-lucide="tag" style="width: 64px; height: 64px; color: var(--admin-text-muted); margin-bottom: 1rem;"></i>
                <h3 style="margin-bottom: 0.5rem;">Chưa có khuyến mãi</h3>
                <p style="color: var(--admin-text-light); margin-bottom: 1.5rem;">Tạo khuyến mãi đầu tiên để thu hút khách hàng</p>
                <a href="/admin/marketing/promotion/create" class="admin-btn admin-btn-primary">
                    <i data-lucide="plus"></i>
                    Tạo khuyến mãi
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="admin-card">
            <div class="admin-card-body" style="padding: 0;">
                <div class="admin-table-wrapper" style="border: none; border-radius: 0;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Mã & Tên</th>
                                <th>Loại giảm giá</th>
                                <th>Điều kiện</th>
                                <th>Sử dụng</th>
                                <th>Thời gian</th>
                                <th>Trạng thái</th>
                                <th style="width: 150px;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var promo in Model)
                            {
                                var isExpired = promo.EndDate < DateTime.UtcNow;
                                var isUpcoming = promo.StartDate > DateTime.UtcNow;
                                var isActive = promo.IsActive && !isExpired && !isUpcoming;
                                
                                <tr>
                                    <td>
                                        <div style="font-weight: 600; font-size: 1rem; color: var(--admin-primary); font-family: 'Courier New', monospace;">
                                            @promo.Code
                                        </div>
                                        <div style="font-weight: 500; margin-top: 0.25rem;">@promo.Name</div>
                                        @if (!string.IsNullOrEmpty(promo.Description))
                                        {
                                            <div style="font-size: 0.8125rem; color: var(--admin-text-light); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                @promo.Description
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (promo.Type == "percentage")
                                        {
                                            <span class="admin-badge admin-badge-success" style="font-size: 0.9375rem;">
                                                <i data-lucide="percent" style="width: 14px; height: 14px;"></i>
                                                @promo.Value% OFF
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="admin-badge admin-badge-info" style="font-size: 0.9375rem;">
                                                <i data-lucide="dollar-sign" style="width: 14px; height: 14px;"></i>
                                                -@promo.Value.ToString("N0")đ
                                            </span>
                                        }
                                        @if (promo.MaxDiscountAmount.HasValue && promo.MaxDiscountAmount.Value > 0)
                                        {
                                            <div style="font-size: 0.75rem; color: var(--admin-text-light); margin-top: 0.25rem;">
                                                Tối đa: @promo.MaxDiscountAmount.Value.ToString("N0")đ
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (promo.MinOrderAmount.HasValue && promo.MinOrderAmount.Value > 0)
                                        {
                                            <div style="font-size: 0.875rem;">
                                                <i data-lucide="shopping-bag" style="width: 14px; height: 14px;"></i>
                                                Đơn tối thiểu:
                                            </div>
                                            <div style="font-weight: 600; color: var(--admin-primary);">
                                                @promo.MinOrderAmount.Value.ToString("N0")đ
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="admin-badge admin-badge-secondary">Không giới hạn</span>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-weight: 600; font-size: 1.125rem;">
                                            @promo.UsageCount / @(promo.UsageLimit > 0 ? promo.UsageLimit.ToString() : "∞")
                                        </div>
                                        @if (promo.UsageLimitPerUser.HasValue && promo.UsageLimitPerUser.Value > 0)
                                        {
                                            <div style="font-size: 0.75rem; color: var(--admin-text-light);">
                                                @promo.UsageLimitPerUser.Value lần/người
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-size: 0.875rem;">
                                            <i data-lucide="calendar" style="width: 12px; height: 12px;"></i>
                                            @promo.StartDate.ToString("dd/MM/yyyy")
                                        </div>
                                        <div style="font-size: 0.875rem; color: var(--admin-text-light);">
                                            <i data-lucide="arrow-right" style="width: 12px; height: 12px;"></i>
                                            @promo.EndDate.ToString("dd/MM/yyyy")
                                        </div>
                                    </td>
                                    <td>
                                        @if (isExpired)
                                        {
                                            <span class="admin-badge admin-badge-secondary">
                                                <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                                                Đã hết hạn
                                            </span>
                                        }
                                        else if (isUpcoming)
                                        {
                                            <span class="admin-badge admin-badge-info">
                                                <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                                                Sắp diễn ra
                                            </span>
                                        }
                                        else if (isActive)
                                        {
                                            <span class="admin-badge admin-badge-success">
                                                <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                                Đang hoạt động
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="admin-badge admin-badge-warning">
                                                <i data-lucide="pause-circle" style="width: 12px; height: 12px;"></i>
                                                Tạm dừng
                                            </span>
                                        }
                                    </td>
                                    <td class="actions">
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: nowrap;">
                                            <a href="/admin/marketing/promotion/@promo.Id" class="admin-btn admin-btn-sm admin-btn-primary" title="Sửa">
                                                <i data-lucide="edit"></i>
                                            </a>
                                            <button onclick="deletePromotion('@promo.Id')" class="admin-btn admin-btn-sm admin-btn-danger" title="Xóa">
                                                <i data-lucide="trash-2"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Hidden form for antiforgery token -->
<form id="antiforgeryForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        function deletePromotion(promotionId) {
            if (!confirm('Xác nhận xóa khuyến mãi này? Hành động này không thể hoàn tác!')) {
                return;
            }

            const form = new FormData();
            form.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            fetch(`/admin/marketing/promotion/${promotionId}/delete`, {
                method: 'POST',
                body: form
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra khi xóa khuyến mãi');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa khuyến mãi');
            });
        }

        // Auto-hide success messages
        setTimeout(function() {
            var alerts = document.querySelectorAll('.admin-alert');
            alerts.forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            });
        }, 5000);
    </script>
}
