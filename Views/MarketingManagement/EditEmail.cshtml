@model JohnHenryFashionWeb.Models.EmailCampaign
@{
    ViewData["Title"] = "Chỉnh sửa Email Campaign";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item\"><a href=\"/admin/marketing\">Marketing</a></li><li class=\"breadcrumb-item\"><a href=\"/admin/marketing/email\">Email Campaigns</a></li><li class=\"breadcrumb-item active\">Chỉnh sửa</li>";
}

<div class="admin-content">
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title"><i data-lucide="edit"></i> Chỉnh sửa Email Campaign</h1>
            <span class="admin-badge admin-badge-@(Model.Status == "sent" ? "success" : Model.Status == "scheduled" ? "info" : "secondary")">
                @Model.Status
            </span>
        </div>
    </div>

    <div class="admin-card">
        <div class="admin-card-body">
            <form method="post" action="/admin/marketing/email/@Model.Id">
                @Html.AntiForgeryToken()
                
                <div class="admin-form-section">
                    <h3 class="admin-form-section-title"><i data-lucide="info"></i> Thông tin cơ bản</h3>
                    <div class="mb-3">
                        <label for="Name" class="form-label">Tên Campaign <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="Name" name="Name" value="@Model.Name" required />
                    </div>
                    <div class="mb-3">
                        <label for="Subject" class="form-label">Subject Email <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="Subject" name="Subject" value="@Model.Subject" required />
                    </div>
                </div>

                <div class="admin-form-section">
                    <h3 class="admin-form-section-title"><i data-lucide="file-text"></i> Nội dung</h3>
                    <div class="mb-3">
                        <label for="HtmlContent" class="form-label">HTML Content <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="HtmlContent" name="HtmlContent" rows="10" required>@Model.HtmlContent</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="PlainTextContent" class="form-label">Plain Text</label>
                        <textarea class="form-control" id="PlainTextContent" name="PlainTextContent" rows="5">@Model.PlainTextContent</textarea>
                    </div>
                </div>

                <div class="admin-form-section">
                    <h3 class="admin-form-section-title"><i data-lucide="users"></i> Đối tượng & Trạng thái</h3>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="TargetAudience" class="form-label">Đối tượng</label>
                            <select class="form-select" id="TargetAudience" name="TargetAudience">
                                <option value="all" selected="@(Model.TargetAudience == "all" ? "selected" : null)">Tất cả</option>
                                <option value="customers" selected="@(Model.TargetAudience == "customers" ? "selected" : null)">Khách hàng</option>
                                <option value="sellers" selected="@(Model.TargetAudience == "sellers" ? "selected" : null)">Người bán</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="Status" class="form-label">Trạng thái</label>
                            <select class="form-select" id="Status" name="Status">
                                <option value="draft" selected="@(Model.Status == "draft" ? "selected" : null)">Nháp</option>
                                <option value="scheduled" selected="@(Model.Status == "scheduled" ? "selected" : null)">Lên lịch</option>
                                <option value="sent" selected="@(Model.Status == "sent" ? "selected" : null)">Đã gửi</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ScheduledAt" class="form-label">Thời gian gửi</label>
                            <input type="datetime-local" class="form-control" id="ScheduledAt" name="ScheduledAt" value="@(Model.ScheduledAt?.ToString("yyyy-MM-ddTHH:mm"))" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Tổng người nhận</label>
                            <input type="text" class="form-control" value="@Model.TotalRecipients" readonly style="background-color: #f8f9fa;" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Đã gửi</label>
                            <input type="text" class="form-control" value="@Model.SentCount" readonly style="background-color: #f8f9fa;" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Lượt mở</label>
                            <input type="text" class="form-control" value="@Model.OpenCount" readonly style="background-color: #f8f9fa;" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Lượt click</label>
                            <input type="text" class="form-control" value="@Model.ClickCount" readonly style="background-color: #f8f9fa;" />
                        </div>
                    </div>
                </div>

                <div class="admin-form-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--admin-border-color);">
                    <button type="submit" class="admin-btn admin-btn-primary admin-btn-lg">
                        <i data-lucide="save"></i> Lưu thay đổi
                    </button>
                    <a href="/admin/marketing/email" class="admin-btn admin-btn-secondary admin-btn-lg">
                        <i data-lucide="x"></i> Hủy
                    </a>
                    <button type="button" onclick="deleteEmailCampaign()" class="admin-btn admin-btn-danger admin-btn-lg" style="margin-left: auto;">
                        <i data-lucide="trash-2"></i> Xóa Campaign
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="antiforgeryForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js"></script>
    <script>
        lucide.createIcons();
        tinymce.init({
            selector: '#HtmlContent',
            height: 500,
            plugins: 'code link image lists table',
            toolbar: 'undo redo | bold italic | bullist numlist | link image | code'
        });

        function deleteEmailCampaign() {
            if (!confirm('Xác nhận xóa Email Campaign này?')) return;
            const form = new FormData();
            form.append('__RequestVerificationToken', document.querySelector('#antiforgeryForm input[name="__RequestVerificationToken"]').value);
            fetch('/admin/marketing/email/@Model.Id/delete', {
                method: 'POST',
                body: form
            }).then(r => r.ok ? window.location.href = '/admin/marketing/email' : alert('Lỗi khi xóa'));
        }
    </script>
}
