@model JohnHenryFashionWeb.ViewModels.UserDetailViewModel
@{
    ViewData["Title"] = "Chi tiết người dùng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item\"><a href=\"" + Url.Action("Users") + "\">Người dùng</a></li><li class=\"breadcrumb-item active\">Chi tiết</li>";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="user"></i>
                    Chi tiết người dùng
                </h1>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="@Url.Action("Users")" class="admin-btn admin-btn-secondary">
                    <i data-lucide="arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["Success"]</span>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="admin-alert admin-alert-danger">
            <i data-lucide="alert-circle"></i>
            <span>@TempData["Error"]</span>
        </div>
    }

    <!-- Lockout Warning -->
    @if (Model.IsLockedOut)
    {
        <div class="admin-alert admin-alert-warning" style="border-left: 4px solid #ffc107;">
            <div style="display: flex; align-items: start; gap: 1rem;">
                <i data-lucide="lock" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;"></i>
                <div style="flex: 1;">
                    <strong style="display: block; margin-bottom: 0.5rem;">
                        <i data-lucide="alert-triangle" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                        Tài khoản đang bị khóa tạm thời
                    </strong>
                    <p style="margin-bottom: 0.5rem;">
                        Tài khoản này đã bị khóa do nhập sai mật khẩu quá nhiều lần (@Model.FailedLoginAttempts lần thử).
                    </p>
                    @if (Model.LockoutEnd.HasValue)
                    {
                        var timeRemaining = Model.LockoutEnd.Value - DateTime.UtcNow;
                        if (timeRemaining.TotalMinutes > 0)
                        {
                            <p style="margin-bottom: 0.5rem;">
                                <strong>Thời gian khóa còn lại:</strong> 
                                @if (timeRemaining.TotalHours >= 1)
                                {
                                    <span>@((int)timeRemaining.TotalHours) giờ @((int)timeRemaining.TotalMinutes % 60) phút</span>
                                }
                                else
                                {
                                    <span>@((int)timeRemaining.TotalMinutes) phút</span>
                                }
                                <br>
                                <small class="text-muted">
                                    Tài khoản sẽ tự động mở khóa vào: <strong>@Model.LockoutEnd.Value.ToString("dd/MM/yyyy HH:mm:ss")</strong>
                                </small>
                            </p>
                        }
                        else
                        {
                            <p style="margin-bottom: 0.5rem;">
                                <strong>Thời gian khóa đã hết hạn.</strong> Tài khoản có thể đăng nhập lại.
                            </p>
                        }
                    }
                    <div style="margin-top: 0.75rem;">
                        <button onclick="unlockUser('@Model.User.Id')" class="admin-btn admin-btn-sm admin-btn-warning">
                            <i data-lucide="unlock" style="width: 16px; height: 16px;"></i>
                            Gỡ khóa tài khoản ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng đơn hàng</h3>
                    <p class="value">@Model.OrderCount</p>
                    <p class="change">Đơn hàng đã đặt</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="shopping-cart"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng chi tiêu</h3>
                    <p class="value">@Model.TotalSpent.ToString("N0") đ</p>
                    <p class="change">Giá trị đơn hàng</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="dollar-sign"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Trạng thái tài khoản</h3>
                    <p class="value">@(Model.User.IsActive ? "Hoạt động" : "Đã khóa")</p>
                    <p class="change">@(Model.IsLockedOut ? "Đang bị khóa tạm thời" : "Bình thường")</p>
                </div>
                <div class="admin-stat-card-icon @(Model.User.IsActive ? "success" : "danger")">
                    <i data-lucide="@(Model.User.IsActive ? "user-check" : "user-x")"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Bảo mật</h3>
                    <p class="value">@Model.FailedLoginAttempts / 3</p>
                    <p class="change">@(Model.FailedLoginAttempts >= 3 ? "Đã vượt giới hạn" : "Số lần sai")</p>
                </div>
                <div class="admin-stat-card-icon @(Model.FailedLoginAttempts >= 3 ? "danger" : "info")">
                    <i data-lucide="shield"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: User Info -->
        <div class="col-lg-4">
            <!-- User Profile Card -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="user"></i>
                        Thông tin cá nhân
                    </h5>
                </div>
                <div class="admin-card-body text-center">
                    <!-- Avatar -->
                    <div class="mb-3">
                        @if (!string.IsNullOrEmpty(Model.User.Avatar))
                        {
                            <img src="@Model.User.Avatar" alt="@Model.User.FullName" 
                                 style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--admin-border);">
                        }
                        else
                        {
                            <div style="width: 120px; height: 120px; background: var(--admin-bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid var(--admin-border); margin: 0 auto;">
                                <i data-lucide="user" style="width: 60px; height: 60px; color: var(--admin-text-muted);"></i>
                            </div>
                        }
                    </div>

                    <!-- Name -->
                    <h4 class="mb-2">@Model.User.FullName</h4>
                    <p class="text-muted mb-3">@Model.User.Email</p>

                    <!-- Status Badge -->
                    <div class="mb-3">
                        @if (Model.User.IsActive)
                        {
                            <span class="admin-badge admin-badge-success">
                                <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                                Đang hoạt động
                            </span>
                        }
                        else
                        {
                            <span class="admin-badge admin-badge-danger">
                                <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                                Đã khóa
                            </span>
                        }
                    </div>

                    <!-- Roles -->
                    <div class="mb-3">
                        @foreach (var role in Model.Roles)
                        {
                            @switch (role)
                            {
                                case "Admin":
                                    <span class="admin-badge admin-badge-danger mb-1">
                                        <i data-lucide="shield" style="width: 12px; height: 12px;"></i>
                                        @role
                                    </span>
                                    break;
                                case "Seller":
                                    <span class="admin-badge admin-badge-warning mb-1">
                                        <i data-lucide="store" style="width: 12px; height: 12px;"></i>
                                        @role
                                    </span>
                                    break;
                                default:
                                    <span class="admin-badge admin-badge-info mb-1">
                                        <i data-lucide="shopping-bag" style="width: 12px; height: 12px;"></i>
                                        @role
                                    </span>
                                    break;
                            }
                        }
                    </div>

                    <!-- Quick Actions -->
                    <div class="d-grid gap-2 mt-4">
                        @if (Model.IsLockedOut)
                        {
                            <button onclick="unlockUser('@Model.User.Id')" class="admin-btn admin-btn-warning">
                                <i data-lucide="unlock"></i>
                                Gỡ khóa tài khoản (do nhập sai mật khẩu)
                            </button>
                        }
                        <button onclick="toggleUserStatus('@Model.User.Id', @Model.User.IsActive.ToString().ToLower())" 
                                class="admin-btn @(Model.User.IsActive ? "admin-btn-danger" : "admin-btn-success")">
                            <i data-lucide="@(Model.User.IsActive ? "lock" : "unlock")"></i>
                            @(Model.User.IsActive ? "Khóa tài khoản" : "Mở khóa tài khoản")
                        </button>
                        <button onclick="resetPassword('@Model.User.Id')" class="admin-btn admin-btn-warning">
                            <i data-lucide="key"></i>
                            Đặt lại mật khẩu
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lockout Information Card -->
            @if (Model.IsLockedOut || Model.FailedLoginAttempts > 0)
            {
                <div class="admin-card mt-4">
                    <div class="admin-card-header @(Model.IsLockedOut ? "bg-warning text-dark" : "")">
                        <h5 class="admin-card-title">
                            <i data-lucide="@(Model.IsLockedOut ? "lock" : "shield")"></i>
                            Thông tin bảo mật
                        </h5>
                    </div>
                    <div class="admin-card-body">
                        @if (Model.IsLockedOut)
                        {
                            <div class="mb-3 p-3" style="background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <i data-lucide="alert-triangle" style="width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px; color: #ffc107;"></i>
                                    <div>
                                        <strong style="color: #856404;">Tài khoản đang bị khóa tạm thời</strong>
                                        <p class="mb-0 small" style="color: #856404; margin-top: 0.25rem;">Do nhập sai mật khẩu quá nhiều lần</p>
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="admin-info-item">
                            <label class="admin-info-label">
                                <i data-lucide="@(Model.IsLockedOut ? "lock" : "shield-check")"></i>
                                Trạng thái khóa
                            </label>
                            <div class="admin-info-value">
                                @if (Model.IsLockedOut)
                                {
                                    <span class="admin-badge admin-badge-warning">
                                        <i data-lucide="lock" style="width: 12px; height: 12px;"></i>
                                        Đang bị khóa
                                    </span>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-success">
                                        <i data-lucide="unlock" style="width: 12px; height: 12px;"></i>
                                        Không bị khóa
                                    </span>
                                }
                            </div>
                        </div>
                        <div class="admin-info-item">
                            <label class="admin-info-label">
                                <i data-lucide="x-circle"></i>
                                Số lần đăng nhập sai
                            </label>
                            <div class="admin-info-value">
                                <strong>@Model.FailedLoginAttempts</strong> / 3 lần
                                @if (Model.FailedLoginAttempts >= 3)
                                {
                                    <span class="admin-badge admin-badge-danger ms-2">Đã vượt giới hạn</span>
                                }
                            </div>
                        </div>
                        @if (Model.IsLockedOut && Model.LockoutEnd.HasValue)
                        {
                            var timeRemaining = Model.LockoutEnd.Value - DateTime.UtcNow;
                            <div class="admin-info-item">
                                <label class="admin-info-label">
                                    <i data-lucide="clock"></i>
                                    Thời gian khóa còn lại
                                </label>
                                <div class="admin-info-value">
                                    @if (timeRemaining.TotalMinutes > 0)
                                    {
                                        @if (timeRemaining.TotalHours >= 1)
                                        {
                                            <span><strong>@((int)timeRemaining.TotalHours)</strong> giờ <strong>@((int)timeRemaining.TotalMinutes % 60)</strong> phút</span>
                                        }
                                        else
                                        {
                                            <span><strong>@((int)timeRemaining.TotalMinutes)</strong> phút</span>
                                        }
                                        <br>
                                        <small class="text-muted">
                                            Tự động mở khóa: <strong>@Model.LockoutEnd.Value.ToString("dd/MM/yyyy HH:mm:ss")</strong>
                                        </small>
                                    }
                                    else
                                    {
                                        <span class="admin-badge admin-badge-info">Đã hết hạn</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Contact & Activity Card -->
            <div class="admin-card mt-4">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="activity"></i>
                        Hoạt động & Thời gian
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="admin-info-item">
                        <label class="admin-info-label">
                            <i data-lucide="calendar"></i>
                            Ngày tham gia
                        </label>
                        <div class="admin-info-value">
                            @Model.JoinDate.ToString("dd/MM/yyyy HH:mm")
                            <br>
                            <small class="text-muted">
                                @{
                                    var daysSinceJoin = (DateTime.UtcNow - Model.JoinDate).Days;
                                }
                                @daysSinceJoin ngày trước
                            </small>
                        </div>
                    </div>
                    @if (Model.LastActivity.HasValue)
                    {
                        <div class="admin-info-item">
                            <label class="admin-info-label">
                                <i data-lucide="clock"></i>
                                Hoạt động cuối
                            </label>
                            <div class="admin-info-value">
                                @Model.LastActivity.Value.ToString("dd/MM/yyyy HH:mm")
                                <br>
                                <small class="text-muted">
                                    @{
                                        var timeSinceActivity = DateTime.UtcNow - Model.LastActivity.Value;
                                        if (timeSinceActivity.TotalDays >= 1)
                                        {
                                            <text>@((int)timeSinceActivity.TotalDays) ngày trước</text>
                                        }
                                        else if (timeSinceActivity.TotalHours >= 1)
                                        {
                                            <text>@((int)timeSinceActivity.TotalHours) giờ trước</text>
                                        }
                                        else
                                        {
                                            <text>@((int)timeSinceActivity.TotalMinutes) phút trước</text>
                                        }
                                    }
                                </small>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Details & Orders -->
        <div class="col-lg-8">
            <!-- Contact Information -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="admin-card-title">
                        <i data-lucide="contact"></i>
                        Thông tin liên hệ
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="admin-info-item">
                                <label class="admin-info-label">
                                    <i data-lucide="mail"></i>
                                    Email
                                </label>
                                <div class="admin-info-value">@Model.User.Email</div>
                                @if (Model.User.EmailConfirmed)
                                {
                                    <span class="admin-badge admin-badge-success mt-1">
                                        <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                                        Đã xác nhận
                                    </span>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-warning mt-1">
                                        <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                                        Chưa xác nhận
                                    </span>
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="admin-info-item">
                                <label class="admin-info-label">
                                    <i data-lucide="phone"></i>
                                    Số điện thoại
                                </label>
                                <div class="admin-info-value">@(Model.User.PhoneNumber ?? "Chưa cập nhật")</div>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.User.DateOfBirth?.ToString()))
                        {
                            <div class="col-md-6">
                                <div class="admin-info-item">
                                    <label class="admin-info-label">
                                        <i data-lucide="calendar"></i>
                                        Ngày sinh
                                    </label>
                                    <div class="admin-info-value">@Model.User.DateOfBirth.Value.ToString("dd/MM/yyyy")</div>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.User.Gender))
                        {
                            <div class="col-md-6">
                                <div class="admin-info-item">
                                    <label class="admin-info-label">
                                        <i data-lucide="user"></i>
                                        Giới tính
                                    </label>
                                    <div class="admin-info-value">@Model.User.Gender</div>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.User.Address))
                        {
                            <div class="col-12">
                                <div class="admin-info-item">
                                    <label class="admin-info-label">
                                        <i data-lucide="map-pin"></i>
                                        Địa chỉ
                                    </label>
                                    <div class="admin-info-value">@Model.User.Address</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="admin-card mt-4">
                <div class="admin-card-header">
                    <div class="admin-flex-between">
                        <h5 class="admin-card-title">
                            <i data-lucide="shopping-bag"></i>
                            Đơn hàng gần đây
                        </h5>
                        @if (Model.OrderCount > 0)
                        {
                            <a href="@Url.Action("Orders", "Admin", new { userId = Model.User.Id })" class="admin-btn admin-btn-sm admin-btn-secondary">
                                Xem tất cả (@Model.OrderCount)
                            </a>
                        }
                    </div>
                </div>
                <div class="admin-card-body">
                    @if (Model.RecentOrders != null && Model.RecentOrders.Any())
                    {
                        <div class="table-responsive">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Mã đơn</th>
                                        <th>Ngày đặt</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var order in Model.RecentOrders)
                                    {
                                        <tr>
                                            <td>
                                                <a href="@Url.Action("OrderDetails", "Admin", new { id = order.Id })" class="admin-link">
                                                    @order.OrderNumber
                                                </a>
                                            </td>
                                            <td>@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>@order.TotalAmount.ToString("N0") ₫</td>
                                            <td>
                                                @switch (order.Status?.ToLower())
                                                {
                                                    case "completed":
                                                    case "delivered":
                                                        <span class="admin-badge admin-badge-success">@order.Status</span>
                                                        break;
                                                    case "pending":
                                                        <span class="admin-badge admin-badge-warning">@order.Status</span>
                                                        break;
                                                    case "cancelled":
                                                        <span class="admin-badge admin-badge-danger">@order.Status</span>
                                                        break;
                                                    default:
                                                        <span class="admin-badge admin-badge-info">@order.Status</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                <a href="@Url.Action("OrderDetails", "Admin", new { id = order.Id })" class="admin-btn admin-btn-sm admin-btn-secondary">
                                                    <i data-lucide="eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i data-lucide="shopping-bag" style="width: 48px; height: 48px; color: var(--admin-text-muted);"></i>
                            <p class="text-muted mt-2">Chưa có đơn hàng nào</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Toggle user status
        function toggleUserStatus(userId, isActive) {
            const action = isActive ? 'khóa' : 'mở khóa';
            if (!confirm(`Xác nhận ${action} tài khoản này?`)) {
                return;
            }

            fetch('/admin/users/' + userId + '/toggle-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật trạng thái');
            });
        }

        // Reset password
        function resetPassword(userId) {
            if (!confirm('Xác nhận đặt lại mật khẩu cho tài khoản này? Mật khẩu mới sẽ là: TempPassword@123')) {
                return;
            }

            fetch('/admin/users/' + userId + '/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert('Có lỗi xảy ra: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi đặt lại mật khẩu');
            });
        }

        // Unlock user account (for lockout due to failed login attempts)
        function unlockUser(userId) {
            if (!confirm('Xác nhận gỡ khóa tài khoản này? Tài khoản sẽ có thể đăng nhập lại ngay lập tức.')) {
                return;
            }

            fetch('/admin/users/' + userId + '/unlock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Gỡ khóa tài khoản thành công!');
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi gỡ khóa tài khoản');
            });
        }
    </script>
}

