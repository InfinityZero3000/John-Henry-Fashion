@model JohnHenryFashionWeb.Models.BlogPost
@{
    ViewData["Title"] = "Tạo bài viết mới";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item\"><a href=\"/admin/blog\">Blog</a></li><li class=\"breadcrumb-item active\">Tạo bài viết mới</li>";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="file-plus"></i>
                Tạo bài viết mới
            </h1>
            <a href="@Url.Action("Blog", "Admin")" class="admin-btn admin-btn-secondary">
                <i data-lucide="arrow-left"></i>
                Quay lại
            </a>
        </div>
    </div>

    <form asp-controller="Admin" asp-action="CreateBlogPost" method="post" enctype="multipart/form-data" id="blogForm">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Thông tin cơ bản</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Title" class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control" placeholder="Nhập tiêu đề bài viết..." id="titleInput">
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Slug" class="form-label">Slug (URL thân thiện)</label>
                            <div class="input-group">
                                <input asp-for="Slug" class="form-control" placeholder="slug-bai-viet" id="slugInput">
                                <button type="button" class="btn btn-outline-secondary" onclick="regenerateSlug()" title="Tạo lại slug">
                                    <i data-lucide="refresh-cw"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">URL: /blog/<span id="slugPreview">slug-bai-viet</span></small>
                            <span asp-validation-for="Slug" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Excerpt" class="form-label">Mô tả ngắn</label>
                            <textarea asp-for="Excerpt" class="form-control" rows="3" placeholder="Nhập mô tả ngắn cho bài viết..."></textarea>
                            <small class="form-text text-muted">Mô tả này sẽ hiển thị trong danh sách bài viết và kết quả tìm kiếm.</small>
                            <span asp-validation-for="Excerpt" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Nội dung bài viết</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Content" class="form-label">Nội dung <span class="text-danger">*</span></label>
                            <textarea asp-for="Content" class="form-control" rows="15" id="contentEditor"></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- SEO Settings -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Cài đặt SEO</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="MetaTitle" class="form-label">Meta Title</label>
                            <input asp-for="MetaTitle" class="form-control" placeholder="Tiêu đề tối ưu SEO...">
                            <small class="form-text text-muted">Để trống để sử dụng tiêu đề bài viết. Nên giữ dưới 60 ký tự.</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="MetaDescription" class="form-label">Meta Description</label>
                            <textarea asp-for="MetaDescription" class="form-control" rows="2" placeholder="Mô tả cho search engine..."></textarea>
                            <small class="form-text text-muted">Nên giữ dưới 160 ký tự.</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <input name="TagsString" class="form-control" placeholder="tag1, tag2, tag3...">
                            <small class="form-text text-muted">Các từ khóa phân cách bằng dấu phẩy.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Publish Settings -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Xuất bản</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Status" class="form-label">Trạng thái</label>
                            <select asp-for="Status" class="form-select">
                                <option value="draft">Bản nháp</option>
                                <option value="published">Xuất bản</option>
                                <option value="archived">Lưu trữ</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PublishedAt" class="form-label">Ngày xuất bản</label>
                            <input asp-for="PublishedAt" type="datetime-local" class="form-control">
                            <small class="form-text text-muted">Để trống để sử dụng thời gian hiện tại khi xuất bản.</small>
                        </div>

                        <div class="form-check mb-3">
                            <input asp-for="IsFeatured" class="form-check-input" type="checkbox">
                            <label asp-for="IsFeatured" class="form-check-label">
                                Bài viết nổi bật
                            </label>
                            <small class="form-text text-muted d-block">Hiển thị bài viết này ở vị trí ưu tiên.</small>
                        </div>
                    </div>
                </div>

                <!-- Category -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Danh mục</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="CategoryId" class="form-label">Chọn danh mục</label>
                            <select asp-for="CategoryId" class="form-select" asp-items="@ViewBag.Categories">
                                <option value="">-- Chọn danh mục --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Featured Image -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Ảnh đại diện (Banner)</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Chọn ảnh</label>
                            <input type="file" name="FeaturedImage" class="form-control" accept="image/*" id="featuredImageInput">
                            <small class="form-text text-muted">Kích thước khuyến nghị: 1200x630px</small>
                        </div>

                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <img id="previewImg" src="" class="img-fluid rounded" style="max-height: 200px;">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeImage()">
                                <i data-lucide="trash-2"></i> Xóa ảnh
                            </button>
                        </div>

                        <div class="mb-3 mt-3">
                            <label class="form-label">Alt text cho ảnh</label>
                            <input name="FeaturedImageAlt" class="form-control" placeholder="Mô tả ảnh...">
                            <small class="form-text text-muted">Giúp tối ưu SEO và hỗ trợ người khuyết tật.</small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="publish" class="btn btn-success">
                                <i data-lucide="send"></i> Xuất bản ngay
                            </button>
                            <button type="submit" name="action" value="draft" class="btn btn-primary">
                                <i data-lucide="save"></i> Lưu bản nháp
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="previewPost()">
                                <i data-lucide="eye"></i> Xem trước
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Styles {
    <style>
        .card-header h6 {
            color: #5a5c69 !important;
        }
        
        .form-label {
            font-weight: 600;
            color: #5a5c69;
        }

        .text-danger {
            font-size: 0.875rem;
        }

        #imagePreview img {
            border: 2px solid #e3e6f0;
            max-height: 200px;
            object-fit: cover;
        }
    </style>
}

@section Scripts {
    <!-- TinyMCE with API Key -->
    <script src="https://cdn.tiny.cloud/1/d67td8nejj6rff12j33i4zzyx8mszk91dsvgzfcq74lrmmjv/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Initialize TinyMCE
        tinymce.init({
            selector: '#contentEditor',
            height: 500,
            menubar: 'file edit view insert format tools table help',
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
            ],
            toolbar: 'undo redo | blocks | bold italic forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media | removeformat code | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; line-height: 1.6; } img { max-width: 100%; height: auto; }',
            language: 'vi',
            promotion: false,
            branding: false,
            
            // Image upload configuration
            images_upload_url: '/admin/blog/upload-image',
            automatic_uploads: true,
            images_reuse_filename: false,
            images_upload_credentials: true,
            
            // Image upload handler
            images_upload_handler: function (blobInfo, progress) {
                return new Promise(function (resolve, reject) {
                    const xhr = new XMLHttpRequest();
                    xhr.withCredentials = true;
                    
                    xhr.upload.onprogress = function (e) {
                        progress(e.loaded / e.total * 100);
                    };
                    
                    xhr.onload = function () {
                        if (xhr.status === 403) {
                            reject({ message: 'Không có quyền upload ảnh', remove: true });
                            return;
                        }
                        
                        if (xhr.status < 200 || xhr.status >= 300) {
                            reject('HTTP Error: ' + xhr.status);
                            return;
                        }
                        
                        const json = JSON.parse(xhr.responseText);
                        
                        if (!json || typeof json.location != 'string') {
                            reject('Invalid JSON: ' + xhr.responseText);
                            return;
                        }
                        
                        resolve(json.location);
                    };
                    
                    xhr.onerror = function () {
                        reject('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
                    };
                    
                    const formData = new FormData();
                    formData.append('file', blobInfo.blob(), blobInfo.filename());
                    
                    xhr.open('POST', '/admin/blog/upload-image');
                    xhr.send(formData);
                });
            },
            
            // File picker for inserting images
            file_picker_types: 'image',
            file_picker_callback: function (callback, value, meta) {
                if (meta.filetype === 'image') {
                    const input = document.createElement('input');
                    input.setAttribute('type', 'file');
                    input.setAttribute('accept', 'image/*');
                    
                    input.onchange = function () {
                        const file = this.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = function () {
                            const id = 'blobid' + (new Date()).getTime();
                            const blobCache = tinymce.activeEditor.editorUpload.blobCache;
                            const base64 = reader.result.split(',')[1];
                            const blobInfo = blobCache.create(id, file, base64);
                            blobCache.add(blobInfo);
                            
                            callback(blobInfo.blobUri(), { title: file.name });
                        };
                        
                        reader.readAsDataURL(file);
                    };
                    
                    input.click();
                }
            }
        });

        // Auto-generate slug from title
        document.getElementById('titleInput').addEventListener('input', function() {
            const title = this.value;
            const slug = generateSlug(title);
            document.getElementById('slugInput').value = slug;
            document.getElementById('slugPreview').textContent = slug;
        });

        // Update slug preview when manually edited
        document.getElementById('slugInput').addEventListener('input', function() {
            document.getElementById('slugPreview').textContent = this.value;
        });

        function regenerateSlug() {
            const title = document.getElementById('titleInput').value;
            const slug = generateSlug(title);
            document.getElementById('slugInput').value = slug;
            document.getElementById('slugPreview').textContent = slug;
        }

        function generateSlug(text) {
            return text
                .toLowerCase()
                .replace(/[àáạảãâầấậẩẫăằắặẳẵ]/g, 'a')
                .replace(/[èéẹẻẽêềếệểễ]/g, 'e')
                .replace(/[ìíịỉĩ]/g, 'i')
                .replace(/[òóọỏõôồốộổỗơờớợởỡ]/g, 'o')
                .replace(/[ùúụủũưừứựửữ]/g, 'u')
                .replace(/[ỳýỵỷỹ]/g, 'y')
                .replace(/[đ]/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        // Image preview
        document.getElementById('featuredImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        function removeImage() {
            document.getElementById('featuredImageInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function previewPost() {
            // Get form data
            const title = document.getElementById('titleInput').value;
            const content = tinymce.get('contentEditor').getContent();
            
            if (!title || !content) {
                alert('Vui lòng nhập tiêu đề và nội dung trước khi xem trước.');
                return;
            }

            // Open preview in new window
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Preview: ${title}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                </head>
                <body>
                    <div class="container mt-4">
                        <h1>${title}</h1>
                        <hr>
                        <div>${content}</div>
                    </div>
                </body>
                </html>
            `);
        }

        // Form validation
        document.getElementById('blogForm').addEventListener('submit', function(e) {
            const title = document.getElementById('titleInput').value.trim();
            const content = tinymce.get('contentEditor').getContent().trim();

            if (!title) {
                alert('Vui lòng nhập tiêu đề bài viết.');
                e.preventDefault();
                return;
            }

            if (!content) {
                alert('Vui lòng nhập nội dung bài viết.');
                e.preventDefault();
                return;
            }
        });
    </script>
}
