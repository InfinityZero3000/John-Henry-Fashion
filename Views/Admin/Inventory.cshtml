@model JohnHenryFashionWeb.ViewModels.InventoryListViewModel
@{
    ViewData["Title"] = "Quản lý Tồn kho";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item active\">Quản lý tồn kho</li>";
    
    var filter = Model.Filter ?? "all";
    var searchTerm = Model.SearchTerm ?? "";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="package"></i>
                Quản lý Tồn kho
            </h1>
            <div style="display: flex; gap: 0.75rem;">
                <a href="/admin/products/create" class="admin-btn admin-btn-primary">
                    <i data-lucide="plus-circle"></i>
                    Tạo sản phẩm mới
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng sản phẩm</h3>
                    <p class="value">@Model.TotalStockQuantity.ToString("N0")</p>
                    <p class="change">Trong kho</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="box"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Sắp hết hàng</h3>
                    <p class="value">@Model.LowStockProducts</p>
                    <p class="change">Cần nhập thêm</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="alert-triangle"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Hết hàng</h3>
                    <p class="value">@Model.OutOfStockProducts</p>
                    <p class="change">Cần nhập ngay</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="x-circle"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Còn hàng tốt</h3>
                    <p class="value">@Model.InStockProducts</p>
                    <p class="change">Đủ hàng</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="check-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="admin-filters">
        <form method="get" action="/admin/inventory">
            <div class="row g-3 align-items-end">
                <!-- Search Box -->
                <div class="col-md-6">
                    <label class="admin-form-label">Tìm kiếm</label>
                    <div class="admin-search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" name="search" class="admin-form-input" 
                               placeholder="Tìm theo tên sản phẩm hoặc SKU..." 
                               value="@searchTerm">
                    </div>
                </div>

                <!-- Filter -->
                <div class="col-md-4">
                    <label class="admin-form-label">Lọc theo trạng thái</label>
                    <select name="filter" class="admin-form-select">
                        <option value="all" selected="@(filter == "all")">Tất cả</option>
                        <option value="in_stock" selected="@(filter == "in_stock")">Còn hàng tốt</option>
                        <option value="low_stock" selected="@(filter == "low_stock")">Sắp hết hàng</option>
                        <option value="out_of_stock" selected="@(filter == "out_of_stock")">Hết hàng</option>
                    </select>
                </div>

                <!-- Search Button -->
                <div class="col-md-2">
                    <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%;">
                        <i data-lucide="search"></i>
                        Tìm kiếm
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Filter Tabs -->
    <div class="admin-filter-tabs">
        <a href="/admin/inventory?filter=all&search=@searchTerm" 
           class="admin-filter-tab @(filter == "all" ? "active" : "")">
            Tất cả (@Model.Items.Count())
        </a>
        <a href="/admin/inventory?filter=in_stock&search=@searchTerm" 
           class="admin-filter-tab @(filter == "in_stock" ? "active" : "")">
            <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
            Còn hàng tốt (@Model.Items.Count(i => !i.IsLowStock && !i.IsOutOfStock))
        </a>
        <a href="/admin/inventory?filter=low_stock&search=@searchTerm" 
           class="admin-filter-tab @(filter == "low_stock" ? "active" : "")">
            <i data-lucide="alert-triangle" style="width: 14px; height: 14px;"></i>
            Sắp hết (@Model.Items.Count(i => i.IsLowStock && !i.IsOutOfStock))
        </a>
        <a href="/admin/inventory?filter=out_of_stock&search=@searchTerm" 
           class="admin-filter-tab @(filter == "out_of_stock" ? "active" : "")">
            <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
            Hết hàng (@Model.Items.Count(i => i.IsOutOfStock))
        </a>
    </div>

    <!-- Inventory Table -->
    @if (Model.Items.Any())
    {
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Sản phẩm</th>
                        <th>Danh mục</th>
                        <th>SKU</th>
                        <th>Giá bán</th>
                        <th>Giá vốn</th>
                        <th style="text-align: center;">Tồn kho</th>
                        <th style="text-align: center;">Trạng thái</th>
                        <th>Cập nhật</th>
                        <th style="width: 150px;">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <img src="@item.ImageUrl" alt="@item.ProductName" 
                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid var(--admin-border);">
                                }
                                else
                                {
                                    <div style="width: 50px; height: 50px; background: var(--admin-bg-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--admin-border);">
                                        <i data-lucide="image" style="width: 24px; height: 24px; color: var(--admin-text-muted);"></i>
                                    </div>
                                }
                            </td>
                            <td>
                                <div style="font-weight: 500; color: var(--admin-text); margin-bottom: 0.25rem;">
                                    @item.ProductName
                                </div>
                                <div style="font-size: 0.8125rem; color: var(--admin-text-light);">
                                    ID: @item.ProductId.ToString().Substring(0, 8)...
                                </div>
                            </td>
                            <td>
                                <span class="admin-badge admin-badge-secondary">@item.CategoryName</span>
                            </td>
                            <td>
                                <code style="font-size: 0.875rem; background: var(--admin-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px;">
                                    @item.SKU
                                </code>
                            </td>
                            <td>
                                <div style="font-weight: 500;">@item.Price.ToString("N0") đ</div>
                            </td>
                            <td>
                                <div style="color: var(--admin-text-light);">@item.CostPrice.ToString("N0") đ</div>
                            </td>
                            <td style="text-align: center;">
                                <div style="font-weight: 600; font-size: 1.125rem; color: @(item.IsOutOfStock ? "var(--status-danger)" : item.IsLowStock ? "var(--status-warning)" : "var(--status-success)");">
                                    @item.CurrentStock
                                </div>
                                <div style="font-size: 0.8125rem; color: var(--admin-text-light);">
                                    Min: @item.MinStock / Max: @item.MaxStock
                                </div>
                            </td>
                            <td style="text-align: center;">
                                @if (item.IsOutOfStock)
                                {
                                    <span class="admin-badge admin-badge-danger">
                                        <i data-lucide="x-circle" style="width: 12px; height: 12px;"></i>
                                        Hết hàng
                                    </span>
                                }
                                else if (item.IsLowStock)
                                {
                                    <span class="admin-badge admin-badge-warning">
                                        <i data-lucide="alert-triangle" style="width: 12px; height: 12px;"></i>
                                        Sắp hết
                                    </span>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-success">
                                        <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                        Còn hàng
                                    </span>
                                }
                            </td>
                            <td>
                                <div style="font-size: 0.875rem;">@item.LastUpdated.ToString("dd/MM/yyyy")</div>
                                <div style="font-size: 0.8125rem; color: var(--admin-text-light);">@item.LastUpdated.ToString("HH:mm")</div>
                            </td>
                            <td class="actions">
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <a href="/admin/products/edit/@item.ProductId" class="admin-btn admin-btn-sm admin-btn-secondary" title="Chỉnh sửa">
                                        <i data-lucide="edit"></i>
                                        Sửa
                                    </a>
                                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" 
                                            onclick="openInventoryModal('@item.ProductId', '@item.ProductName', @item.CurrentStock)" 
                                            title="Cập nhật tồn kho">
                                        <i data-lucide="package"></i>
                                        Tồn kho
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="admin-pagination">
                @if (Model.CurrentPage > 1)
                {
                    <a href="/admin/inventory?page=@(Model.CurrentPage - 1)&filter=@filter&search=@searchTerm" 
                       class="admin-pagination-btn">
                        <i data-lucide="chevron-left"></i>
                        Trước
                    </a>
                }
                else
                {
                    <button class="admin-pagination-btn" disabled>
                        <i data-lucide="chevron-left"></i>
                        Trước
                    </button>
                }

                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                {
                    <a href="/admin/inventory?page=@i&filter=@filter&search=@searchTerm" 
                       class="admin-pagination-btn @(i == Model.CurrentPage ? "active" : "")">
                        @i
                    </a>
                }

                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <a href="/admin/inventory?page=@(Model.CurrentPage + 1)&filter=@filter&search=@searchTerm" 
                       class="admin-pagination-btn">
                        Sau
                        <i data-lucide="chevron-right"></i>
                    </a>
                }
                else
                {
                    <button class="admin-pagination-btn" disabled>
                        Sau
                        <i data-lucide="chevron-right"></i>
                    </button>
                }
            </div>

            <div class="admin-text-center" style="margin-top: var(--spacing-md); color: var(--admin-text-light); font-size: 0.875rem;">
                Trang @Model.CurrentPage / @Model.TotalPages
            </div>
        }
    }
    else
    {
        <div class="admin-card">
            <div class="admin-card-body admin-text-center" style="padding: 3rem;">
                <i data-lucide="inbox" style="width: 64px; height: 64px; color: var(--admin-text-muted); margin-bottom: 1rem;"></i>
                <h3 style="margin-bottom: 0.5rem;">Không tìm thấy sản phẩm</h3>
                <p style="color: var(--admin-text-light); margin-bottom: 1.5rem;">
                    @if (!string.IsNullOrEmpty(searchTerm))
                    {
                        <text>Không có sản phẩm nào phù hợp với từ khóa "<strong>@searchTerm</strong>"</text>
                    }
                    else
                    {
                        <text>Không có sản phẩm nào trong kho</text>
                    }
                </p>
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <a href="/admin/inventory" class="admin-btn admin-btn-secondary">
                        <i data-lucide="x"></i>
                        Xóa bộ lọc
                    </a>
                }
            </div>
        </div>
    }
</div>

<!-- Update Inventory Modal -->
<div class="modal fade" id="updateInventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-lucide="package"></i>
                    Cập nhật tồn kho
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/admin/inventory/update">
                @Html.AntiForgeryToken()
                <input type="hidden" name="productId" id="modal-product-id">
                <div class="modal-body">
                    <div style="background: var(--admin-bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                        <div style="font-weight: 500; color: var(--admin-text); margin-bottom: 0.25rem;">Sản phẩm</div>
                        <div id="modal-product-name" style="font-size: 0.875rem; color: var(--admin-text-light);"></div>
                    </div>

                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i data-lucide="box" style="width: 14px; height: 14px;"></i>
                            Số lượng hiện tại
                        </label>
                        <input type="number" id="modal-current-stock" class="admin-form-control" readonly style="background: var(--admin-bg-secondary);">
                    </div>

                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i>
                            Số lượng thay đổi
                        </label>
                        <input type="number" name="quantityChange" class="admin-form-control" placeholder="Nhập số dương để thêm, số âm để giảm" required>
                        <small style="color: var(--admin-text-light); display: block; margin-top: 0.25rem;">
                            Ví dụ: 50 để nhập thêm hàng, -10 để giảm tồn kho
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">
                        <i data-lucide="x"></i>
                        Hủy
                    </button>
                    <button type="submit" class="admin-btn admin-btn-primary">
                        <i data-lucide="save"></i>
                        Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Open inventory update modal
        function openInventoryModal(productId, productName, currentStock) {
            document.getElementById('modal-product-id').value = productId;
            document.getElementById('modal-product-name').textContent = productName;
            document.getElementById('modal-current-stock').value = currentStock;
            
            const modal = new bootstrap.Modal(document.getElementById('updateInventoryModal'));
            modal.show();
        }

        // Reinitialize icons after modal shown
        document.getElementById('updateInventoryModal')?.addEventListener('shown.bs.modal', function() {
            lucide.createIcons();
        });

        // Highlight low stock items
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('.admin-table tbody tr');
            rows.forEach(function(row) {
                const stockBadge = row.querySelector('.admin-badge-danger, .admin-badge-warning');
                if (stockBadge) {
                    row.style.background = 'var(--admin-bg-secondary)';
                }
            });
        });
    </script>
}