@model List<JohnHenryFashionWeb.Models.SupportTicket>
@{
    ViewData["Title"] = "Hỗ trợ";
    ViewData["CurrentSection"] = "support";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <!-- User Sidebar -->
        @await Html.PartialAsync("_UserSidebar")

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Yêu cầu hỗ trợ của tôi</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i data-lucide="plus" class="me-2" style="width: 16px; height: 16px;"></i>Tạo yêu cầu mới
                    </a>
                </div>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i data-lucide="check-circle" class="me-2" style="width: 16px; height: 16px;"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i data-lucide="alert-circle" class="me-2" style="width: 16px; height: 16px;"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (Model.Any())
            {
                <div class="support-tickets">
                    @foreach (var ticket in Model)
                    {
                        var statusBadgeClass = ticket.Status switch
                        {
                            "Open" => "bg-warning text-dark",
                            "InProgress" or "In_Progress" => "bg-info text-white",
                            "Resolved" => "bg-success",
                            "Closed" => "bg-secondary",
                            _ => "bg-light text-dark"
                        };

                        var priorityBadgeClass = ticket.Priority?.ToLower() switch
                        {
                            "urgent" => "bg-danger",
                            "high" => "bg-warning text-dark",
                            "medium" => "bg-info",
                            _ => "bg-secondary"
                        };

                        var statusText = ticket.Status switch
                        {
                            "Open" => "Đang chờ",
                            "InProgress" or "In_Progress" => "Đang xử lý",
                            "Resolved" => "Đã giải quyết",
                            "Closed" => "Đã đóng",
                            _ => ticket.Status
                        };

                        <div class="card shadow mb-3 ticket-item">
                            <div class="card-header bg-light">
                                <div class="row align-items-center g-2">
                                    <div class="col-md-6 col-sm-12">
                                        <h6 class="mb-1">@ticket.Subject</h6>
                                        <small class="text-muted">
                                            <strong>@ticket.TicketNumber</strong> • 
                                            Tạo ngày: @ticket.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                    <div class="col-md-3 col-sm-6 text-md-center">
                                        <span class="badge @statusBadgeClass">@statusText</span>
                                        @if (ticket.Priority != null && ticket.Priority.ToLower() != "low")
                                        {
                                            <span class="badge @priorityBadgeClass ms-1">
                                                @(ticket.Priority?.ToLower() switch
                                                {
                                                    "urgent" => "Khẩn cấp",
                                                    "high" => "Cao",
                                                    "medium" => "TB",
                                                    _ => ""
                                                })
                                            </span>
                                        }
                                    </div>
                                    <div class="col-md-3 col-sm-6 text-md-end">
                                        <a href="@Url.Action("Details", new { id = ticket.Id })" class="btn btn-sm btn-outline-primary">
                                            <i data-lucide="eye" style="width: 14px; height: 14px;"></i> Xem chi tiết
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <p class="text-muted mb-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            @ticket.Description
                                        </p>
                                        <div class="d-flex gap-2 flex-wrap">
                                            @if (!string.IsNullOrEmpty(ticket.Category))
                                            {
                                                var categoryBadgeClass = ticket.Category.ToLower() switch
                                                {
                                                    "order" => "bg-primary",
                                                    "product" => "bg-success",
                                                    "payment" => "bg-danger",
                                                    "account" => "bg-info",
                                                    "refund" => "bg-warning text-dark",
                                                    "technical" => "bg-dark",
                                                    _ => "bg-secondary"
                                                };
                                                <span class="badge @categoryBadgeClass">
                                                    @(ticket.Category.ToLower() switch
                                                    {
                                                        "order" => "Đơn hàng",
                                                        "product" => "Sản phẩm",
                                                        "payment" => "Thanh toán",
                                                        "account" => "Tài khoản",
                                                        "refund" => "Hoàn tiền",
                                                        "technical" => "Kỹ thuật",
                                                        _ => "Chung"
                                                    })
                                                </span>
                                            }
                                            @if (ticket.ReplyCount > 0)
                                            {
                                                <span class="badge bg-light text-dark border">
                                                    <i data-lucide="message-circle" style="width: 12px; height: 12px;"></i>
                                                    @ticket.ReplyCount phản hồi
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block">
                                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                                            Cập nhật: @ticket.UpdatedAt.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                        @if (ticket.AssignedAdmin != null)
                                        {
                                            <small class="text-muted d-block mt-1">
                                                <i data-lucide="user-check" style="width: 12px; height: 12px;"></i>
                                                Người phụ trách: @ticket.AssignedAdmin.FirstName @ticket.AssignedAdmin.LastName
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i data-lucide="inbox" style="width: 64px; height: 64px; color: #6c757d;" class="mb-3"></i>
                    <h5 class="text-muted">Chưa có yêu cầu hỗ trợ nào</h5>
                    <p class="text-muted mb-3">Tạo yêu cầu hỗ trợ đầu tiên của bạn!</p>
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i data-lucide="plus" class="me-2" style="width: 16px; height: 16px;"></i>Tạo yêu cầu mới
                    </a>
                </div>
            }
        </main>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    </script>
}
