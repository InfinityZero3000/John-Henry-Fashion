@model List<JohnHenryFashionWeb.Models.SupportTicket>
@{
    ViewData["Title"] = "Hỗ trợ";
    ViewData["CurrentSection"] = "support";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <!-- User Sidebar -->
        @await Html.PartialAsync("_UserSidebar")

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-life-ring text-primary me-2"></i>
                    Yêu cầu hỗ trợ của tôi
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Tạo yêu cầu mới
                    </a>
                </div>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Tổng số
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalTickets</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Đang chờ
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.OpenTickets</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clock fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Đang xử lý
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.InProgressTickets</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-spinner fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Đã giải quyết
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.ResolvedTickets</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Bộ lọc</h6>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Trạng thái</label>
                            <select name="status" class="form-select" onchange="this.form.submit()">
                                <option value="">Tất cả</option>
                                <option value="open" selected="@(ViewBag.StatusFilter == "open" ? "selected" : null)">Đang chờ</option>
                                <option value="inprogress" selected="@(ViewBag.StatusFilter == "inprogress" ? "selected" : null)">Đang xử lý</option>
                                <option value="resolved" selected="@(ViewBag.StatusFilter == "resolved" ? "selected" : null)">Đã giải quyết</option>
                                <option value="closed" selected="@(ViewBag.StatusFilter == "closed" ? "selected" : null)">Đã đóng</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Danh mục</label>
                            <select name="category" class="form-select" onchange="this.form.submit()">
                                <option value="">Tất cả</option>
                                <option value="order" selected="@(ViewBag.CategoryFilter == "order" ? "selected" : null)">Đơn hàng</option>
                                <option value="product" selected="@(ViewBag.CategoryFilter == "product" ? "selected" : null)">Sản phẩm</option>
                                <option value="payment" selected="@(ViewBag.CategoryFilter == "payment" ? "selected" : null)">Thanh toán</option>
                                <option value="account" selected="@(ViewBag.CategoryFilter == "account" ? "selected" : null)">Tài khoản</option>
                                <option value="refund" selected="@(ViewBag.CategoryFilter == "refund" ? "selected" : null)">Hoàn tiền</option>
                                <option value="technical" selected="@(ViewBag.CategoryFilter == "technical" ? "selected" : null)">Kỹ thuật</option>
                                <option value="contact" selected="@(ViewBag.CategoryFilter == "contact" ? "selected" : null)">Liên hệ</option>
                                <option value="general" selected="@(ViewBag.CategoryFilter == "general" ? "selected" : null)">Chung</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-redo me-2"></i>Làm mới
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tickets List -->
            @if (Model.Any())
            {
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Danh sách yêu cầu hỗ trợ</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Mã</th>
                                        <th>Tiêu đề</th>
                                        <th>Danh mục</th>
                                        <th>Mức độ</th>
                                        <th>Trạng thái</th>
                                        <th>Phản hồi</th>
                                        <th>Ngày tạo</th>
                                        <th>Cập nhật</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ticket in Model)
                                    {
                                        var statusBadgeClass = ticket.Status switch
                                        {
                                            "Open" => "bg-warning text-dark",
                                            "InProgress" or "In_Progress" => "bg-info text-white",
                                            "Resolved" => "bg-success",
                                            "Closed" => "bg-secondary",
                                            _ => "bg-light text-dark"
                                        };

                                        var categoryBadgeClass = ticket.Category?.ToLower() switch
                                        {
                                            "order" => "bg-primary",
                                            "product" => "bg-success",
                                            "payment" => "bg-danger",
                                            "account" => "bg-info",
                                            "refund" => "bg-warning text-dark",
                                            "technical" => "bg-dark",
                                            "contact" => "bg-secondary",
                                            _ => "bg-light text-dark"
                                        };

                                        var priorityBadgeClass = ticket.Priority?.ToLower() switch
                                        {
                                            "urgent" => "bg-danger",
                                            "high" => "bg-warning text-dark",
                                            "medium" => "bg-info",
                                            _ => "bg-secondary"
                                        };

                                        <tr>
                                            <td>
                                                <strong class="text-primary">@ticket.TicketNumber</strong>
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 250px;" title="@ticket.Subject">
                                                    @ticket.Subject
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge @categoryBadgeClass">
                                                    @(ticket.Category?.ToLower() switch
                                                    {
                                                        "order" => "Đơn hàng",
                                                        "product" => "Sản phẩm",
                                                        "payment" => "Thanh toán",
                                                        "account" => "Tài khoản",
                                                        "refund" => "Hoàn tiền",
                                                        "technical" => "Kỹ thuật",
                                                        "contact" => "Liên hệ",
                                                        _ => "Chung"
                                                    })
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge @priorityBadgeClass">
                                                    @(ticket.Priority?.ToLower() switch
                                                    {
                                                        "urgent" => "Khẩn cấp",
                                                        "high" => "Cao",
                                                        "medium" => "Trung bình",
                                                        _ => "Thấp"
                                                    })
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge @statusBadgeClass">
                                                    @(ticket.Status switch
                                                    {
                                                        "Open" => "Đang chờ",
                                                        "InProgress" or "In_Progress" => "Đang xử lý",
                                                        "Resolved" => "Đã giải quyết",
                                                        "Closed" => "Đã đóng",
                                                        _ => ticket.Status
                                                    })
                                                </span>
                                            </td>
                                            <td>
                                                @if (ticket.ReplyCount > 0)
                                                {
                                                    <span class="badge bg-light text-dark">
                                                        <i class="fas fa-comments me-1"></i>
                                                        @ticket.ReplyCount
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <small class="text-muted">@ticket.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                            </td>
                                            <td>
                                                <small class="text-muted">@ticket.UpdatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Details", new { id = ticket.Id })" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> Xem
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow mb-4">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Chưa có yêu cầu hỗ trợ nào</h5>
                        <p class="text-muted mb-3">Tạo yêu cầu hỗ trợ đầu tiên của bạn!</p>
                        <a href="@Url.Action("Create")" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Tạo yêu cầu mới
                        </a>
                    </div>
                </div>
            }
        </main>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    </script>
}

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df!important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a!important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc!important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e!important;
}

.text-xs {
    font-size: 0.7rem;
}

.shadow {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15)!important;
}
</style>
