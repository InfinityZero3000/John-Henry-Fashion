@model Address
@{
    ViewData["Title"] = "Thêm địa chỉ mới";
}

<div class="container-fluid px-4">
    <div class="row">
        <div class="col-lg-8 col-xl-6 mx-auto">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Thêm địa chỉ mới</h6>
                </div>
                <div class="card-body">
                    <form asp-action="AddAddress" method="post">
                        <input type="hidden" name="returnUrl" value="@(ViewData["ReturnUrl"] as string ?? string.Empty)" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="FirstName" class="form-label required">Họ</label>
                                    <input asp-for="FirstName" class="form-control" placeholder="Nhập họ" />
                                    <span asp-validation-for="FirstName" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="LastName" class="form-label required">Tên</label>
                                    <input asp-for="LastName" class="form-control" placeholder="Nhập tên" />
                                    <span asp-validation-for="LastName" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label asp-for="Company" class="form-label">Công ty (tùy chọn)</label>
                            <input asp-for="Company" class="form-control" placeholder="Nhập tên công ty" />
                            <span asp-validation-for="Company" class="text-danger small"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Address1" class="form-label required">Địa chỉ</label>
                            <input asp-for="Address1" class="form-control" placeholder="Số nhà, tên đường" />
                            <span asp-validation-for="Address1" class="text-danger small"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Address2" class="form-label">Địa chỉ 2 (tùy chọn)</label>
                            <input asp-for="Address2" class="form-control" placeholder="Căn hộ, tầng, tòa nhà" />
                            <span asp-validation-for="Address2" class="text-danger small"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="province" class="form-label required">Tỉnh/Thành phố</label>
                                    <select id="province" class="form-control">
                                        <option value="">-- Chọn tỉnh/thành --</option>
                                    </select>
                                    <span class="text-danger small" id="province-error"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="district" class="form-label required">Quận/Huyện</label>
                                    <select id="district" class="form-control" disabled>
                                        <option value="">-- Chọn quận/huyện --</option>
                                    </select>
                                    <span class="text-danger small" id="district-error"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="ward" class="form-label required">Phường/Xã</label>
                                    <select id="ward" class="form-control" disabled>
                                        <option value="">-- Chọn phường/xã --</option>
                                    </select>
                                    <span class="text-danger small" id="ward-error"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden fields to store the selected values -->
                        <input type="hidden" asp-for="City" id="cityHidden" />
                        <input type="hidden" asp-for="State" id="stateHidden" />
                        <input type="hidden" asp-for="PostalCode" value="" />
                        <input type="hidden" asp-for="Country" value="Vietnam" />

                        <div class="form-group">
                            <label asp-for="Phone" class="form-label">Số điện thoại (tùy chọn)</label>
                            <input asp-for="Phone" class="form-control" placeholder="Nhập số điện thoại" />
                            <span asp-validation-for="Phone" class="text-danger small"></span>
                        </div>

                        <div class="form-group pt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save mr-2"></i>Lưu địa chỉ
                            </button>
                            @{
                                var backUrl = ViewData["ReturnUrl"] as string;
                            }
                            <a href="@(Url.IsLocalUrl(backUrl) ? backUrl : Url.Action("Addresses", "Account"))" class="btn btn-secondary ml-2">
                                <i class="fas fa-times mr-2"></i>Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-label.required::after {
    content: ' *';
    color: #e74a3b;
}
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Load provinces on page load
            loadProvinces();
            
            // Province change event
            $('#province').on('change', function() {
                const provinceCode = $(this).val();
                const provinceName = $(this).find('option:selected').text();
                
                // Update hidden field
                $('#cityHidden').val(provinceName);
                
                // Reset district and ward
                $('#district').empty().append('<option value="">-- Chọn quận/huyện --</option>').prop('disabled', !provinceCode);
                $('#ward').empty().append('<option value="">-- Chọn phường/xã --</option>').prop('disabled', true);
                $('#stateHidden').val('');
                
                if (provinceCode) {
                    loadDistricts(provinceCode);
                }
            });
            
            // District change event
            $('#district').on('change', function() {
                const districtCode = $(this).val();
                const districtName = $(this).find('option:selected').text();
                
                // Reset ward
                $('#ward').empty().append('<option value="">-- Chọn phường/xã --</option>').prop('disabled', !districtCode);
                
                if (districtCode) {
                    loadWards(districtCode);
                }
            });
            
            // Ward change event
            $('#ward').on('change', function() {
                const wardName = $(this).find('option:selected').text();
                const districtName = $('#district option:selected').text();
                
                // Update hidden field with format: District, Ward
                if (wardName && wardName !== '-- Chọn phường/xã --') {
                    $('#stateHidden').val(districtName + ', ' + wardName);
                }
            });
            
            // Form validation before submit
            $('form').on('submit', function(e) {
                let isValid = true;
                
                if (!$('#province').val()) {
                    $('#province-error').text('Vui lòng chọn tỉnh/thành phố');
                    isValid = false;
                } else {
                    $('#province-error').text('');
                }
                
                if (!$('#district').val()) {
                    $('#district-error').text('Vui lòng chọn quận/huyện');
                    isValid = false;
                } else {
                    $('#district-error').text('');
                }
                
                if (!$('#ward').val()) {
                    $('#ward-error').text('Vui lòng chọn phường/xã');
                    isValid = false;
                } else {
                    $('#ward-error').text('');
                }
                
                if (!isValid) {
                    e.preventDefault();
                    return false;
                }
            });
        });
        
        function loadProvinces() {
            $.ajax({
                url: '/api/VietnameseAddress/provinces',
                method: 'GET',
                success: function(data) {
                    console.log('Provinces loaded:', data.length);
                    const select = $('#province');
                    select.empty().append('<option value="">-- Chọn tỉnh/thành --</option>');
                    data.forEach(function(province) {
                        select.append(`<option value="${province.code}">${province.name}</option>`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading provinces:', error);
                    alert('Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại.');
                }
            });
        }
        
        function loadDistricts(provinceCode) {
            $.ajax({
                url: `/api/VietnameseAddress/districts/${provinceCode}`,
                method: 'GET',
                success: function(data) {
                    console.log('Districts loaded:', data.length);
                    const select = $('#district');
                    select.empty().append('<option value="">-- Chọn quận/huyện --</option>');
                    data.forEach(function(district) {
                        select.append(`<option value="${district.code}">${district.name}</option>`);
                    });
                    select.prop('disabled', false);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading districts:', error);
                    alert('Không thể tải danh sách quận/huyện. Vui lòng thử lại.');
                }
            });
        }
        
        function loadWards(districtCode) {
            $.ajax({
                url: `/api/VietnameseAddress/wards/${districtCode}`,
                method: 'GET',
                success: function(data) {
                    console.log('Wards loaded:', data.length);
                    const select = $('#ward');
                    select.empty().append('<option value="">-- Chọn phường/xã --</option>');
                    data.forEach(function(ward) {
                        select.append(`<option value="${ward.code}">${ward.name}</option>`);
                    });
                    select.prop('disabled', false);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading wards:', error);
                    alert('Không thể tải danh sách phường/xã. Vui lòng thử lại.');
                }
            });
        }
    </script>
}
