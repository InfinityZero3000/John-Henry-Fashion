@using JohnHenryFashionWeb.Controllers
@using JohnHenryFashionWeb.Services
@model PerformanceDashboardViewModel
@{
    ViewData["Title"] = "Performance Dashboard";
    ViewData["CurrentSection"] = "AdminPerformance";
    ViewData["Breadcrumb"] = new List<(string Text, string Url)>
    {
        ("Dashboard", "/admin"),
        ("Performance", "")
    };
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .metric-card {
        padding: 1.5rem;
        height: 140px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .metric-card.primary {
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        color: white;
    }

    .metric-card.success {
        background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
        color: white;
    }

    .metric-card.warning {
        background: linear-gradient(135deg, #ca8a04 0%, #eab308 100%);
        color: white;
    }

    .metric-card.info {
        background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
        color: white;
    }

    .health-indicator {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
    }

    .health-healthy { background: #16a34a; color: white; }
    .health-warning { background: #ca8a04; color: white; }
    .health-critical { background: #dc2626; color: white; }

    .stat-item h4 { margin-bottom: 0.5rem; font-weight: 700; }
    .stat-item p { margin: 0; color: #6b7280; }
</style>

<div class="admin-content">
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <div>
                <h1>Performance Dashboard</h1>
                <p>Theo dõi hiệu suất và tình trạng hệ thống</p>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <button type="button" class="admin-btn admin-btn-primary" id="refreshBtn">
                    <i data-lucide="refresh-cw"></i>
                    Refresh
                </button>
                <button type="button" class="admin-btn admin-btn-danger" id="clearCacheBtn">
                    <i data-lucide="trash-2"></i>
                    Clear Cache
                </button>
            </div>
        </div>
    </div>

    <!-- System Health Status -->
    <div class="admin-card" style="margin-top: 1.5rem;">
        <h3 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="activity" style="width: 20px; height: 20px;"></i>
            System Health Status
        </h3>
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 1.5rem;">
            <div style="text-align: center;">
                <div class="health-indicator health-@Model.SystemHealth.OverallStatus.ToString().ToLower()">
                    <i data-lucide="circle" style="width: 24px; height: 24px;"></i>
                </div>
                <h6 style="font-weight: 600; margin-bottom: 0.5rem;">Overall</h6>
                <span class="admin-badge" style="background-color: #d1fae5; color: #065f46;">
                    @Model.SystemHealth.OverallStatus
                </span>
            </div>
            <div style="text-align: center;">
                <div class="health-indicator health-@Model.SystemHealth.MemoryStatus.ToString().ToLower()">
                    <i data-lucide="hard-drive" style="width: 24px; height: 24px;"></i>
                </div>
                <h6 style="font-weight: 600; margin-bottom: 0.5rem;">Memory</h6>
                <span class="admin-badge" style="background-color: #dbeafe; color: #1e40af;">
                    @Model.SystemHealth.MemoryStatus
                </span>
            </div>
            <div style="text-align: center;">
                <div class="health-indicator health-@Model.SystemHealth.CpuStatus.ToString().ToLower()">
                    <i data-lucide="cpu" style="width: 24px; height: 24px;"></i>
                </div>
                <h6 style="font-weight: 600; margin-bottom: 0.5rem;">CPU</h6>
                <span class="admin-badge" style="background-color: #d1fae5; color: #065f46;">
                    @Model.SystemHealth.CpuStatus
                </span>
            </div>
            <div style="text-align: center;">
                <div class="health-indicator health-@Model.SystemHealth.DatabaseStatus.ToString().ToLower()">
                    <i data-lucide="database" style="width: 24px; height: 24px;"></i>
                </div>
                <h6 style="font-weight: 600; margin-bottom: 0.5rem;">Database</h6>
                <span class="admin-badge" style="background-color: #fef3c7; color: #92400e;">
                    @Model.SystemHealth.DatabaseStatus
                </span>
            </div>
            <div style="text-align: center;">
                <div class="health-indicator health-@Model.SystemHealth.CacheStatus.ToString().ToLower()">
                    <i data-lucide="layers" style="width: 24px; height: 24px;"></i>
                </div>
                <h6 style="font-weight: 600; margin-bottom: 0.5rem;">Cache</h6>
                <span class="admin-badge" style="background-color: #d1fae5; color: #065f46;">
                    @Model.SystemHealth.CacheStatus
                </span>
            </div>
            <div style="text-align: center;">
                <div class="health-indicator health-@Model.SystemHealth.ResponseTimeStatus.ToString().ToLower()">
                    <i data-lucide="clock" style="width: 24px; height: 24px;"></i>
                </div>
                <h6 style="font-weight: 600; margin-bottom: 0.5rem;">Response</h6>
                <span class="admin-badge" style="background-color: #dbeafe; color: #1e40af;">
                    @Model.SystemHealth.ResponseTimeStatus
                </span>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-top: 1.5rem;">
        <div class="metric-card primary">
            <div>
                <h3 style="margin-bottom: 0.5rem;">@Model.CurrentMetrics.MemoryUsageMB MB</h3>
                <p style="margin: 0; opacity: 0.85;">Memory Usage</p>
            </div>
            <i data-lucide="hard-drive" style="width: 48px; height: 48px; opacity: 0.75;"></i>
        </div>
        <div class="metric-card success">
            <div>
                <h3 style="margin-bottom: 0.5rem;">@Model.CurrentMetrics.CpuUsagePercent.ToString("F1")%</h3>
                <p style="margin: 0; opacity: 0.85;">CPU Usage</p>
            </div>
            <i data-lucide="cpu" style="width: 48px; height: 48px; opacity: 0.75;"></i>
        </div>
        <div class="metric-card warning">
            <div>
                <h3 style="margin-bottom: 0.5rem;">@Model.CurrentMetrics.RequestsPerSecond.ToString("F1")</h3>
                <p style="margin: 0; opacity: 0.85;">Requests/sec</p>
            </div>
            <i data-lucide="trending-up" style="width: 48px; height: 48px; opacity: 0.75;"></i>
        </div>
        <div class="metric-card info">
            <div>
                <h3 style="margin-bottom: 0.5rem;">@Model.CurrentMetrics.AverageResponseTime.TotalMilliseconds.ToString("F0")ms</h3>
                <p style="margin: 0; opacity: 0.85;">Avg Response</p>
            </div>
            <i data-lucide="clock" style="width: 48px; height: 48px; opacity: 0.75;"></i>
        </div>
    </div>

    <!-- Charts Row -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 1.5rem;">
        <div class="admin-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="bar-chart-2" style="width: 20px; height: 20px;"></i>
                Memory Usage (24h)
            </h3>
            <canvas id="memoryChart" height="200"></canvas>
        </div>
        <div class="admin-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="trending-up" style="width: 20px; height: 20px;"></i>
                Response Time (24h)
            </h3>
            <canvas id="responseChart" height="200"></canvas>
        </div>
    </div>

    <!-- Cache Management & Statistics -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 1.5rem;">
        <div class="admin-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="layers" style="width: 20px; height: 20px;"></i>
                Cache Management
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="stat-item">
                    <h4>@Model.CacheEntryCount</h4>
                    <p>Cache Entries</p>
                </div>
                <div class="stat-item">
                    <h4>@Model.CurrentMetrics.CacheHitRate.ToString("P1")</h4>
                    <p>Hit Rate</p>
                </div>
            </div>
            <div class="admin-form-group">
                <input type="text" class="admin-form-control" id="cachePattern" placeholder="Enter cache pattern (e.g., product_*)">
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <button type="button" class="admin-btn admin-btn-warning" id="clearPatternBtn">
                    <i data-lucide="trash-2"></i>
                    Clear Pattern
                </button>
                <button type="button" class="admin-btn admin-btn-primary" id="viewCacheKeysBtn">
                    <i data-lucide="eye"></i>
                    View Cache Keys
                </button>
            </div>
        </div>
        <div class="admin-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="pie-chart" style="width: 20px; height: 20px;"></i>
                Site Statistics
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                <div class="stat-item">
                    <h4>@Model.SiteStatistics.TotalProducts</h4>
                    <p>Products</p>
                </div>
                <div class="stat-item">
                    <h4>@Model.SiteStatistics.TotalUsers</h4>
                    <p>Users</p>
                </div>
                <div class="stat-item">
                    <h4>@Model.SiteStatistics.TotalOrders</h4>
                    <p>Orders</p>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="stat-item">
                    <h4>@Model.SiteStatistics.TotalRevenue.ToString("C0")</h4>
                    <p>Revenue</p>
                </div>
                <div class="stat-item">
                    <h4>@Model.SiteStatistics.AverageOrderValue.ToString("C0")</h4>
                    <p>Avg Order</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="admin-card" style="margin-top: 1.5rem;">
        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="settings" style="width: 20px; height: 20px;"></i>
            Quick Actions
        </h3>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <a href="/admin/performance/database-report" class="admin-btn admin-btn-primary">
                <i data-lucide="database"></i>
                Database Report
            </a>
            <a href="/admin/performance/page-report" class="admin-btn admin-btn-primary">
                <i data-lucide="file-text"></i>
                Page Performance
            </a>
            <button type="button" class="admin-btn admin-btn-success" id="optimizeBtn">
                <i data-lucide="zap"></i>
                Optimize System
            </button>
            <button type="button" class="admin-btn admin-btn-warning" id="generateReportBtn">
                <i data-lucide="download"></i>
                Export Report
            </button>
        </div>
    </div>
</div>

<!-- Cache Keys Modal -->
<div class="modal fade" id="cacheKeysModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cache Keys</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Cache Key</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cacheKeysTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetHealthBadgeClass(HealthStatus status)
    {
        return status switch
        {
            HealthStatus.Healthy => "success",
            HealthStatus.Warning => "warning",
            HealthStatus.Critical => "danger",
            _ => "secondary"
        };
    }
}

<style>
    .health-indicator {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .health-healthy { color: #28a745; }
    .health-warning { color: #ffc107; }
    .health-critical { color: #dc3545; }
    
    .stat-item {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .stat-item h4 {
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Performance Dashboard JavaScript
        let memoryChart, responseChart;
        
        $(document).ready(function() {
            initializeCharts();
            bindEvents();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });
        
        function initializeCharts() {
            // Memory Chart
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory Usage (MB)',
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Response Time Chart
            const responseCtx = document.getElementById('responseChart').getContext('2d');
            responseChart = new Chart(responseCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Load initial chart data
            loadChartData();
        }
        
        function loadChartData() {
            // Load memory data
            $.get('/admin/performance/api/performance-chart-data?type=memory')
                .done(function(data) {
                    memoryChart.data.labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                    memoryChart.data.datasets[0].data = data.map(d => d.value);
                    memoryChart.update();
                });
                
            // Load response time data
            $.get('/admin/performance/api/performance-chart-data?type=response_time')
                .done(function(data) {
                    responseChart.data.labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                    responseChart.data.datasets[0].data = data.map(d => d.value);
                    responseChart.update();
                });
        }
        
        function bindEvents() {
            $('#refreshBtn').click(function() {
                location.reload();
            });
            
            $('#clearCacheBtn').click(function() {
                if (confirm('Are you sure you want to clear all cache?')) {
                    $.post('/admin/performance/clear-cache')
                        .done(function(response) {
                            if (response.success) {
                                toastr.success(response.message);
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                toastr.error(response.message);
                            }
                        })
                        .fail(function() {
                            toastr.error('Failed to clear cache');
                        });
                }
            });
            
            $('#clearPatternBtn').click(function() {
                const pattern = $('#cachePattern').val();
                if (!pattern) {
                    toastr.warning('Please enter a cache pattern');
                    return;
                }
                
                if (confirm(`Clear all cache keys matching pattern: ${pattern}?`)) {
                    $.post('/admin/performance/clear-cache-pattern', { pattern })
                        .done(function(response) {
                            if (response.success) {
                                toastr.success(response.message);
                                $('#cachePattern').val('');
                            } else {
                                toastr.error(response.message);
                            }
                        })
                        .fail(function() {
                            toastr.error('Failed to clear cache pattern');
                        });
                }
            });
            
            $('#viewCacheKeysBtn').click(function() {
                loadCacheKeys();
            });
        }
        
        function loadCacheKeys() {
            $.get('/admin/performance/cache-keys')
                .done(function(keys) {
                    const tbody = $('#cacheKeysTable');
                    tbody.empty();
                    
                    keys.forEach(key => {
                        tbody.append(`
                            <tr>
                                <td><code>${key}</code></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearSingleKey('${key}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                    
                    $('#cacheKeysModal').modal('show');
                })
                .fail(function() {
                    toastr.error('Failed to load cache keys');
                });
        }
        
        function clearSingleKey(key) {
            if (confirm(`Clear cache key: ${key}?`)) {
                $.post('/admin/performance/clear-cache-pattern', { pattern: key })
                    .done(function(response) {
                        if (response.success) {
                            toastr.success(`Cleared: ${key}`);
                            loadCacheKeys(); // Refresh the list
                        } else {
                            toastr.error(response.message);
                        }
                    });
            }
        }
        
        function refreshData() {
            // Refresh metrics without full page reload
            $.get('/admin/performance/metrics')
                .done(function(metrics) {
                    // Update metric displays
                    // This would update the metric cards
                })
                .fail(function() {
                    console.error('Failed to refresh metrics');
                });
        }
    </script>
}
