@model List<JohnHenryFashionWeb.Models.SellerSettlement>
@{
    ViewData["Title"] = "Thanh toán cho Seller";
    ViewData["CurrentSection"] = "PaymentManagement";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = "<li class=\"breadcrumb-item\"><a href=\"/admin/payments\">Quản lý thanh toán</a></li><li class=\"breadcrumb-item active\">Thanh toán Seller</li>";
    
    var statusFilter = ViewBag.StatusFilter as string;
    var fromDate = ViewBag.FromDate as DateTime?;
    var toDate = ViewBag.ToDate as DateTime?;
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="wallet"></i>
                    Thanh toán cho Seller
                </h1>
                <p style="color: #6b7280; margin-top: 0.5rem;">Quản lý các khoản thanh toán định kỳ cho Seller</p>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    <!-- Filters -->
    <div class="admin-card admin-mb-lg">
        <div class="admin-card-header">
            <h3>Lọc thanh toán</h3>
        </div>
        <div class="admin-card-body">
            <form method="get" asp-action="Settlements" class="admin-flex admin-gap-sm" style="flex-wrap: wrap;">
                <div class="admin-form-group" style="margin: 0; flex: 1; min-width: 200px;">
                    <label class="admin-form-label">Trạng thái</label>
                    <select name="status" class="admin-form-control">
                        <option value="">Tất cả</option>
                        <option value="Pending" selected="@(statusFilter == "Pending")">Chờ thanh toán</option>
                        <option value="Completed" selected="@(statusFilter == "Completed")">Đã thanh toán</option>
                    </select>
                </div>
                <div class="admin-form-group" style="margin: 0; flex: 1; min-width: 200px;">
                    <label class="admin-form-label">Từ ngày</label>
                    <input type="date" name="fromDate" class="admin-form-control" value="@fromDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="admin-form-group" style="margin: 0; flex: 1; min-width: 200px;">
                    <label class="admin-form-label">Đến ngày</label>
                    <input type="date" name="toDate" class="admin-form-control" value="@toDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="submit" class="admin-btn admin-btn-primary">
                        <i data-lucide="search"></i>
                        Lọc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settlements Table -->
    <div class="admin-card">
        <div class="admin-card-header admin-flex-between">
            <h3>Danh sách thanh toán</h3>
            @if (Model.Any())
            {
                <span class="admin-badge admin-badge-primary">@Model.Count thanh toán</span>
            }
        </div>
        <div class="admin-card-body" style="padding: 0;">
            <div class="admin-table-container">
                <table class="admin-table">
                <thead>
                    <tr>
                        <th>Mã TT</th>
                        <th>Seller</th>
                        <th>Kỳ Thanh Toán</th>
                        <th>Tổng Doanh Thu</th>
                        <th>Phí Nền Tảng</th>
                        <th>Số Tiền Thanh Toán</th>
                        <th>Trạng Thái</th>
                        <th>Người Xử Lý</th>
                        <th>Thao Tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        foreach (var settlement in Model)
                        {
                            <tr>
                                <td>
                                    <strong>@settlement.SettlementNumber</strong>
                                </td>
                                <td>
                                    @if (settlement.Seller != null)
                                    {
                                        <div>
                                            <strong>@settlement.Seller.Email</strong>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                                <td>
                                    <div class="small">
                                        <div>Từ: @settlement.PeriodStart.ToString("dd/MM/yyyy")</div>
                                        <div>Đến: @settlement.PeriodEnd.ToString("dd/MM/yyyy")</div>
                                    </div>
                                </td>
                                <td><strong>@settlement.TotalRevenue.ToString("N0") ₫</strong></td>
                                <td class="text-danger">@settlement.PlatformFee.ToString("N0") ₫</td>
                                <td class="text-success fw-bold">@settlement.NetAmount.ToString("N0") ₫</td>
                                <td>
                                    @if (settlement.Status == "Completed")
                                    {
                                        <span class="admin-badge admin-badge-success">
                                            <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                            Đã thanh toán
                                        </span>
                                        @if (settlement.SettledAt.HasValue)
                                        {
                                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                                @settlement.SettledAt.Value.ToString("dd/MM/yyyy HH:mm")
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="admin-badge admin-badge-warning">
                                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                                            Chờ thanh toán
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(settlement.SettledBy))
                                    {
                                        <span class="badge bg-info">@settlement.SettledBy</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="actions">
                                    <a asp-action="SettlementDetails" asp-route-id="@settlement.Id" class="admin-btn admin-btn-sm admin-btn-primary">
                                        <i data-lucide="eye"></i>
                                        Chi tiết
                                    </a>
                                    @if (settlement.Status != "Completed")
                                    {
                                        <button type="button" class="admin-btn admin-btn-sm admin-btn-success" data-bs-toggle="modal" data-bs-target="#processModal" 
                                                data-id="@settlement.Id" data-number="@settlement.SettlementNumber" data-amount="@settlement.NetAmount.ToString("N0")">
                                            <i data-lucide="check"></i>
                                            Xử lý
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" style="padding: 4rem 2rem; text-align: center; color: #9ca3af;">
                                <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; color: #d1d5db;"></i>
                                <p style="font-size: 1rem; margin: 0;">Không có khoản thanh toán nào</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- Process Settlement Modal -->
<div class="admin-modal" id="processModal" style="display: none;">
    <div class="admin-modal-backdrop" onclick="closeProcessModal()"></div>
    <div class="admin-modal-content" style="max-width: 500px;">
        <div class="admin-modal-header">
            <h3>Xác nhận Thanh toán</h3>
            <button type="button" class="admin-modal-close" onclick="closeProcessModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form id="processForm" method="post" asp-action="ProcessSettlement">
            <div class="admin-modal-body">
                <input type="hidden" id="settlementId" name="id" />
                <div class="admin-alert admin-alert-info" style="margin-bottom: 1.25rem;">
                    <i data-lucide="info"></i>
                    <span>Bạn có chắc chắn muốn xử lý thanh toán cho đợt <strong id="settlementNumber"></strong>?</span>
                </div>
                <div style="text-align: center; margin: 1.5rem 0;">
                    <p style="color: #6b7280; margin-bottom: 0.5rem; font-size: 0.875rem;">Số tiền thanh toán:</p>
                    <h3 style="color: #10b981; font-size: 2rem; font-weight: 700; margin: 0;" id="settlementAmount"></h3>
                </div>
                <div class="admin-alert admin-alert-warning">
                    <i data-lucide="alert-triangle"></i>
                    <span>Hành động này sẽ đánh dấu khoản thanh toán đã hoàn tất và không thể hoàn tác.</span>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button type="button" class="admin-btn admin-btn-secondary" onclick="closeProcessModal()">
                    <i data-lucide="x"></i>
                    Hủy
                </button>
                <button type="submit" class="admin-btn admin-btn-success">
                    <i data-lucide="check"></i>
                    Xác nhận Thanh toán
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Handle process modal with Bootstrap
        const processModal = document.getElementById('processModal');
        
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const id = this.dataset.id;
                const number = this.dataset.number;
                const amount = this.dataset.amount;
                
                document.getElementById('settlementId').value = id;
                document.getElementById('settlementNumber').textContent = number;
                document.getElementById('settlementAmount').textContent = amount + ' ₫';
                
                processModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Initialize Lucide icons in modal
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 10);
            });
        });
        
        function closeProcessModal() {
            processModal.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // Close modal on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProcessModal();
            }
        });
    </script>
}
