@model JohnHenryFashionWeb.ViewModels.ProductCreateEditViewModel
@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Header -->
    <div class="admin-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 class="admin-page-title">
                <i data-lucide="edit"></i>
                Chỉnh sửa sản phẩm
            </h1>
            <p style="color: var(--admin-text-light); margin-top: 0.5rem;">
                <a href="@Url.Action("Dashboard", "Seller")" style="color: var(--admin-text-light); text-decoration: none;">Dashboard</a>
                <span style="margin: 0 0.5rem;">/</span>
                <a href="@Url.Action("Products", "Seller")" style="color: var(--admin-text-light); text-decoration: none;">Sản phẩm</a>
                <span style="margin: 0 0.5rem;">/</span>
                Chỉnh sửa
            </p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <a href="@Url.Action("Products", "Seller")" class="admin-btn admin-btn-secondary">
                <i data-lucide="arrow-left"></i>
                Quay lại
            </a>
            <a href="@Url.Action("Details", "Products", new { id = Model.Id })" class="admin-btn admin-btn-info" target="_blank">
                <i data-lucide="external-link"></i>
                Xem trên web
            </a>
        </div>
    </div>

    <!-- Status Alert -->
    @if (!string.IsNullOrEmpty(ViewBag.Message))
    {
        <div style="background: var(--admin-success-light); border-left: 4px solid var(--admin-success); padding: 1rem; margin-bottom: var(--spacing-lg); border-radius: 4px; position: relative;">
            @ViewBag.Message
            <button type="button" onclick="this.parentElement.remove()" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--admin-success);">×</button>
        </div>
    }

    <form asp-action="EditProduct" method="post" enctype="multipart/form-data" id="productForm">
        <input asp-for="Id" type="hidden" />
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-lg);">
            <!-- Main Content -->
            <div>
                <!-- Basic Information -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="info" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Thông tin cơ bản
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="Name" class="admin-form-label">Tên sản phẩm <span style="color: var(--admin-danger);">*</span></label>
                            <input asp-for="Name" class="admin-form-input" placeholder="Nhập tên sản phẩm...">
                            <span asp-validation-for="Name" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label asp-for="SKU" class="admin-form-label">SKU <span style="color: var(--admin-danger);">*</span></label>
                                <input asp-for="SKU" class="admin-form-input" placeholder="Mã sản phẩm...">
                                <span asp-validation-for="SKU" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                            </div>
                            <div>
                                <label asp-for="Status" class="admin-form-label">Trạng thái</label>
                                <select asp-for="Status" class="admin-form-select">
                                    <option value="active">Đang bán</option>
                                    <option value="inactive">Tạm dừng</option>
                                    <option value="out_of_stock">Hết hàng</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="ShortDescription" class="admin-form-label">Mô tả ngắn</label>
                            <textarea asp-for="ShortDescription" class="admin-form-input" rows="3" placeholder="Mô tả ngắn gọn về sản phẩm..."></textarea>
                            <span asp-validation-for="ShortDescription" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label asp-for="Description" class="admin-form-label">Mô tả chi tiết</label>
                            <textarea asp-for="Description" class="admin-form-input" rows="8" id="descriptionEditor"></textarea>
                            <span asp-validation-for="Description" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="dollar-sign" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Giá bán
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <label asp-for="Price" class="admin-form-label">Giá gốc <span style="color: var(--admin-danger);">*</span></label>
                                <div style="display: flex;">
                                    <input asp-for="Price" class="admin-form-input" type="number" step="1000" min="0" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    <span style="display: flex; align-items: center; padding: 0 1rem; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-left: none; border-top-right-radius: 8px; border-bottom-right-radius: 8px;">VNĐ</span>
                                </div>
                                <span asp-validation-for="Price" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                            </div>
                            <div>
                                <label asp-for="SalePrice" class="admin-form-label">Giá khuyến mãi</label>
                                <div style="display: flex;">
                                    <input asp-for="SalePrice" class="admin-form-input" type="number" step="1000" min="0" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    <span style="display: flex; align-items: center; padding: 0 1rem; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-left: none; border-top-right-radius: 8px; border-bottom-right-radius: 8px;">VNĐ</span>
                                </div>
                                <small style="color: var(--admin-text-muted); font-size: 0.875rem;">Để trống nếu không có khuyến mãi</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Attributes -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="tag" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Thuộc tính sản phẩm
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label asp-for="Size" class="admin-form-label">Kích thước</label>
                                <input asp-for="Size" type="hidden" id="sizeInput">
                                <div id="sizeButtons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    <button type="button" class="size-btn" data-size="XS">XS</button>
                                    <button type="button" class="size-btn" data-size="S">S</button>
                                    <button type="button" class="size-btn" data-size="M">M</button>
                                    <button type="button" class="size-btn" data-size="L">L</button>
                                    <button type="button" class="size-btn" data-size="XL">XL</button>
                                    <button type="button" class="size-btn" data-size="XXL">XXL</button>
                                </div>
                                <small style="color: var(--admin-text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">Chọn nhiều kích thước</small>
                            </div>
                            <div>
                                <label asp-for="Color" class="admin-form-label">Màu sắc</label>
                                <input asp-for="Color" type="hidden" id="colorInput">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="colorPicker" class="admin-form-input" style="width: 60px; height: 40px; padding: 2px; cursor: pointer;">
                                    <div id="selectedColors" style="display: flex; flex-wrap: wrap; gap: 0.5rem; flex: 1;"></div>
                                </div>
                                <small style="color: var(--admin-text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">Chọn màu từ bảng màu</small>
                            </div>
                            <div>
                                <label asp-for="Material" class="admin-form-label">Chất liệu</label>
                                <input asp-for="Material" class="admin-form-input" placeholder="Cotton, Polyester...">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <label asp-for="Weight" class="admin-form-label">Trọng lượng</label>
                                <div style="display: flex;">
                                    <input asp-for="Weight" class="admin-form-input" type="number" step="0.1" min="0" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    <span style="display: flex; align-items: center; padding: 0 1rem; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-left: none; border-top-right-radius: 8px; border-bottom-right-radius: 8px;">kg</span>
                                </div>
                            </div>
                            <div>
                                <label asp-for="Dimensions" class="admin-form-label">Kích thước (DxRxC)</label>
                                <input asp-for="Dimensions" class="admin-form-input" placeholder="30x40x5 cm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEO -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="search" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            SEO & Marketing
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="MetaTitle" class="admin-form-label">Meta Title</label>
                            <input asp-for="MetaTitle" class="admin-form-input" placeholder="Tiêu đề SEO...">
                            <small style="color: var(--admin-text-muted); font-size: 0.875rem;">Để trống để sử dụng tên sản phẩm</small>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="MetaDescription" class="admin-form-label">Meta Description</label>
                            <textarea asp-for="MetaDescription" class="admin-form-input" rows="2" placeholder="Mô tả cho search engine..."></textarea>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label asp-for="Tags" class="admin-form-label">Tags</label>
                            <input asp-for="Tags" class="admin-form-input" placeholder="tag1, tag2, tag3...">
                            <small style="color: var(--admin-text-muted); font-size: 0.875rem;">Các từ khóa phân cách bằng dấu phẩy</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Product Status -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="bar-chart-2" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Trạng thái sản phẩm
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: center;">
                            <div style="padding: 1rem; background: var(--admin-bg-secondary); border-radius: 8px;">
                                <i data-lucide="tag" style="width: 24px; height: 24px; color: var(--admin-primary); margin-bottom: 0.5rem;"></i>
                                <div style="font-size: 0.875rem; color: var(--admin-text-muted); margin-bottom: 0.25rem;">SKU</div>
                                <div style="font-weight: 600;">@Model.SKU</div>
                            </div>
                            <div style="padding: 1rem; background: var(--admin-bg-secondary); border-radius: 8px;">
                                <i data-lucide="package" style="width: 24px; height: 24px; color: var(--admin-info); margin-bottom: 0.5rem;"></i>
                                <div style="font-size: 0.875rem; color: var(--admin-text-muted); margin-bottom: 0.25rem;">Tồn kho</div>
                                <div style="font-weight: 600;">@Model.StockQuantity</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category & Brand -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="layers" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Phân loại
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="CategoryId" class="admin-form-label">Danh mục <span style="color: var(--admin-danger);">*</span></label>
                            <select asp-for="CategoryId" class="admin-form-select" asp-items="@ViewBag.Categories">
                                <option value="">-- Chọn danh mục --</option>
                            </select>
                            <span asp-validation-for="CategoryId" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label asp-for="BrandId" class="admin-form-label">Thương hiệu</label>
                            <select asp-for="BrandId" class="admin-form-select" asp-items="@ViewBag.Brands">
                                <option value="">-- Chọn thương hiệu --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Inventory -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="package" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Tồn kho
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="StockQuantity" class="admin-form-label">Số lượng tồn kho <span style="color: var(--admin-danger);">*</span></label>
                            <input asp-for="StockQuantity" class="admin-form-input" type="number" min="0">
                            <span asp-validation-for="StockQuantity" style="color: var(--admin-danger); font-size: 0.875rem;"></span>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label class="admin-form-check">
                                <input asp-for="ManageStock" class="admin-form-check-input" type="checkbox">
                                <span class="admin-form-check-label">Quản lý tồn kho</span>
                            </label>
                            <small style="color: var(--admin-text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">Tự động cập nhật khi có đơn hàng</small>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label class="admin-form-check">
                                <input asp-for="InStock" class="admin-form-check-input" type="checkbox">
                                <span class="admin-form-check-label">Còn hàng</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Featured Image & Gallery -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="image" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Hình ảnh sản phẩm
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <!-- Featured Image -->
                        <div style="margin-bottom: 1.5rem;">
                            <label class="admin-form-label" style="font-weight: 600;">Ảnh chính</label>
                            @if (!string.IsNullOrEmpty(Model.FeaturedImageUrl))
                            {
                                <div style="margin-bottom: 1rem;">
                                    <img src="@Model.FeaturedImageUrl" style="max-height: 200px; max-width: 100%; border-radius: 8px; border: 1px solid var(--admin-border);" alt="Current Featured Image">
                                    <div style="font-size: 0.875rem; color: var(--admin-text-muted); margin-top: 0.5rem;">Ảnh chính hiện tại</div>
                                </div>
                            }

                            <input type="file" name="FeaturedImage" class="admin-form-input" accept="image/*" id="featuredImageInput">
                            <small style="color: var(--admin-text-muted); font-size: 0.875rem;">Kích thước khuyến nghị: 800x800px (JPG, PNG, WebP)</small>
                            
                            <div id="featuredImagePreview" style="margin-top: 1rem; display: none;">
                                <img id="featuredPreviewImg" src="" style="max-height: 200px; max-width: 100%; border-radius: 8px; border: 1px solid var(--admin-border);">
                                <button type="button" class="admin-btn admin-btn-danger" style="margin-top: 0.5rem;" onclick="removeFeaturedImage()">
                                    <i data-lucide="trash" style="width: 16px; height: 16px;"></i> Xóa ảnh mới
                                </button>
                            </div>
                        </div>

                        <!-- Gallery Images -->
                        <hr style="border-color: var(--admin-border); margin: 1.5rem 0;">
                        <div style="margin-bottom: 0;">
                            <label class="admin-form-label" style="font-weight: 600;">Thư viện ảnh</label>
                            
                            <!-- Existing Gallery Images -->
                            @if (Model.ExistingGalleryImages != null && Model.ExistingGalleryImages.Length > 0)
                            {
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;" id="existingGallery">
                                    @for (int i = 0; i < Model.ExistingGalleryImages.Length; i++)
                                    {
                                        <div class="gallery-item" style="position: relative;">
                                            <img src="@Model.ExistingGalleryImages[i]" style="height: 120px; width: 100%; object-fit: cover; border-radius: 8px; border: 1px solid var(--admin-border);">
                                            <button type="button" class="admin-btn admin-btn-danger" style="position: absolute; top: 0.25rem; right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" 
                                                    onclick="removeExistingImage(@i, '@Model.ExistingGalleryImages[i]')">
                                                <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Add New Gallery Images -->
                            <input type="file" name="GalleryImages" class="admin-form-input" accept="image/*" multiple id="galleryImagesInput">
                            <small style="color: var(--admin-text-muted); font-size: 0.875rem;">Có thể chọn nhiều ảnh cùng lúc. Tối đa 10 ảnh.</small>
                            
                            <!-- Preview New Gallery Images -->
                            <div id="galleryImagesPreviews" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="settings" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            Cài đặt
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div style="margin-bottom: 1.5rem;">
                            <label class="admin-form-check">
                                <input asp-for="IsFeatured" class="admin-form-check-input" type="checkbox">
                                <span class="admin-form-check-label">Sản phẩm nổi bật</span>
                            </label>
                            <small style="color: var(--admin-text-muted); font-size: 0.875rem; display: block; margin-top: 0.5rem;">Hiển thị ở vị trí ưu tiên</small>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label class="admin-form-check">
                                <input asp-for="IsActive" class="admin-form-check-input" type="checkbox">
                                <span class="admin-form-check-label">Kích hoạt</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="admin-card">
                    <div class="admin-card-body">
                        <div style="display: grid; gap: 0.75rem;">
                            <button type="submit" class="admin-btn admin-btn-success" style="width: 100%;">
                                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Cập nhật sản phẩm
                            </button>
                            <button type="button" class="admin-btn admin-btn-danger" style="width: 100%; background: transparent; border: 1px solid var(--admin-danger); color: var(--admin-danger);" onclick="confirmDelete()">
                                <i data-lucide="trash" style="width: 16px; height: 16px;"></i> Xóa sản phẩm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Delete Form -->
    <form id="deleteForm" asp-action="DeleteProduct" method="post" style="display: none;">
        <input asp-for="Id" type="hidden" />
    </form>
</div>

@section Scripts {
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Size Buttons */
        .size-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--admin-border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--admin-text);
        }

        .size-btn:hover {
            border-color: var(--admin-primary);
            color: var(--admin-primary);
            transform: translateY(-2px);
        }

        .size-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            border-color: #dc3545;
            color: white;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        /* Color Tags */
        .color-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--admin-bg-secondary);
            border: 1px solid var(--admin-border);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px var(--admin-border);
        }

        .color-remove {
            background: none;
            border: none;
            color: var(--admin-text-muted);
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .color-remove:hover {
            background: var(--admin-danger);
            color: white;
        }
    </style>
    
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ========== SIZE SELECTION ==========
        const sizeButtons = document.querySelectorAll('.size-btn');
        const sizeInput = document.getElementById('sizeInput');
        const selectedSizes = new Set();

        // Parse existing sizes from model
        const existingSizes = sizeInput.value.split(',').map(s => s.trim()).filter(s => s);
        existingSizes.forEach(size => {
            selectedSizes.add(size);
            const btn = document.querySelector(`.size-btn[data-size="${size}"]`);
            if (btn) btn.classList.add('active');
        });

        sizeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const size = this.getAttribute('data-size');
                
                if (selectedSizes.has(size)) {
                    selectedSizes.delete(size);
                    this.classList.remove('active');
                } else {
                    selectedSizes.add(size);
                    this.classList.add('active');
                }
                
                sizeInput.value = Array.from(selectedSizes).join(', ');
            });
        });

        // ========== COLOR SELECTION ==========
        const colorPicker = document.getElementById('colorPicker');
        const colorInput = document.getElementById('colorInput');
        const selectedColorsDiv = document.getElementById('selectedColors');
        const colorMap = {
            '#000000': 'Đen', '#FFFFFF': 'Trắng', '#FF0000': 'Đỏ',
            '#0000FF': 'Xanh dương', '#00FF00': 'Xanh lá', '#FFFF00': 'Vàng',
            '#FFA500': 'Cam', '#800080': 'Tím', '#FFC0CB': 'Hồng',
            '#A52A2A': 'Nâu', '#808080': 'Xám', '#00FFFF': 'Xanh ngọc',
            '#FFD700': 'Vàng kim', '#C0C0C0': 'Bạc'
        };
        const selectedColors = new Map();

        // Parse existing colors
        const existingColors = colorInput.value.split(',').map(c => c.trim()).filter(c => c);
        existingColors.forEach(colorName => {
            const colorHex = Object.keys(colorMap).find(key => colorMap[key] === colorName) || '#808080';
            selectedColors.set(colorHex, colorName);
        });
        renderSelectedColors();

        function getColorName(hexColor) {
            if (colorMap[hexColor.toUpperCase()]) {
                return colorMap[hexColor.toUpperCase()];
            }
            const rgb = hexToRgb(hexColor);
            let closestColor = hexColor;
            let minDistance = Infinity;
            for (const [hex, name] of Object.entries(colorMap)) {
                const colorRgb = hexToRgb(hex);
                const distance = Math.sqrt(
                    Math.pow(rgb.r - colorRgb.r, 2) +
                    Math.pow(rgb.g - colorRgb.g, 2) +
                    Math.pow(rgb.b - colorRgb.b, 2)
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    closestColor = name;
                }
            }
            return minDistance < 100 ? closestColor : 'Màu tùy chỉnh';
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        colorPicker.addEventListener('change', function() {
            const color = this.value;
            const colorName = getColorName(color);
            if (!selectedColors.has(color)) {
                selectedColors.set(color, colorName);
                renderSelectedColors();
                updateColorInput();
            }
        });

        function renderSelectedColors() {
            selectedColorsDiv.innerHTML = '';
            selectedColors.forEach((name, color) => {
                const colorTag = document.createElement('div');
                colorTag.className = 'color-tag';
                colorTag.innerHTML = `
                    <span class="color-preview" style="background-color: ${color};"></span>
                    <span>${name}</span>
                    <button type="button" class="color-remove" onclick="removeColor('${color}')">×</button>
                `;
                selectedColorsDiv.appendChild(colorTag);
            });
        }

        function removeColor(color) {
            selectedColors.delete(color);
            renderSelectedColors();
            updateColorInput();
        }

        function updateColorInput() {
            colorInput.value = Array.from(selectedColors.values()).join(', ');
        }

        window.removeColor = removeColor;

        // Initialize TinyMCE
        tinymce.init({
            selector: '#descriptionEditor',
            height: 300,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap',
                'anchor', 'searchreplace', 'visualblocks', 'code',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }'
        });

        // Custom toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                padding: 1rem 1.5rem; border-radius: 8px;
                background: ${type === 'success' ? 'var(--admin-success)' : 'var(--admin-danger)'};
                color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Featured image preview
        document.getElementById('featuredImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('featuredPreviewImg').src = e.target.result;
                    document.getElementById('featuredImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Gallery images preview
        document.getElementById('galleryImagesInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const previewContainer = document.getElementById('galleryImagesPreviews');
            previewContainer.innerHTML = ''; // Clear previous previews

            if (files.length > 10) {
                showToast('Bạn chỉ có thể chọn tối đa 10 ảnh.', 'error');
                this.value = '';
                return;
            }

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.style.cssText = 'position: relative;';
                    col.innerHTML = `
                        <img src="${e.target.result}" style="height: 120px; width: 100%; object-fit: cover; border-radius: 8px; border: 1px solid var(--admin-border);">
                        <button type="button" class="admin-btn admin-btn-danger" style="position: absolute; top: 0.25rem; right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" 
                                onclick="removeGalleryPreview(this)">
                            <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                        </button>
                    `;
                    previewContainer.appendChild(col);
                    lucide.createIcons(); // Re-init icons for new elements
                };
                reader.readAsDataURL(file);
            });
        });

        function removeFeaturedImage() {
            document.getElementById('featuredImageInput').value = '';
            document.getElementById('featuredImagePreview').style.display = 'none';
        }

        function removeGalleryPreview(button) {
            button.closest('div[style*="position: relative"]').remove();
            // Reset file input to remove the file from selection
            document.getElementById('galleryImagesInput').value = '';
        }

        function removeExistingImage(index, imageUrl) {
            if (confirm('Bạn có chắc chắn muốn xóa ảnh này không?')) {
                // Hide the image element
                event.target.closest('.gallery-item').style.display = 'none';
                
                // Add hidden input to mark for deletion
                const deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'DeleteGalleryImages';
                deleteInput.value = imageUrl;
                document.getElementById('productForm').appendChild(deleteInput);
            }
        }

        function confirmDelete() {
            if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này không? Hành động này không thể hoàn tác.')) {
                document.getElementById('deleteForm').submit();
            }
        }

        // Auto-generate SKU from product name
        document.querySelector('[name="Name"]').addEventListener('input', function(e) {
            const name = e.target.value;
            const skuInput = document.querySelector('[name="SKU"]');
            
            if (skuInput.value === '' || skuInput.getAttribute('data-auto-generated') === 'true') {
                const sku = generateSKU(name);
                skuInput.value = sku;
                skuInput.setAttribute('data-auto-generated', 'true');
            }
        });

        // Remove auto-generated flag when user manually edits SKU
        document.querySelector('[name="SKU"]').addEventListener('input', function(e) {
            e.target.removeAttribute('data-auto-generated');
        });

        function generateSKU(name) {
            if (!name) return '';
            
            // Remove Vietnamese accents and special characters
            const cleanName = removeVietnameseAccents(name)
                .toUpperCase()
                .replace(/[^A-Z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 20);
            
            // Add timestamp for uniqueness
            const timestamp = Date.now().toString().substring(-4);
            
            return cleanName + '-' + timestamp;
        }

        function removeVietnameseAccents(str) {
            const accents = {
                'à': 'a', 'á': 'a', 'ạ': 'a', 'ả': 'a', 'ã': 'a', 'â': 'a', 'ầ': 'a', 'ấ': 'a', 'ậ': 'a', 'ẩ': 'a', 'ẫ': 'a', 'ă': 'a', 'ằ': 'a', 'ắ': 'a', 'ặ': 'a', 'ẳ': 'a', 'ẵ': 'a',
                'è': 'e', 'é': 'e', 'ẹ': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ê': 'e', 'ề': 'e', 'ế': 'e', 'ệ': 'e', 'ể': 'e', 'ễ': 'e',
                'ì': 'i', 'í': 'i', 'ị': 'i', 'ỉ': 'i', 'ĩ': 'i',
                'ò': 'o', 'ó': 'o', 'ọ': 'o', 'ỏ': 'o', 'õ': 'o', 'ô': 'o', 'ồ': 'o', 'ố': 'o', 'ộ': 'o', 'ổ': 'o', 'ỗ': 'o', 'ơ': 'o', 'ờ': 'o', 'ớ': 'o', 'ợ': 'o', 'ở': 'o', 'ỡ': 'o',
                'ù': 'u', 'ú': 'u', 'ụ': 'u', 'ủ': 'u', 'ũ': 'u', 'ư': 'u', 'ừ': 'u', 'ứ': 'u', 'ự': 'u', 'ử': 'u', 'ữ': 'u',
                'ỳ': 'y', 'ý': 'y', 'ỵ': 'y', 'ỷ': 'y', 'ỹ': 'y',
                'đ': 'd'
            };
            
            return str.split('').map(char => accents[char] || char).join('');
        }

        // Form validation with enhanced checks
        document.getElementById('productForm').addEventListener('submit', function(e) {
            const name = document.querySelector('[name="Name"]').value.trim();
            const sku = document.querySelector('[name="SKU"]').value.trim();
            const price = document.querySelector('[name="Price"]').value;
            const categoryId = document.querySelector('[name="CategoryId"]').value;

            if (!name) {
                showToast('Vui lòng nhập tên sản phẩm.', 'error');
                e.preventDefault();
                return;
            }

            if (name.length < 3) {
                showToast('Tên sản phẩm phải có ít nhất 3 ký tự.', 'error');
                e.preventDefault();
                return;
            }

            if (!sku) {
                showToast('Vui lòng nhập SKU.', 'error');
                e.preventDefault();
                return;
            }

            if (!price || price <= 0) {
                showToast('Vui lòng nhập giá sản phẩm hợp lệ.', 'error');
                e.preventDefault();
                return;
            }

            if (!categoryId) {
                showToast('Vui lòng chọn danh mục sản phẩm.', 'error');
                e.preventDefault();
                return;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> Đang cập nhật...';
            submitBtn.disabled = true;
        });

        // Price formatting
        const priceInput = document.querySelector('[name="Price"]');
        const salePriceInput = document.querySelector('[name="SalePrice"]');

        function formatPrice(input) {
            input.addEventListener('blur', function() {
                if (this.value) {
                    this.value = Math.round(parseFloat(this.value));
                }
            });
        }

        formatPrice(priceInput);
        formatPrice(salePriceInput);

        // Validate sale price is less than regular price
        salePriceInput.addEventListener('blur', function() {
            const price = parseFloat(priceInput.value);
            const salePrice = parseFloat(this.value);
            
            if (salePrice && price && salePrice >= price) {
                showToast('Giá khuyến mãi phải nhỏ hơn giá gốc.', 'error');
                this.focus();
            }
        });
    </script>
}
