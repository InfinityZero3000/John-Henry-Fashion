@model ProductListViewModel
@{
    ViewData["Title"] = "Sản phẩm của tôi";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="package"></i>
                Sản phẩm của tôi
            </h1>
            <a href="@Url.Action("Create", "SellerProducts")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Thêm sản phẩm mới
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["Success"]</span>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="admin-alert admin-alert-danger">
            <i data-lucide="alert-circle"></i>
            <span>@TempData["Error"]</span>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng sản phẩm</h3>
                    <p class="value">@Model.TotalProducts</p>
                    <p class="change">Tất cả</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="package"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đang bán</h3>
                    <p class="value">@Model.Products.Count(p => p.Status == "Active")</p>
                    <p class="change">Đang hoạt động</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="check-circle"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tạm ẩn</h3>
                    <p class="value">@Model.Products.Count(p => p.Status == "Inactive")</p>
                    <p class="change">Chưa hiển thị</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="eye-off"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Hết hàng</h3>
                    <p class="value">@Model.Products.Count(p => p.StockQuantity <= 0)</p>
                    <p class="change">Cần nhập thêm</p>
                </div>
                <div class="admin-stat-card-icon danger">
                    <i data-lucide="alert-triangle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="admin-filters">
        <form method="get" action="/seller/products">
            <div class="row g-3 align-items-end">
                <!-- Search Box -->
                <div class="col-md-5">
                    <label class="admin-form-label">Tìm kiếm</label>
                    <div class="admin-search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" name="search" class="admin-form-input" 
                               placeholder="Tìm kiếm sản phẩm hoặc SKU..." 
                               value="@Model.SearchTerm">
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="col-md-3">
                    <label class="admin-form-label">Danh mục</label>
                    <select name="categoryId" class="admin-form-select">
                        <option value="">Tất cả danh mục</option>
                        @foreach (var category in Model.Categories)
                        {
                            <option value="@category.Id" selected="@(Model.CategoryId == category.Id)">
                                @category.Name
                            </option>
                        }
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-md-2">
                    <label class="admin-form-label">Trạng thái</label>
                    <select name="status" class="admin-form-select">
                        <option value="">Tất cả</option>
                        <option value="Active" selected="@(Model.Status == "Active")">Đang bán</option>
                        <option value="Inactive" selected="@(Model.Status == "Inactive")">Tạm ẩn</option>
                        <option value="Draft" selected="@(Model.Status == "Draft")">Bản nháp</option>
                    </select>
                </div>

                <!-- Search Button -->
                <div class="col-md-2">
                    <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%;">
                        <i data-lucide="search"></i>
                        Tìm kiếm
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Filter Tabs -->
    <div class="admin-filter-tabs">
        <a href="@Url.Action("Index", "SellerProducts", new { status = "", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(string.IsNullOrEmpty(Model.Status) ? "active" : "")">
            Tất cả (@Model.TotalProducts)
        </a>
        <a href="@Url.Action("Index", "SellerProducts", new { status = "Active", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(Model.Status == "Active" ? "active" : "")">
            <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
            Đang bán (@Model.Products.Count(p => p.Status == "Active"))
        </a>
        <a href="@Url.Action("Index", "SellerProducts", new { status = "Inactive", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(Model.Status == "Inactive" ? "active" : "")">
            <i data-lucide="eye-off" style="width: 14px; height: 14px;"></i>
            Tạm ẩn (@Model.Products.Count(p => p.Status == "Inactive"))
        </a>
        <a href="@Url.Action("Index", "SellerProducts", new { status = "Draft", search = Model.SearchTerm, categoryId = Model.CategoryId })" 
           class="admin-filter-tab @(Model.Status == "Draft" ? "active" : "")">
            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
            Bản nháp (@Model.Products.Count(p => p.Status == "Draft"))
        </a>
    </div>

    <!-- Products Table -->
    @if (Model.Products.Any())
    {
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Hình ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th style="width: 120px;">SKU</th>
                        <th style="width: 150px;">Danh mục</th>
                        <th style="width: 120px;">Giá</th>
                        <th style="width: 80px;">Kho</th>
                        <th style="width: 120px;">Trạng thái</th>
                        <th style="width: 180px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in Model.Products)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(product.FeaturedImageUrl))
                                {
                                    <img src="@product.FeaturedImageUrl" alt="@product.Name" 
                                         class="admin-table-img">
                                }
                                else
                                {
                                    <div class="admin-table-img-placeholder">
                                        <i data-lucide="image"></i>
                                    </div>
                                }
                            </td>
                            <td>
                                <div>
                                    <div class="fw-semibold">@product.Name</div>
                                    @if (!string.IsNullOrEmpty(product.BrandName))
                                    {
                                        <small class="text-muted">@product.BrandName</small>
                                    }
                                    @if (product.IsFeatured)
                                    {
                                        <span class="admin-badge admin-badge-primary">
                                            <i data-lucide="star" style="width: 12px; height: 12px;"></i>
                                            Nổi bật
                                        </span>
                                    }
                                </div>
                            </td>
                            <td><code>@product.SKU</code></td>
                            <td>@product.CategoryName</td>
                            <td>
                                @if (product.SalePrice.HasValue && product.SalePrice < product.Price)
                                {
                                    <div>
                                        <div class="text-danger fw-semibold">@product.SalePrice.Value.ToString("N0") ₫</div>
                                        <small class="text-muted text-decoration-line-through">@product.Price.ToString("N0") ₫</small>
                                    </div>
                                }
                                else
                                {
                                    <div class="fw-semibold">@product.Price.ToString("N0") ₫</div>
                                }
                            </td>
                            <td>
                                @if (product.StockQuantity <= 0)
                                {
                                    <span class="text-danger fw-semibold">@product.StockQuantity</span>
                                }
                                else if (product.StockQuantity <= 5)
                                {
                                    <span class="text-warning fw-semibold">@product.StockQuantity</span>
                                }
                                else
                                {
                                    <span class="text-success fw-semibold">@product.StockQuantity</span>
                                }
                            </td>
                            <td>
                                @switch (product.Status)
                                {
                                    case "Active":
                                        <span class="admin-badge admin-badge-success">Đang bán</span>
                                        break;
                                    case "Inactive":
                                        <span class="admin-badge admin-badge-warning">Tạm ẩn</span>
                                        break;
                                    case "Draft":
                                        <span class="admin-badge admin-badge-secondary">Bản nháp</span>
                                        break;
                                }
                                @if (product.StockQuantity <= 0)
                                {
                                    <span class="admin-badge admin-badge-danger d-block mt-1">Hết hàng</span>
                                }
                            </td>
                            <td>
                                <div class="admin-table-actions">
                                    <a href="@Url.Action("Edit", "SellerProducts", new { id = product.Id })" 
                                       class="admin-btn admin-btn-sm admin-btn-outline" title="Sửa">
                                        <i data-lucide="edit-2"></i>
                                    </a>
                                    <button class="admin-btn admin-btn-sm admin-btn-outline" 
                                            type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Thêm">
                                        <i data-lucide="more-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                            @if (product.Status == "Active")
                                            {
                                                <li>
                                                    <button type="button" class="dropdown-item" 
                                                            onclick="updateProductStatus('@product.Id', 'Inactive')">
                                                        <i data-lucide="eye-off" class="me-2" style="width: 16px; height: 16px;"></i>
                                                        Ẩn sản phẩm
                                                    </button>
                                                </li>
                                            }
                                            else
                                            {
                                                <li>
                                                    <button type="button" class="dropdown-item" 
                                                            onclick="updateProductStatus('@product.Id', 'Active')">
                                                        <i data-lucide="eye" class="me-2" style="width: 16px; height: 16px;"></i>
                                                        Hiển thị sản phẩm
                                                    </button>
                                                </li>
                                            }
                                            <li>
                                                <button type="button" class="dropdown-item" 
                                                        onclick="toggleFeatured('@product.Id', @(product.IsFeatured ? "false" : "true"))">
                                                    @if (product.IsFeatured)
                                                    {
                                                        <span><i data-lucide="star-off" class="me-2" style="width: 16px; height: 16px;"></i>Bỏ nổi bật</span>
                                                    }
                                                    else
                                                    {
                                                        <span><i data-lucide="star" class="me-2" style="width: 16px; height: 16px;"></i>Đặt nổi bật</span>
                                                    }
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button type="button" class="dropdown-item text-danger" 
                                                        onclick="deleteProduct('@product.Id', '@product.Name')">
                                                    <i data-lucide="trash-2" class="me-2" style="width: 16px; height: 16px;"></i>
                                                    Xóa sản phẩm
                                                </button>
                                            </li>
                                        </ul>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="admin-pagination">
                <div class="admin-pagination-info">
                    Hiển thị @((Model.CurrentPage - 1) * Model.PageSize + 1) - @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalProducts)) trong tổng số @Model.TotalProducts sản phẩm
                </div>
                <div class="admin-pagination-controls">
                    @if (Model.CurrentPage > 1)
                    {
                        <a href="@Url.Action("Index", "SellerProducts", new { page = Model.CurrentPage - 1, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                           class="admin-pagination-prev">
                            <i data-lucide="chevron-left"></i>
                            Trước
                        </a>
                    }

                    <div class="admin-pagination-numbers">
                        @{
                            var startPage = Math.Max(1, Model.CurrentPage - 2);
                            var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                        }

                        @if (startPage > 1)
                        {
                            <a href="@Url.Action("Index", "SellerProducts", new { page = 1, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                               class="admin-pagination-number">1</a>
                            @if (startPage > 2)
                            {
                                <span class="admin-pagination-ellipsis">...</span>
                            }
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <a href="@Url.Action("Index", "SellerProducts", new { page = i, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                               class="admin-pagination-number @(i == Model.CurrentPage ? "active" : "")">@i</a>
                        }

                        @if (endPage < Model.TotalPages)
                        {
                            @if (endPage < Model.TotalPages - 1)
                            {
                                <span class="admin-pagination-ellipsis">...</span>
                            }
                            <a href="@Url.Action("Index", "SellerProducts", new { page = Model.TotalPages, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                               class="admin-pagination-number">@Model.TotalPages</a>
                        }
                    </div>

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="@Url.Action("Index", "SellerProducts", new { page = Model.CurrentPage + 1, search = Model.SearchTerm, categoryId = Model.CategoryId, status = Model.Status })" 
                           class="admin-pagination-next">
                            Sau
                            <i data-lucide="chevron-right"></i>
                        </a>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="admin-empty-state">
            <div class="admin-empty-state-icon">
                <i data-lucide="package-x"></i>
            </div>
            <h3 class="admin-empty-state-title">Chưa có sản phẩm nào</h3>
            <p class="admin-empty-state-description">Bắt đầu bán hàng bằng cách thêm sản phẩm đầu tiên của bạn</p>
            <a href="@Url.Action("Create", "SellerProducts")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Thêm sản phẩm đầu tiên
            </a>
        </div>
    }
</div>

<!-- Hidden forms for AJAX actions -->
<form id="statusForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productId" id="statusProductId">
    <input type="hidden" name="status" id="statusValue">
</form>

<form id="featuredForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productId" id="featuredProductId">
    <input type="hidden" name="isFeatured" id="featuredValue">
</form>

<form id="deleteForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productId" id="deleteProductId">
</form>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });

        // Update product status (Active/Inactive)
        function updateProductStatus(productId, status) {
            if (confirm('Bạn có chắc chắn muốn thay đổi trạng thái sản phẩm này?')) {
                document.getElementById('statusProductId').value = productId;
                document.getElementById('statusValue').value = status;
                document.getElementById('statusForm').action = '@Url.Action("UpdateProductStatus", "SellerProducts")';
                document.getElementById('statusForm').submit();
            }
        }

        // Toggle featured status
        function toggleFeatured(productId, isFeatured) {
            const action = isFeatured === 'true' ? 'đặt làm nổi bật' : 'bỏ nổi bật';
            if (confirm(`Bạn có chắc chắn muốn ${action} sản phẩm này?`)) {
                document.getElementById('featuredProductId').value = productId;
                document.getElementById('featuredValue').value = isFeatured;
                document.getElementById('featuredForm').action = '@Url.Action("UpdateProductFeatured", "SellerProducts")';
                document.getElementById('featuredForm').submit();
            }
        }

        // Delete product
        function deleteProduct(productId, productName) {
            if (confirm(`Bạn có chắc chắn muốn xóa sản phẩm "${productName}"? Hành động này không thể hoàn tác.`)) {
                document.getElementById('deleteProductId').value = productId;
                document.getElementById('deleteForm').action = '@Url.Action("DeleteProduct", "SellerProducts")';
                document.getElementById('deleteForm').submit();
            }
        }
    </script>
}