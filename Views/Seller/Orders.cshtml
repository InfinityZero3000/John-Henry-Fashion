@model JohnHenryFashionWeb.ViewModels.SellerOrdersViewModel
@{
    ViewData["Title"] = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-page-header-content">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="shopping-cart" class="me-2"></i>
                    Quản lý đơn hàng
                </h1>
                <p class="admin-page-description">Theo dõi và xử lý các đơn hàng của bạn</p>
            </div>
            <div class="admin-page-actions">
                <button type="button" class="admin-btn admin-btn-outline">
                    <i data-lucide="download" class="me-2"></i>
                    Xuất báo cáo
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Tổng đơn hàng</div>
                    <div class="admin-stat-value">@Model.TotalOrders</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(59, 130, 246, 0.1);">
                    <i data-lucide="shopping-bag" style="color: #3b82f6;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Đơn chờ xử lý</div>
                    <div class="admin-stat-value text-warning">@Model.PendingOrders</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(251, 191, 36, 0.1);">
                    <i data-lucide="clock" style="color: #fbbf24;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Đơn hôm nay</div>
                    <div class="admin-stat-value text-info">@Model.TodayOrders</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(14, 165, 233, 0.1);">
                    <i data-lucide="calendar" style="color: #0ea5e9;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-label">Doanh thu hôm nay</div>
                    <div class="admin-stat-value text-success">@Model.TodayRevenue.ToString("N0") ₫</div>
                </div>
                <div class="admin-stat-icon" style="background-color: rgba(34, 197, 94, 0.1);">
                    <i data-lucide="dollar-sign" style="color: #22c55e;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="admin-filters">
        <form method="get" class="admin-filters-form">
            <div class="admin-search-box">
                <i data-lucide="search"></i>
                <input type="text" name="search" value="@Model.SearchQuery" 
                       placeholder="Mã đơn hàng, tên khách hàng, email..." class="admin-search-input">
            </div>
            
            <select name="status" class="admin-form-select" onchange="this.form.submit()">
                <option value="" selected="@(string.IsNullOrEmpty(Model.StatusFilter))">Tất cả trạng thái (@Model.StatusCounts["all"])</option>
                <option value="pending" selected="@(Model.StatusFilter == "pending")">Chờ xử lý (@Model.StatusCounts["pending"])</option>
                <option value="processing" selected="@(Model.StatusFilter == "processing")">Đang xử lý (@Model.StatusCounts["processing"])</option>
                <option value="completed" selected="@(Model.StatusFilter == "completed")">Hoàn thành (@Model.StatusCounts["completed"])</option>
                <option value="cancelled" selected="@(Model.StatusFilter == "cancelled")">Đã hủy (@Model.StatusCounts["cancelled"])</option>
            </select>
            
            <button type="submit" class="admin-btn admin-btn-primary">
                <i data-lucide="search" class="me-1"></i>
                Tìm kiếm
            </button>
            
            @if (!string.IsNullOrEmpty(Model.SearchQuery) || !string.IsNullOrEmpty(Model.StatusFilter))
            {
                <a href="@Url.Action("Orders")" class="admin-btn admin-btn-outline">
                    <i data-lucide="x" class="me-1"></i>
                    Xóa lọc
                </a>
            }
        </form>
    </div>

    <!-- Filter Tabs -->
    <div class="admin-filter-tabs mb-4">
        <a href="@Url.Action("Orders", new { search = Model.SearchQuery })" 
           class="admin-filter-tab @(string.IsNullOrEmpty(Model.StatusFilter) ? "active" : "")">
            Tất cả <span class="badge bg-secondary ms-1">@Model.StatusCounts["all"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "pending", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "pending" ? "active" : "")">
            Chờ xử lý <span class="badge bg-warning ms-1">@Model.StatusCounts["pending"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "processing", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "processing" ? "active" : "")">
            Đang xử lý <span class="badge bg-info ms-1">@Model.StatusCounts["processing"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "completed", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "completed" ? "active" : "")">
            Hoàn thành <span class="badge bg-success ms-1">@Model.StatusCounts["completed"]</span>
        </a>
        <a href="@Url.Action("Orders", new { status = "cancelled", search = Model.SearchQuery })" 
           class="admin-filter-tab @(Model.StatusFilter == "cancelled" ? "active" : "")">
            Đã hủy <span class="badge bg-danger ms-1">@Model.StatusCounts["cancelled"]</span>
        </a>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" class="admin-bulk-actions mb-3" style="display: none;">
        <div class="d-flex align-items-center gap-3">
            <span class="text-muted" id="selectedCount">0 đơn hàng đã chọn</span>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="bulkUpdateStatus('processing')">
                    <i data-lucide="play" class="me-1" style="width: 14px; height: 14px;"></i>
                    Duyệt đơn
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="bulkUpdateStatus('shipped')">
                    <i data-lucide="truck" class="me-1" style="width: 14px; height: 14px;"></i>
                    Gửi hàng
                </button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="bulkUpdateStatus('delivered')">
                    <i data-lucide="check-circle" class="me-1" style="width: 14px; height: 14px;"></i>
                    Hoàn thành
                </button>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                <i data-lucide="x" class="me-1" style="width: 14px; height: 14px;"></i>
                Bỏ chọn
            </button>
        </div>
    </div>

    <!-- Orders Table -->
    @if (Model.Orders.Any())
    {
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                        </th>
                        <th style="width: 130px;">Mã đơn hàng</th>
                        <th>Khách hàng</th>
                        <th style="width: 80px;">Số lượng</th>
                        <th style="width: 120px;">Tổng tiền</th>
                        <th style="width: 120px;">Trạng thái</th>
                        <th style="width: 120px;">Thanh toán</th>
                        <th style="width: 140px;">Ngày đặt</th>
                        <th style="width: 200px;">Thao tác nhanh</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model.Orders)
                    {
                        <tr data-order-id="@order.Id">
                            <td>
                                <input type="checkbox" class="order-checkbox" value="@order.Id" onchange="updateBulkActions()">
                            </td>
                            <td>
                                <code class="text-primary fw-semibold">@order.OrderNumber</code>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-semibold">@order.CustomerName</div>
                                    <small class="text-muted">@order.CustomerEmail</small>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="admin-badge admin-badge-secondary">@order.ItemCount</span>
                            </td>
                            <td>
                                <span class="fw-semibold text-success">@order.Total.ToString("N0") ₫</span>
                            </td>
                            <td>
                                @switch (order.Status.ToLower())
                                {
                                    case "pending":
                                        <span class="admin-badge admin-badge-warning">Chờ xử lý</span>
                                        break;
                                    case "processing":
                                        <span class="admin-badge admin-badge-info">Đang xử lý</span>
                                        break;
                                    case "shipped":
                                        <span class="admin-badge admin-badge-primary">Đã gửi</span>
                                        break;
                                    case "delivered":
                                        <span class="admin-badge admin-badge-success">Đã giao</span>
                                        break;
                                    case "cancelled":
                                        <span class="admin-badge admin-badge-danger">Đã hủy</span>
                                        break;
                                    default:
                                        <span class="admin-badge admin-badge-secondary">@order.Status</span>
                                        break;
                                }
                            </td>
                            <td>
                                @switch (order.PaymentStatus.ToLower())
                                {
                                    case "paid":
                                        <span class="admin-badge admin-badge-success">Đã thanh toán</span>
                                        break;
                                    case "pending":
                                        <span class="admin-badge admin-badge-warning">Chờ thanh toán</span>
                                        break;
                                    case "cod_pending":
                                        <span class="admin-badge admin-badge-warning">
                                            <i data-lucide="banknote" style="width: 12px; height: 12px;"></i>
                                            COD - Chờ thanh toán
                                        </span>
                                        break;
                                    case "failed":
                                        <span class="admin-badge admin-badge-danger">Thất bại</span>
                                        break;
                                    case "refunded":
                                        <span class="admin-badge admin-badge-info">Đã hoàn tiền</span>
                                        break;
                                    default:
                                        <span class="admin-badge admin-badge-secondary">@order.PaymentStatus</span>
                                        break;
                                }
                            </td>
                            <td>
                                <small class="text-muted">@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                            </td>
                            <td>
                                <div class="admin-table-actions d-flex gap-1 flex-wrap">
                                    <a href="@Url.Action("OrderDetail", "Seller", new { id = order.Id })" 
                                       class="admin-btn admin-btn-sm admin-btn-outline" title="Chi tiết">
                                        <i data-lucide="eye"></i>
                                    </a>
                                    
                                    @* Quick Actions based on status *@
                                    @if (order.Status.ToLower() == "pending")
                                    {
                                        <button class="admin-btn admin-btn-sm admin-btn-success" 
                                                onclick="quickProcess('@order.Id')" title="Duyệt đơn (1-click)">
                                            <i data-lucide="check"></i> Duyệt
                                        </button>
                                    }
                                    else if (order.Status.ToLower() == "processing")
                                    {
                                        <button class="admin-btn admin-btn-sm admin-btn-primary" 
                                                onclick="quickShip('@order.Id')" title="Gửi hàng (1-click)">
                                            <i data-lucide="truck"></i> Gửi
                                        </button>
                                    }
                                    else if (order.Status.ToLower() == "shipped")
                                    {
                                        <button class="admin-btn admin-btn-sm admin-btn-success" 
                                                onclick="quickDeliver('@order.Id')" title="Hoàn thành (1-click)">
                                            <i data-lucide="check-circle"></i> Hoàn thành
                                        </button>
                                    }
                                    
                                    @* Manual update button (fallback) *@
                                    <div class="dropdown">
                                        <button class="admin-btn admin-btn-sm admin-btn-outline dropdown-toggle" 
                                                type="button" data-bs-toggle="dropdown" title="Thao tác khác">
                                            <i data-lucide="more-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="@Url.Action("OrderDetail", "Seller", new { id = order.Id })">
                                                <i data-lucide="eye" class="me-2"></i> Xem chi tiết
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('@order.Id', 'processing'); return false;">
                                                <i data-lucide="play" class="me-2"></i> Duyệt đơn
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('@order.Id', 'shipped'); return false;">
                                                <i data-lucide="truck" class="me-2"></i> Gửi hàng
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('@order.Id', 'delivered'); return false;">
                                                <i data-lucide="check-circle" class="me-2"></i> Hoàn thành
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="admin-pagination">
                <div class="admin-pagination-info">
                    Hiển thị <strong>@((Model.CurrentPage - 1) * Model.PageSize + 1) - @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalOrders)</strong> 
                    trong tổng số <strong>@Model.TotalOrders</strong> đơn hàng
                </div>
                <div class="admin-pagination-buttons">
                    @if (Model.CurrentPage > 1)
                    {
                        <a href="@Url.Action("Orders", new { page = 1, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang đầu">
                            <i data-lucide="chevrons-left"></i>
                        </a>
                        <a href="@Url.Action("Orders", new { page = Model.CurrentPage - 1, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang trước">
                            <i data-lucide="chevron-left"></i>
                        </a>
                    }
                    else
                    {
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevrons-left"></i>
                        </span>
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevron-left"></i>
                        </span>
                    }

                    @{
                        var startPage = Math.Max(1, Model.CurrentPage - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        if (i == Model.CurrentPage)
                        {
                            <span class="admin-pagination-btn active">@i</span>
                        }
                        else
                        {
                            <a href="@Url.Action("Orders", new { page = i, search = Model.SearchQuery, status = Model.StatusFilter })" 
                               class="admin-pagination-btn">@i</a>
                        }
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="@Url.Action("Orders", new { page = Model.CurrentPage + 1, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang tiếp">
                            <i data-lucide="chevron-right"></i>
                        </a>
                        <a href="@Url.Action("Orders", new { page = Model.TotalPages, search = Model.SearchQuery, status = Model.StatusFilter })" 
                           class="admin-pagination-btn" title="Trang cuối">
                            <i data-lucide="chevrons-right"></i>
                        </a>
                    }
                    else
                    {
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevron-right"></i>
                        </span>
                        <span class="admin-pagination-btn disabled">
                            <i data-lucide="chevrons-right"></i>
                        </span>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i data-lucide="inbox" style="width: 64px; height: 64px;"></i>
            <h4 class="mt-3 mb-2">Chưa có đơn hàng nào</h4>
            <p class="text-muted mb-4">Các đơn hàng sẽ hiển thị tại đây khi có khách đặt mua</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });

        // Quick Actions - 1-click updates
        function quickProcess(orderId) {
            updateOrderStatusQuick(orderId, 'processing', '@Url.Action("QuickProcess", "Seller")');
        }

        function quickShip(orderId) {
            const trackingNumber = prompt('Nhập mã vận đơn (tùy chọn):');
            if (trackingNumber !== null) {
                updateOrderStatusQuick(orderId, 'shipped', '@Url.Action("QuickShip", "Seller")', trackingNumber);
            }
        }

        function quickDeliver(orderId) {
            updateOrderStatusQuick(orderId, 'delivered', '@Url.Action("QuickDeliver", "Seller")');
        }

        function updateOrderStatusQuick(orderId, status, url, trackingNumber = null) {
            const button = event?.target?.closest('button') || document.querySelector(`[onclick*="${orderId}"]`);
            if (button) {
                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                const body = new URLSearchParams({
                    id: orderId,
                    __RequestVerificationToken: token
                });
                if (trackingNumber) {
                    body.append('trackingNumber', trackingNumber);
                }
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: body
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show toast notification instead of alert
                        showToast('success', data.message);
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showToast('error', data.message);
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        lucide.createIcons();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Đã xảy ra lỗi. Vui lòng thử lại.');
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    lucide.createIcons();
                });
            }
        }

        // Bulk Actions
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.order-checkbox:checked');
            const bulkBar = document.getElementById('bulkActionsBar');
            const countSpan = document.getElementById('selectedCount');
            
            if (selected.length > 0) {
                bulkBar.style.display = 'flex';
                countSpan.textContent = `${selected.length} đơn hàng đã chọn`;
            } else {
                bulkBar.style.display = 'none';
            }
        }

        function bulkUpdateStatus(newStatus) {
            const selected = Array.from(document.querySelectorAll('.order-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                showToast('warning', 'Vui lòng chọn ít nhất một đơn hàng');
                return;
            }

            const statusText = {
                'processing': 'duyệt',
                'shipped': 'gửi hàng',
                'delivered': 'hoàn thành'
            };

            if (confirm(`Bạn có chắc chắn muốn ${statusText[newStatus] || 'cập nhật'} ${selected.length} đơn hàng đã chọn?`)) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                fetch('@Url.Action("BulkUpdateStatus", "Seller")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({
                        OrderIds: selected,
                        NewStatus: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast('error', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Đã xảy ra lỗi. Vui lòng thử lại.');
                });
            }
        }

        function clearSelection() {
            document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateBulkActions();
        }

        // Manual update (fallback)
        function updateOrderStatus(orderId, newStatus) {
            const statusText = {
                'processing': 'duyệt đơn hàng và bắt đầu xử lý',
                'shipped': 'đánh dấu đơn hàng đã gửi đi',
                'delivered': 'xác nhận đơn hàng đã giao thành công',
                'cancelled': 'hủy đơn hàng'
            };
            
            const actionText = statusText[newStatus] || 'cập nhật trạng thái';
            
            if (confirm(`Bạn có chắc chắn muốn ${actionText}?`)) {
                const button = event?.target?.closest('button') || event?.target?.closest('a');
                const originalContent = button?.innerHTML;
                if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
                }
                
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                fetch('@Url.Action("UpdateOrderStatus", "Seller")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({
                        orderId: orderId,
                        newStatus: newStatus,
                        __RequestVerificationToken: token
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showToast('error', data.message);
                        if (button) {
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        lucide.createIcons();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Đã xảy ra lỗi khi cập nhật trạng thái. Vui lòng thử lại.');
                    if (button) {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    lucide.createIcons();
                    }
                });
            }
        }

        // Toast notification helper
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
    
    <!-- Anti-forgery token for AJAX requests -->
    @Html.AntiForgeryToken()
}
