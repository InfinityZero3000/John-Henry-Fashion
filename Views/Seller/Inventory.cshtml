@model JohnHenryFashionWeb.ViewModels.InventoryListViewModel
@{
    ViewData["Title"] = "Quản lý Tồn kho";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="package"></i>
                Quản lý Tồn kho
            </h1>
            <a href="@Url.Action("Create", "SellerProducts")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Thêm sản phẩm
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng số hàng</h3>
                    <p class="value">@Model.TotalStockQuantity.ToString("N0")</p>
                    <p class="change">Tồn kho</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="package"></i>
                </div>
            </div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Sắp hết hàng</h3>
                    <p class="value">@Model.LowStockProducts</p>
                    <p class="change">Cần nhập thêm</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="alert-triangle"></i>
                </div>
            </div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Hết hàng</h3>
                    <p class="value">@Model.OutOfStockProducts</p>
                    <p class="change">Cần nhập gấp</p>
                </div>
                <div class="admin-stat-card-icon danger">
                    <i data-lucide="x-circle"></i>
                </div>
            </div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Còn hàng tốt</h3>
                    <p class="value">@Model.InStockProducts</p>
                    <p class="change">Đủ dùng</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="check-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="admin-filters">
        <form method="get" action="@Url.Action("Inventory")">
            <div class="row g-3 align-items-end">
                <!-- Search Box -->
                <div class="col-md-6">
                    <label class="admin-form-label">Tìm kiếm</label>
                    <div class="admin-search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" name="search" class="admin-form-input" 
                               placeholder="Tìm theo tên sản phẩm hoặc SKU..." 
                               value="@Model.SearchTerm">
                    </div>
                </div>

                <!-- Low Stock Filter -->
                <div class="col-md-3">
                    <div class="admin-form-check" style="margin-top: 2rem;">
                        <input class="admin-form-check-input" type="checkbox" id="lowStock" name="lowStock" 
                               value="true" @(Model.Filter == "low_stock" ? "checked" : "")>
                        <label class="admin-form-check-label" for="lowStock">
                            Sắp hết hàng
                        </label>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="col-md-3">
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="admin-btn admin-btn-primary" style="flex: 1;">
                            <i data-lucide="search"></i>
                            Tìm
                        </button>
                        <a href="@Url.Action("Inventory")" class="admin-btn admin-btn-secondary">
                            <i data-lucide="refresh-cw"></i>
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Inventory Table -->
    @if (Model.Items.Any())
    {
        <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;"></th>
                                <th>Sản phẩm</th>
                                <th>Danh mục</th>
                                <th>SKU</th>
                                <th>Giá</th>
                                <th style="text-align: center;">Tồn kho</th>
                                <th style="text-align: center;">Trạng thái</th>
                                <th>Cập nhật cuối</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr style="@(item.IsOutOfStock ? "background-color: var(--admin-danger-light);" : item.IsLowStock ? "background-color: var(--admin-warning-light);" : "")">
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" alt="@item.ProductName" 
                                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid var(--admin-border);">
                                        }
                                        else
                                        {
                                            <div style="width: 50px; height: 50px; background: var(--admin-bg-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--admin-border);">
                                                <i data-lucide="image" style="width: 24px; height: 24px; color: var(--admin-text-muted);"></i>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-weight: 500; color: var(--admin-text); margin-bottom: 0.25rem;">
                                            @item.ProductName
                                        </div>
                                        <div style="font-size: 0.8125rem; color: var(--admin-text-light);">
                                            ID: @item.ProductId.ToString().Substring(0, 8)...
                                        </div>
                                    </td>
                                    <td>
                                        <span class="admin-badge admin-badge-secondary">@item.CategoryName</span>
                                    </td>
                                    <td>
                                        <code style="font-size: 0.875rem; background: var(--admin-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px;">@item.SKU</code>
                                    </td>
                                    <td>
                                        <div style="font-weight: 500;">@item.Price.ToString("N0") đ</div>
                                    </td>
                                    <td style="text-align: center;">
                                        <div style="font-weight: 600; font-size: 1.125rem; color: @(item.IsOutOfStock ? "var(--status-danger)" : item.IsLowStock ? "var(--status-warning)" : "var(--status-success)");" class="inventory-stock" data-product-id="@item.ProductId">
                                            @item.CurrentStock
                                        </div>
                                    </td>
                                    <td style="text-align: center;">
                                        @if (item.IsOutOfStock)
                                        {
                                            <span class="admin-badge admin-badge-danger">
                                                <i data-lucide="x-circle" style="width: 12px; height: 12px;"></i>
                                                Hết hàng
                                            </span>
                                        }
                                        else if (item.IsLowStock)
                                        {
                                            <span class="admin-badge admin-badge-warning">
                                                <i data-lucide="alert-triangle" style="width: 12px; height: 12px;"></i>
                                                Sắp hết
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="admin-badge admin-badge-success">
                                                <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                                Còn hàng
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div style="font-size: 0.875rem;">@item.LastUpdated.ToString("dd/MM/yyyy")</div>
                                        <div style="font-size: 0.8125rem; color: var(--admin-text-light);">@item.LastUpdated.ToString("HH:mm")</div>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button type="button" class="admin-btn admin-btn-sm admin-btn-primary" 
                                                    data-bs-toggle="modal" data-bs-target="#updateStockModal"
                                                    data-product-id="@item.ProductId" 
                                                    data-product-name="@item.ProductName"
                                                    data-current-stock="@item.CurrentStock"
                                                    title="Cập nhật tồn kho">
                                                <i data-lucide="edit"></i>
                                            </button>
                                            <a href="@Url.Action("EditProduct", "Seller", new { id = item.ProductId })" 
                                               class="admin-btn admin-btn-sm admin-btn-secondary"
                                               title="Chỉnh sửa sản phẩm">
                                                <i data-lucide="settings"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
        </div>
    }
    else
    {
        <div class="admin-empty-state">
            <div class="admin-empty-state-icon">
                <i data-lucide="package"></i>
            </div>
            <h3 class="admin-empty-state-title">Không có sản phẩm nào</h3>
            <p class="admin-empty-state-description">
                @if (!string.IsNullOrEmpty(Model.SearchTerm) || Model.Filter == "low_stock")
                {
                    @:Không tìm thấy sản phẩm nào với tiêu chí tìm kiếm hiện tại.
                }
                else
                {
                    @:Chưa có sản phẩm nào trong cửa hàng.
                }
            </p>
            <a href="@Url.Action("Create", "SellerProducts")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Thêm sản phẩm đầu tiên
            </a>
        </div>
    }
</div>

<!-- Update Stock Modal -->
<div class="modal fade" id="updateStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-lucide="package" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></i>
                    Cập nhật tồn kho
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStockForm">
                    <input type="hidden" id="modalProductId" />
                    <div class="mb-3">
                        <label class="admin-form-label">Sản phẩm</label>
                        <input type="text" class="admin-form-input" id="modalProductName" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="admin-form-label">Số lượng hiện tại</label>
                        <input type="number" class="admin-form-input" id="modalCurrentStock" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="modalNewStock" class="admin-form-label">Số lượng mới <span style="color: var(--admin-danger);">*</span></label>
                        <input type="number" class="admin-form-input" id="modalNewStock" min="0" required />
                    </div>
                    <div class="mb-3">
                        <label for="modalReason" class="admin-form-label">Lý do</label>
                        <textarea class="admin-form-input" id="modalReason" rows="3" placeholder="Nhập lý do thay đổi tồn kho..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="admin-btn admin-btn-primary" id="saveStockBtn">
                    <i data-lucide="save"></i>
                    Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            
            // Re-initialize icons after modal opens
            const modal = document.getElementById('updateStockModal');
            if (modal) {
                modal.addEventListener('shown.bs.modal', function() {
                    lucide.createIcons();
                });
            }
        });

        $(document).ready(function() {
            // Handle update stock modal
            $('#updateStockModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var productId = button.data('product-id');
                var productName = button.data('product-name');
                var currentStock = button.data('current-stock');

                $('#modalProductId').val(productId);
                $('#modalProductName').val(productName);
                $('#modalCurrentStock').val(currentStock);
                $('#modalNewStock').val(currentStock);
                $('#modalReason').val('');
            });

            // Handle save stock button
            $('#saveStockBtn').click(function() {
                var productId = $('#modalProductId').val();
                var newStock = $('#modalNewStock').val();
                var reason = $('#modalReason').val();

                if (!newStock || newStock < 0) {
                    showToast('error', 'Vui lòng nhập số lượng hợp lệ');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateStock", "Seller")',
                    type: 'POST',
                    data: {
                        productId: productId,
                        newStock: newStock,
                        reason: reason
                    },
                    success: function(response) {
                        if (response.success) {
                            // Update the display
                            $('[data-product-id="' + productId + '"]').text(response.newStock);
                            $('#updateStockModal').modal('hide');
                            
                            // Show success message
                            showToast('success', response.message || 'Cập nhật tồn kho thành công!');
                            
                            // Reload page to update stats
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            showToast('error', response.message || 'Có lỗi xảy ra!');
                        }
                    },
                    error: function() {
                        showToast('error', 'Có lỗi xảy ra khi cập nhật tồn kho');
                    }
                });
            });
        });

        // Toast notification helper
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            toast.style.cssText = 'position: fixed; top: 70px; right: 20px; z-index: 1050; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
}