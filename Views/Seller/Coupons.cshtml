@model JohnHenryFashionWeb.ViewModels.CouponManagementViewModel
@{
    ViewData["Title"] = "Quản lý mã giảm giá";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <h1 class="admin-page-title">
                <i data-lucide="ticket"></i>
                Quản lý mã giảm giá
            </h1>
            <a href="@Url.Action("CreateCoupon", "Seller")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Tạo mã giảm giá mới
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng mã giảm giá</h3>
                    <p class="value">@Model.Statistics.TotalCoupons</p>
                    <p class="change">Tất cả mã</p>
                </div>
                <div class="admin-stat-card-icon primary">
                    <i data-lucide="ticket"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đang hoạt động</h3>
                    <p class="value">@Model.Statistics.ActiveCoupons</p>
                    <p class="change">@((Model.Statistics.TotalCoupons > 0 ? (Model.Statistics.ActiveCoupons * 100.0 / Model.Statistics.TotalCoupons).ToString("F1") : "0"))% tổng số</p>
                </div>
                <div class="admin-stat-card-icon success">
                    <i data-lucide="check-circle"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Đã hết hạn</h3>
                    <p class="value">@Model.Statistics.ExpiredCoupons</p>
                    <p class="change">Không còn hiệu lực</p>
                </div>
                <div class="admin-stat-card-icon warning">
                    <i data-lucide="clock"></i>
                </div>
            </div>
        </div>

        <div class="admin-stat-card">
            <div class="admin-stat-card-content">
                <div class="admin-stat-card-info">
                    <h3>Tổng giảm giá</h3>
                    <p class="value">@Model.Statistics.TotalDiscountGiven.ToString("N0") đ</p>
                    <p class="change">Đã cho khách hàng</p>
                </div>
                <div class="admin-stat-card-icon info">
                    <i data-lucide="dollar-sign"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="admin-filters">
        <form method="get" action="@Url.Action("Coupons")">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="admin-form-label">Tìm kiếm</label>
                    <div class="admin-search-box" style="position: relative;">
                        <i data-lucide="search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--admin-text-secondary); pointer-events: none;"></i>
                        <input type="text" id="search" name="search" class="admin-form-input" placeholder="Mã hoặc tên giảm giá..." value="@Model.Search" style="padding-left: 3rem;" />
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="admin-form-label">Trạng thái</label>
                    <select class="admin-form-select" id="status" name="status">
                        <option value="" selected="@(string.IsNullOrEmpty(Model.Status))">Tất cả</option>
                        <option value="active" selected="@(Model.Status == "active")">Đang hoạt động</option>
                        <option value="expired" selected="@(Model.Status == "expired")">Đã hết hạn</option>
                        <option value="inactive" selected="@(Model.Status == "inactive")">Đã tắt</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%;">
                        <i data-lucide="search"></i>
                        Tìm kiếm
                    </button>
                </div>
                <div class="col-md-2">
                    <a href="@Url.Action("Coupons")" class="admin-btn admin-btn-secondary" style="width: 100%; display: inline-block; text-align: center;">
                        <i data-lucide="x"></i>
                        Xóa lọc
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Coupons List -->
    @if (Model.Coupons.Any())
    {
        <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Mã giảm giá</th>
                                <th>Tên</th>
                                <th>Loại</th>
                                <th>Giá trị</th>
                                <th>Điều kiện</th>
                                <th>Sử dụng</th>
                                <th>Hiệu lực</th>
                                <th>Trạng thái</th>
                                <th style="width: 120px;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var coupon in Model.Coupons)
                            {
                                <tr>
                                    <td>
                                        <code class="text-primary fw-semibold">@coupon.Code</code>
                                    </td>
                                    <td>@coupon.Name</td>
                                    <td>
                                        @if (coupon.Type == "percentage")
                                        {
                                            <span class="admin-badge admin-badge-info">
                                                <i data-lucide="percent" style="width: 12px; height: 12px;"></i>
                                                Phần trăm
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="admin-badge admin-badge-secondary">
                                                <i data-lucide="dollar-sign" style="width: 12px; height: 12px;"></i>
                                                Số tiền
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @if (coupon.Type == "percentage")
                                        {
                                            <span class="fw-semibold">@coupon.Value%</span>
                                        }
                                        else
                                        {
                                            <span class="fw-semibold">@coupon.Value.ToString("N0") đ</span>
                                        }
                                    </td>
                                    <td>
                                        @if (coupon.MinOrderAmount.HasValue)
                                        {
                                            <small>Tối thiểu: @coupon.MinOrderAmount.Value.ToString("N0") đ</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">Không có</small>
                                        }
                                    </td>
                                    <td>
                                        <span>@coupon.UsageCount</span>
                                        @if (coupon.UsageLimit.HasValue)
                                        {
                                            <span>/@coupon.UsageLimit</span>
                                        }
                                        else
                                        {
                                            <span>/∞</span>
                                        }
                                    </td>
                                    <td>
                                        @if (coupon.StartDate.HasValue)
                                        {
                                            <small>@coupon.StartDate.Value.ToString("dd/MM/yyyy")</small>
                                        }
                                        else
                                        {
                                            <small>-</small>
                                        }
                                        <br>
                                        @if (coupon.EndDate.HasValue)
                                        {
                                            <small>@coupon.EndDate.Value.ToString("dd/MM/yyyy")</small>
                                        }
                                        else
                                        {
                                            <small>∞</small>
                                        }
                                    </td>
                                    <td>
                                        @switch (coupon.Status)
                                        {
                                            case "Active":
                                                <span class="admin-badge admin-badge-success">
                                                    <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                                                    Đang hoạt động
                                                </span>
                                                break;
                                            case "Expired":
                                                <span class="admin-badge admin-badge-danger">
                                                    <i data-lucide="x-circle" style="width: 12px; height: 12px;"></i>
                                                    Hết hạn
                                                </span>
                                                break;
                                            case "Scheduled":
                                                <span class="admin-badge admin-badge-warning">
                                                    <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                                                    Chờ kích hoạt
                                                </span>
                                                break;
                                            case "Limit Reached":
                                                <span class="admin-badge admin-badge-secondary">
                                                    <i data-lucide="alert-circle" style="width: 12px; height: 12px;"></i>
                                                    Đã đạt giới hạn
                                                </span>
                                                break;
                                            case "Inactive":
                                                <span class="admin-badge admin-badge-secondary">Đã tắt</span>
                                                break;
                                            default:
                                                <span class="admin-badge admin-badge-secondary">@coupon.Status</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem; white-space: nowrap;">
                                            <a href="@Url.Action("EditCoupon", new { id = coupon.Id })" class="admin-btn admin-btn-sm admin-btn-primary" title="Chỉnh sửa">
                                                <i data-lucide="edit"></i>
                                            </a>
                                            <button class="admin-btn admin-btn-sm admin-btn-danger delete-coupon" data-id="@coupon.Id" title="Xóa">
                                                <i data-lucide="trash-2"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
        </div>

        <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <div class="admin-pagination">
                        @if (Model.CurrentPage > 1)
                        {
                            <a href="@Url.Action("Coupons", new { page = Model.CurrentPage - 1, search = Model.Search, status = Model.Status })" 
                               class="admin-pagination-btn">
                                <i data-lucide="chevron-left"></i>
                                Trước
                            </a>
                        }
                        else
                        {
                            <button class="admin-pagination-btn" disabled>
                                <i data-lucide="chevron-left"></i>
                                Trước
                            </button>
                        }

                        @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                        {
                            <a href="@Url.Action("Coupons", new { page = i, search = Model.Search, status = Model.Status })" 
                               class="admin-pagination-btn @(i == Model.CurrentPage ? "active" : "")">@i</a>
                        }

                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <a href="@Url.Action("Coupons", new { page = Model.CurrentPage + 1, search = Model.Search, status = Model.Status })" 
                               class="admin-pagination-btn">
                                Sau
                                <i data-lucide="chevron-right"></i>
                            </a>
                        }
                        else
                        {
                            <button class="admin-pagination-btn" disabled>
                                Sau
                                <i data-lucide="chevron-right"></i>
                            </button>
                        }
                    </div>

                    <div class="admin-text-center" style="margin-top: var(--spacing-md); color: var(--admin-text-light); font-size: 0.875rem;">
                        Trang @Model.CurrentPage / @Model.TotalPages (Tổng @Model.TotalCount mã giảm giá)
                    </div>
                }
    }
    else
    {
        <div class="admin-empty-state">
            <div class="admin-empty-state-icon">
                <i data-lucide="ticket"></i>
            </div>
            <h3 class="admin-empty-state-title">Chưa có mã giảm giá nào</h3>
            <p class="admin-empty-state-description">Tạo mã giảm giá đầu tiên để bắt đầu khuyến mãi!</p>
            <a href="@Url.Action("CreateCoupon", "Seller")" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Tạo mã giảm giá đầu tiên
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });

        $(document).ready(function() {
            $('.delete-coupon').click(function() {
                var couponId = $(this).data('id');
                var row = $(this).closest('tr');
                
                if (confirm('Bạn có chắc chắn muốn xóa mã giảm giá này?')) {
                    $.post('@Url.Action("DeleteCoupon")', { id: couponId }, function(data) {
                        if (data.success) {
                            row.fadeOut();
                            showToast('success', 'Xóa mã giảm giá thành công!');
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            showToast('error', data.message || 'Có lỗi xảy ra khi xóa mã giảm giá!');
                        }
                    }).fail(function() {
                        showToast('error', 'Có lỗi xảy ra khi xóa mã giảm giá!');
                    });
                }
            });
        });

        // Toast notification helper
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            toast.style.cssText = 'position: fixed; top: 70px; right: 20px; z-index: 1050; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
}