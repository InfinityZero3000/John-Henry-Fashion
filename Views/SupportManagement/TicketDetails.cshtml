@model JohnHenryFashionWeb.Models.SupportTicket
@{
    ViewData["Title"] = $"Ticket #{Model.TicketNumber}";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = $"<li class=\"breadcrumb-item\"><a href=\"{Url.Action("Index", "SupportManagement")}\">Support</a></li><li class=\"breadcrumb-item active\">#{Model.TicketNumber}</li>";
    
    var admins = ViewBag.Admins as List<dynamic>;
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="ticket"></i>
                    Ticket #@Model.TicketNumber
                </h1>
                <p class="admin-page-description" style="margin-top: 0.5rem;">@Model.Subject</p>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                @{
                    var normalizedStatus = (Model.Status ?? string.Empty).ToLower();
                    var statusClass = normalizedStatus switch
                    {
                        "open" => "warning",
                        "in_progress" => "info",
                        "inprogress" => "info",
                        "resolved" => "success",
                        "closed" => "secondary",
                        _ => "secondary"
                    };
                    var statusText = normalizedStatus switch
                    {
                        "open" => "Chờ xử lý",
                        "in_progress" => "Đang xử lý",
                        "inprogress" => "Đang xử lý",
                        "resolved" => "Đã giải quyết",
                        "closed" => "Đã đóng",
                        _ => "Không xác định"
                    };
                    var priorityClass = (Model.Priority ?? string.Empty).ToLower() switch
                    {
                        "urgent" => "danger",
                        "high" => "danger",
                        "medium" => "warning",
                        "low" => "info",
                        _ => "secondary"
                    };
                }
                <span class="admin-badge admin-badge-@priorityClass">
                    <i data-lucide="flag" style="width:12px;height:12px"></i> @Model.Priority
                </span>
                <span class="admin-badge admin-badge-@statusClass">
                    <i data-lucide="circle" style="width:12px;height:12px"></i> @statusText
                </span>
                <a href="@Url.Action("Index", "SupportManagement")" class="admin-btn admin-btn-secondary">
                    <i data-lucide="arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="admin-alert admin-alert-danger">
            <i data-lucide="alert-circle"></i>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Main Content Grid -->
    <div style="display: grid; grid-template-columns: 1fr 380px; gap: var(--spacing-lg); margin-top: var(--spacing-lg);">
        <!-- Left Column - Ticket Details & Description -->
        <div>
            <!-- Ticket Description -->
            <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                <div class="admin-card-header" style="display: flex; align-items: center; justify-content: space-between;">
                    <h3 class="admin-card-title" style="margin: 0;">
                        <i data-lucide="file-text" style="width: 18px; height: 18px;"></i>
                        Chi tiết yêu cầu
                    </h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="editTicket()">
                        <i data-lucide="edit-2"></i>
                        Chỉnh sửa
                    </button>
                </div>
                <div class="admin-card-body">
                    <div style="white-space: pre-wrap; line-height: 1.6; color: var(--admin-text); font-size: 0.9375rem;">
                        @Model.Description
                    </div>

                    @if (!string.IsNullOrEmpty(Model.AttachmentUrls))
                    {
                        <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--admin-border);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: var(--spacing-md); color: var(--admin-text); font-size: 0.875rem; font-weight: 600;">
                                <i data-lucide="paperclip" style="width:16px;height:16px"></i>
                                Tệp đính kèm
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                @foreach (var url in Model.AttachmentUrls.Split(','))
                                {
                                    var fileName = url.Split('/').LastOrDefault() ?? "Attachment";
                                    <a href="@url" target="_blank" class="admin-btn admin-btn-sm admin-btn-secondary">
                                        <i data-lucide="download"></i>
                                        @fileName
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Conversation / Replies -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title" style="margin: 0;">
                        <i data-lucide="message-circle" style="width: 18px; height: 18px;"></i>
                        Lịch sử phản hồi
                        @if (Model.Replies != null && Model.Replies.Any())
                        {
                            <span class="admin-badge admin-badge-info" style="margin-left: 0.5rem;">@Model.Replies.Count</span>
                        }
                    </h3>
                </div>
                <div class="admin-card-body">
                    @if (Model.Replies != null && Model.Replies.Any())
                    {
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                            @foreach (var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                            {
                                <div style="background: @(reply.IsInternal ? "var(--status-warning-bg)" : "var(--admin-bg-secondary)"); 
                                            padding: var(--spacing-lg); 
                                            border-radius: var(--radius-md); 
                                            border-left: 3px solid @(reply.IsInternal ? "var(--status-warning)" : "var(--admin-primary)");">
                                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                            <div style="width: 36px; height: 36px; border-radius: 50%; background: @(reply.IsInternal ? "var(--status-warning)" : "var(--admin-primary)"); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                                @(reply.User?.FullName?.Substring(0, 1).ToUpper() ?? "?")
                                            </div>
                                            <div>
                                                <div style="color: var(--admin-text); font-weight: 500; font-size: 0.875rem;">
                                                    @(reply.User?.FullName ?? reply.User?.Email ?? "Unknown")
                                                </div>
                                                @if (reply.IsInternal)
                                                {
                                                    <span class="admin-badge admin-badge-warning" style="font-size: 0.75rem; margin-top: 0.25rem;">
                                                        <i data-lucide="lock" style="width:10px;height:10px"></i> Internal
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: var(--admin-text-light); font-size: 0.75rem;">@reply.CreatedAt.ToString("dd/MM/yyyy")</div>
                                            <div style="color: var(--admin-text-muted); font-size: 0.75rem;">@reply.CreatedAt.ToString("HH:mm")</div>
                                        </div>
                                    </div>
                                    <div style="color: var(--admin-text); white-space: pre-wrap; line-height: 1.6; font-size: 0.875rem; margin-left: 44px;">@reply.Message</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div style="text-align: center; padding: 3rem 1rem; color: var(--admin-text-muted);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin-bottom: var(--spacing-md); opacity: 0.3;"></i>
                            <p style="margin: 0; font-size: 0.875rem;">Chưa có phản hồi nào</p>
                        </div>
                    }

                    <!-- Reply Form -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--admin-border); background: var(--admin-bg); padding: 1.5rem; border-radius: 8px; margin-left: -1rem; margin-right: -1rem; margin-bottom: -1rem;">
                        <h4 style="margin-bovar(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--admin-border);">
                        <h4 style="margin-bottom: var(--spacing-md); font-size: 0.9375rem; display: flex; align-items: center; gap: 0.5rem; color: var(--admin-text); font-weight: 600;">
                            <i data-lucide="send" style="width:16px;height:16px"></i>
                            Trả lời ticket
                        </h4>
                        <form method="post" asp-action="ReplyTicket" asp-route-id="@Model.Id">
                            @Html.AntiForgeryToken()
                            <div class="admin-form-group">
                                <label class="admin-form-label">Nội dung phản hồi</label>
                                <textarea name="message" class="admin-form-control" rows="5" 
                                          placeholder="Nhập nội dung trả lời cho khách hàng..." required></textarea>
                            </div>
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--status-warning-bg); border-radius: var(--radius-sm); border: 1px solid var(--status-warning);">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                    <input type="checkbox" name="isInternal" style="width: 16px; height: 16px; cursor: pointer;">
                                    <span style="color: var(--admin-text); font-size: 0.875rem; display: flex; align-items: center; gap: 0.375rem
                                        Internal Note (chỉ admin xem được)
                                    </span>
                                </label>
                            </div>
                            <button type="submit" class="admin-btn admin-btn-primary">
                                <i data-lucide="send"></i>
                                Gửi phản hồi
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Info & Actions -->
        <div>
            <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                <div class="admin-card-header">
                    <h3 class="admin-card-title" style="margin: 0;">
                        <i data-lucide="info" style="width: 16px; height: 16px;"></i>
                        Thông tin ticket
                    </h3>
                </div>
                <div class="admin-card-body" style="padding: 0;">
                    <table class="admin-info-table">
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <i data-lucide="user" style="width: 14px; height: 14px;"></i>
                                    <span>Khách hàng</span>
                                </div>
                            </td>
                            <td>
                                @if (Model.User != null)
                                {
                                    <div style="font-weight: 500;">@Model.User.FullName</div>
                                    <div style="color: var(--admin-text-muted); font-size: 0.8125rem; margin-top: 0.125rem;">@Model.User.Email</div>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-secondary">N/A</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <i data-lucide="tag" style="width: 14px; height: 14px;"></i>
                                    <span>Danh mục</span>
                                </div>
                            </td>
                            <td>
                                @{
                                    var categoryBadge = Model.Category?.ToLower() switch
                                    {
                                        "order" => "info",
                                        "product" => "primary",
                                        "payment" => "success",
                                        "technical" => "warning",
                                        _ => "secondary"
                                    };
                                }
                                <span class="admin-badge admin-badge-@categoryBadge">@Model.Category</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <i data-lucide="user-check" style="width: 14px; height: 14px;"></i>
                                    <span>Người phụ trách</span>
                                </div>
                            </td>
                            <td>
                                @if (Model.AssignedAdmin != null)
                                {
                                    <div style="font-weight: 500;">@Model.AssignedAdmin.FullName</div>
                                    <div style="color: var(--admin-text-muted); font-size: 0.8125rem; margin-top: 0.125rem;">@Model.AssignedAdmin.Email</div>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-secondary">Chưa phân công</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                                    <span>Ngày tạo</span>
                                </div>
                            </td>
                            <td>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        </tr>
                        @if (Model.ResolvedAt.HasValue)
                        {
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                                        <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                                        <span>Đã giải quyết</span>
                                    </div>
                                </td>
                                <td style="color: var(--status-success);">@Model.ResolvedAt.Value.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                        @if (Model.ClosedAt.HasValue)
                        {
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                                        <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                                        <span>Đã đóng</span>
                                    </div>
                                </td>
                                <td style="color: var(--admin-text-muted);">@Model.ClosedAt.Value.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                        @if (Model.RelatedOrderId.HasValue && Model.RelatedOrder != null)
                        {
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                                        <i data-lucide="shopping-bag" style="width: 14px; height: 14px;"></i>
                                        <span>Đơn hàng</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="@Url.Action("OrderDetails", "Admin", new { id = Model.RelatedOrderId })" style="color: var(--admin-primary); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;">
                                        #@Model.RelatedOrder.OrderNumber
                                        <i data-lucide="external-link" style="width: 12px; height: 12px;"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                        @if (Model.RelatedProductId.HasValue && Model.RelatedProduct != null)
                        {
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                                        <i data-lucide="box" style="width: 14px; height: 14px;"></i>
                                        <span>Sản phẩm</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="@Url.Action("Edit", "Products", new { id = Model.RelatedProductId })" style="color: var(--admin-primary); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;">
                                        @Model.RelatedProduct.Name
                                        <i data-lucide="external-link" style="width: 12px; height: 12px;"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>

            @if (Model.AssignedTo == null)
            {
                <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title" style="margin: 0;">
                            <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i>
                            Phân công ticket
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <form method="post" asp-action="AssignTicket" asp-route-id="@Model.Id">
                            @Html.AntiForgeryToken()
                            <div class="admin-form-group">
                                <label class="admin-form-label">Chọn Admin</label>
                                <select name="adminId" class="admin-form-control" required>
                                    <option value="" disabled selected>-- Chọn Admin --</option>
                                    @if (admins != null)
                                    {
                                        foreach (var admin in admins)
                                        {
                                            <option value="@admin.Id">@admin.Email</option>
                                        }
                                    }
                                </select>
                            </div>
                            <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%; justify-content: center;">
                                <i data-lucide="check"></i>
                                Gán cho Admin
                            </button>
                        </form>
                    </div>
                </div>
            }

            <div class="admin-card" style="margin-bottom: var(--spacing-lg);">
                <div class="admin-card-header">
                    <h3 class="admin-card-title" style="margin: 0;">
                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                        Cập nhật trạng thái
                    </h3>
                </div>
                <div class="admin-card-body">
                    <form method="post" asp-action="UpdateTicketStatus" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="admin-form-group">
                            <label class="admin-form-label">Trạng thái</label>
                            <select name="status" class="admin-form-control" required>
                                <option value="Open" selected="@(Model.Status == "Open")">Mở</option>
                                <option value="InProgress" selected="@(Model.Status == "InProgress")">Đang xử lý</option>
                                <option value="Resolved" selected="@(Model.Status == "Resolved")">Đã giải quyết</option>
                                <option value="Closed" selected="@(Model.Status == "Closed")">Đã đóng</option>
                            </select>
                        </div>
                        <button type="submit" class="admin-btn admin-btn-success" style="width: 100%; justify-content: center;">
                            <i data-lucide="save"></i>
                            Cập nhật
                        </button>
                    </form>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title" style="margin: 0;">
                        <i data-lucide="flag" style="width: 16px; height: 16px;"></i>
                        Cập nhật độ ưu tiên
                    </h3>
                </div>
                <div class="admin-card-body">
                    <form method="post" asp-action="UpdateTicketPriority" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="admin-form-group">
                            <label class="admin-form-label">Độ ưu tiên</label>
                            <select name="priority" class="admin-form-control" required>
                                <option value="Low" selected="@(Model.Priority == "Low")">Thấp</option>
                                <option value="Medium" selected="@(Model.Priority == "Medium")">Trung bình</option>
                                <option value="High" selected="@(Model.Priority == "High")">Cao</option>
                                <option value="Urgent" selected="@(Model.Priority == "Urgent")">Khẩn cấp</option>
                            </select>
                        </div>
                        <button type="submit" class="admin-btn admin-btn-warning" style="width: 100%; justify-content: center;">
                            <i data-lucide="save"></i>
                            Cập nhật
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ticket Modal -->
<div class="modal fade" id="editTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-lucide="edit-2"></i>
                    Chỉnh sửa Ticket #@Model.TicketNumber
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="EditTicket" asp-route-id="@Model.Id">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="type" style="width:16px;height:16px"></i>
                            Tiêu đề
                        </label>
                        <input type="text" class="admin-form-control" name="subject" 
                               value="@Model.Subject" required maxlength="500">
                    </div>
                    
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="tag" style="width:16px;height:16px"></i>
                            Danh mục
                        </label>
                        <select class="admin-form-control" name="category" required>
                            <option value="general" selected="@(Model.Category == "general")">Chung</option>
                            <option value="order" selected="@(Model.Category == "order")">Đơn hàng</option>
                            <option value="product" selected="@(Model.Category == "product")">Sản phẩm</option>
                            <option value="payment" selected="@(Model.Category == "payment")">Thanh toán</option>
                            <option value="technical" selected="@(Model.Category == "technical")">Kỹ thuật</option>
                            <option value="account" selected="@(Model.Category == "account")">Tài khoản</option>
                            <option value="other" selected="@(Model.Category == "other")">Khác</option>
                        </select>
                    </div>
                    
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="align-left" style="width:16px;height:16px"></i>
                            Mô tả chi tiết
                        </label>
                        <textarea class="admin-form-control" name="description" rows="8" required>@Model.Description</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">
                        <i data-lucide="x"></i>
                        Đóng
                    </button>
                    <button type="submit" class="admin-btn admin-btn-primary">
                        <i data-lucide="save"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Edit ticket function
        function editTicket() {
            const modal = new bootstrap.Modal(document.getElementById('editTicketModal'));
            modal.show();
        }

        // Auto-hide success/error messages
        setTimeout(function() {
            document.querySelectorAll('.admin-alert').forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);

        // Reinitialize icons after modal shown
        document.getElementById('editTicketModal')?.addEventListener('shown.bs.modal', function() {
            lucide.createIcons();
        });
    </script>
}

