@model JohnHenryFashionWeb.Models.SupportTicket
@{
    ViewData["Title"] = $"Ticket #{Model.TicketNumber}";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = $"<li class=\"breadcrumb-item\"><a href=\"{Url.Action("Index", "SupportManagement")}\">Support</a></li><li class=\"breadcrumb-item active\">#{Model.TicketNumber}</li>";
    
    var admins = ViewBag.Admins as List<dynamic>;
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="ticket"></i>
                    Ticket #@Model.TicketNumber
                </h1>
                <p class="admin-page-subtitle">@Model.Subject</p>
            </div>
            <div class="admin-flex admin-gap-sm">
                @{
                    var normalizedStatus = (Model.Status ?? string.Empty).ToLower();
                    var statusClass = normalizedStatus switch
                    {
                        "open" => "warning",
                        "in_progress" => "info",
                        "inprogress" => "info",
                        "resolved" => "success",
                        "closed" => "secondary",
                        _ => "secondary"
                    };
                    var statusText = normalizedStatus switch
                    {
                        "open" => "Chờ xử lý",
                        "in_progress" => "Đang xử lý",
                        "inprogress" => "Đang xử lý",
                        "resolved" => "Đã giải quyết",
                        "closed" => "Đã đóng",
                        _ => "Không xác định"
                    };
                    var priorityClass = (Model.Priority ?? string.Empty).ToLower() switch
                    {
                        "urgent" => "danger",
                        "high" => "danger",
                        "medium" => "warning",
                        "low" => "info",
                        _ => "secondary"
                    };
                }
                <span class="admin-badge admin-badge-@priorityClass">
                    <i data-lucide="flag" style="width:12px;height:12px"></i> @Model.Priority
                </span>
                <span class="admin-badge admin-badge-@statusClass">
                    <i data-lucide="circle" style="width:12px;height:12px"></i> @statusText
                </span>
                <a href="@Url.Action("Index", "SupportManagement")" class="admin-btn admin-btn-secondary">
                    <i data-lucide="arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="admin-alert admin-alert-danger">
            <i data-lucide="alert-circle"></i>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Main Content Grid -->
    <div class="row" style="margin-top: 1.5rem;">
        <!-- Left Column - Ticket Details & Description -->
        <div class="col-lg-8">
            <!-- Ticket Description -->
            <div class="admin-card" style="margin-bottom: 1.5rem;">
                <div class="admin-card-header admin-flex-between">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                        Chi tiết yêu cầu
                    </h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="editTicket()">
                        <i data-lucide="edit-2"></i>
                        Chỉnh sửa
                    </button>
                </div>
                <div class="admin-card-body" style="padding: 1.5rem;">
                    <div style="white-space: pre-wrap; line-height: 1.8; color: var(--admin-text); font-size: 0.9375rem;">
                        @Model.Description
                    </div>

                    @if (!string.IsNullOrEmpty(Model.AttachmentUrls))
                    {
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--admin-border);">
                            <strong style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: var(--admin-text);">
                                <i data-lucide="paperclip" style="width:16px;height:16px"></i>
                                Tệp đính kèm
                            </strong>
                            <div class="admin-flex admin-gap-sm" style="flex-wrap: wrap;">
                                @foreach (var url in Model.AttachmentUrls.Split(','))
                                {
                                    var fileName = url.Split('/').LastOrDefault() ?? "Attachment";
                                    <a href="@url" target="_blank" class="admin-btn admin-btn-sm admin-btn-secondary">
                                        <i data-lucide="download"></i>
                                        @fileName
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Conversation / Replies -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="message-circle" style="width: 20px; height: 20px;"></i>
                        Lịch sử phản hồi
                        @if (Model.Replies != null && Model.Replies.Any())
                        {
                            <span class="admin-badge admin-badge-info" style="margin-left:0.5rem; font-size: 0.75rem;">@Model.Replies.Count</span>
                        }
                    </h3>
                </div>
                <div class="admin-card-body" style="padding: 1.5rem;">
                    @if (Model.Replies != null && Model.Replies.Any())
                    {
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            @foreach (var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                            {
                                <div style="background: @(reply.IsInternal ? "#fff3cd" : "#f8f9fa"); 
                                            padding: 1.25rem; 
                                            border-radius: 12px; 
                                            border-left: 4px solid @(reply.IsInternal ? "#ffc107" : "var(--admin-primary)");
                                            box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                    <div class="admin-flex-between" style="margin-bottom: 0.75rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 36px; height: 36px; border-radius: 50%; background: @(reply.IsInternal ? "#ffc107" : "var(--admin-primary)"); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                                @(reply.User?.FullName?.Substring(0, 1).ToUpper() ?? "?")
                                            </div>
                                            <div>
                                                <strong style="color: var(--admin-text); display: block; font-size: 0.9375rem;">
                                                    @(reply.User?.FullName ?? reply.User?.Email ?? "Unknown")
                                                </strong>
                                                @if (reply.IsInternal)
                                                {
                                                    <span class="admin-badge admin-badge-warning" style="font-size: 0.6875rem; padding: 0.125rem 0.5rem;">
                                                        <i data-lucide="lock" style="width:10px;height:10px"></i> Internal
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                        <small style="color: var(--admin-text-light); font-size: 0.8125rem;">@reply.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <div style="color: var(--admin-text); white-space: pre-wrap; line-height: 1.6; font-size: 0.9375rem; margin-left: 46px;">@reply.Message</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="admin-text-center" style="padding: 3rem; color: var(--admin-text-light);">
                            <i data-lucide="inbox" style="width: 56px; height: 56px; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="margin: 0; font-size: 0.9375rem;">Chưa có phản hồi nào</p>
                        </div>
                    }

                    <!-- Reply Form -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--admin-border);">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--admin-text);">
                            <i data-lucide="send" style="width:18px;height:18px"></i>
                            Trả lời ticket
                        </h4>
                        <form method="post" asp-action="ReplyTicket" asp-route-id="@Model.Id">
                            @Html.AntiForgeryToken()
                            <div class="admin-form-group" style="margin-bottom: 1rem;">
                                <label style="margin-bottom: 0.5rem; font-weight: 500; color: var(--admin-text);">Nội dung phản hồi</label>
                                <textarea name="message" class="admin-form-control" rows="5" 
                                          placeholder="Nhập nội dung trả lời..." required
                                          style="resize: vertical; font-size: 0.9375rem;"></textarea>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                    <input type="checkbox" name="isInternal" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: var(--admin-text); font-size: 0.9375rem; display: flex; align-items: center; gap: 0.25rem;">
                                        <i data-lucide="lock" style="width:14px;height:14px"></i>
                                        Internal Note (chỉ admin xem được)
                                    </span>
                                </label>
                            </div>
                            <button type="submit" class="admin-btn admin-btn-primary" style="padding: 0.625rem 1.5rem;">
                                <i data-lucide="send"></i>
                                Gửi phản hồi
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Info & Actions -->
        <div class="col-lg-4">
            <div class="admin-card admin-mb-lg">
                <div class="admin-card-header">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                        <i data-lucide="info"></i>
                        Thông tin ticket
                    </h3>
                </div>
                <div class="admin-card-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                <i data-lucide="user" style="width: 14px; height: 14px;"></i>
                                Khách hàng
                            </div>
                            <div>
                                @if (Model.User != null)
                                {
                                    <div style="font-weight: 600; color: var(--admin-text);">@Model.User.FullName</div>
                                    <div style="font-size: 0.875rem; color: var(--admin-text-light);">@Model.User.Email</div>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-secondary">N/A</span>
                                }
                            </div>
                        </div>

                        <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                <i data-lucide="tag" style="width: 14px; height: 14px;"></i>
                                Danh mục
                            </div>
                            <div>
                                @{
                                    var categoryBadge = Model.Category?.ToLower() switch
                                    {
                                        "order" => "info",
                                        "product" => "primary",
                                        "payment" => "success",
                                        "technical" => "warning",
                                        _ => "secondary"
                                    };
                                }
                                <span class="admin-badge admin-badge-@categoryBadge">@Model.Category</span>
                            </div>
                        </div>

                        <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                <i data-lucide="user-check" style="width: 14px; height: 14px;"></i>
                                Người phụ trách
                            </div>
                            <div>
                                @if (Model.AssignedAdmin != null)
                                {
                                    <div style="font-weight: 600; color: var(--admin-text);">@Model.AssignedAdmin.FullName</div>
                                    <div style="font-size: 0.875rem; color: var(--admin-text-light);">@Model.AssignedAdmin.Email</div>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-secondary">Chưa phân công</span>
                                }
                            </div>
                        </div>

                        <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                                Ngày tạo
                            </div>
                            <div style="font-size: 0.95rem; color: var(--admin-text);">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>

                        @if (Model.ResolvedAt.HasValue)
                        {
                            <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                    <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                                    Đã giải quyết
                                </div>
                                <div style="font-size: 0.95rem; color: var(--admin-text);">@Model.ResolvedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        }

                        @if (Model.ClosedAt.HasValue)
                        {
                            <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                    <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                                    Đã đóng
                                </div>
                                <div style="font-size: 0.95rem; color: var(--admin-text);">@Model.ClosedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        }

                        @if (Model.RelatedOrderId.HasValue && Model.RelatedOrder != null)
                        {
                            <div style="padding-bottom: 0.75rem; border-bottom: 1px solid var(--admin-border);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                    <i data-lucide="shopping-bag" style="width: 14px; height: 14px;"></i>
                                    Đơn hàng liên quan
                                </div>
                                <a href="@Url.Action("OrderDetails", "Admin", new { id = Model.RelatedOrderId })" style="color: var(--admin-primary); font-weight: 600; text-decoration: none;">
                                    #@Model.RelatedOrder.OrderNumber
                                </a>
                            </div>
                        }

                        @if (Model.RelatedProductId.HasValue && Model.RelatedProduct != null)
                        {
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; color: var(--admin-text-light); font-size: 0.85rem; font-weight: 600;">
                                    <i data-lucide="box" style="width: 14px; height: 14px;"></i>
                                    Sản phẩm liên quan
                                </div>
                                <a href="@Url.Action("Edit", "AdminProducts", new { id = Model.RelatedProductId })" style="color: var(--admin-primary); font-weight: 600; text-decoration: none;">
                                    @Model.RelatedProduct.Name
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if (Model.AssignedTo == null)
            {
                <div class="admin-card admin-mb-lg">
                    <div class="admin-card-header">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                            <i data-lucide="user-plus"></i>
                            Phân công ticket
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <form method="post" asp-action="AssignTicket" asp-route-id="@Model.Id">
                            @Html.AntiForgeryToken()
                            <div class="admin-form-group" style="margin-bottom: 1rem;">
                                <label>Chọn Admin</label>
                                <select name="adminId" class="admin-form-control" required>
                                    <option value="">-- Chọn Admin --</option>
                                    @if (admins != null)
                                    {
                                        foreach (var admin in admins)
                                        {
                                            <option value="@admin.Id">@admin.Email</option>
                                        }
                                    }
                                </select>
                            </div>
                            <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%; justify-content: center;">
                                <i data-lucide="check"></i>
                                Gán cho Admin
                            </button>
                        </form>
                    </div>
                </div>
            }

            <div class="admin-card admin-mb-lg">
                <div class="admin-card-header">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                        <i data-lucide="refresh-cw"></i>
                        Cập nhật trạng thái
                    </h3>
                </div>
                <div class="admin-card-body">
                    <form method="post" asp-action="UpdateTicketStatus" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="admin-form-group">
                            <label>Trạng thái</label>
                            <select name="status" class="admin-form-control" required>
                                <option value="Open" selected="@(Model.Status == "Open")">Mở</option>
                                <option value="InProgress" selected="@(Model.Status == "InProgress")">Đang xử lý</option>
                                <option value="Resolved" selected="@(Model.Status == "Resolved")">Đã giải quyết</option>
                                <option value="Closed" selected="@(Model.Status == "Closed")">Đã đóng</option>
                            </select>
                        </div>
                        <button type="submit" class="admin-btn admin-btn-success" style="width: 100%; justify-content: center;">
                            <i data-lucide="save"></i>
                            Cập nhật Status
                        </button>
                    </form>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                        <i data-lucide="flag"></i>
                        Cập nhật độ ưu tiên
                    </h3>
                </div>
                <div class="admin-card-body">
                    <form method="post" asp-action="UpdateTicketPriority" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="admin-form-group">
                            <label>Độ ưu tiên</label>
                            <select name="priority" class="admin-form-control" required>
                                <option value="Low" selected="@(Model.Priority == "Low")">Thấp</option>
                                <option value="Medium" selected="@(Model.Priority == "Medium")">Trung bình</option>
                                <option value="High" selected="@(Model.Priority == "High")">Cao</option>
                                <option value="Urgent" selected="@(Model.Priority == "Urgent")">Khẩn cấp</option>
                            </select>
                        </div>
                        <button type="submit" class="admin-btn admin-btn-warning" style="width: 100%; justify-content: center;">
                            <i data-lucide="save"></i>
                            Cập nhật Priority
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ticket Modal -->
<div class="modal fade" id="editTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-lucide="edit-2"></i>
                    Chỉnh sửa Ticket #@Model.TicketNumber
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="EditTicket" asp-route-id="@Model.Id">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="type" style="width:16px;height:16px"></i>
                            Tiêu đề
                        </label>
                        <input type="text" class="admin-form-control" name="subject" 
                               value="@Model.Subject" required maxlength="500">
                    </div>
                    
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="tag" style="width:16px;height:16px"></i>
                            Danh mục
                        </label>
                        <select class="admin-form-control" name="category" required>
                            <option value="general" selected="@(Model.Category == "general")">Chung</option>
                            <option value="order" selected="@(Model.Category == "order")">Đơn hàng</option>
                            <option value="product" selected="@(Model.Category == "product")">Sản phẩm</option>
                            <option value="payment" selected="@(Model.Category == "payment")">Thanh toán</option>
                            <option value="technical" selected="@(Model.Category == "technical")">Kỹ thuật</option>
                            <option value="account" selected="@(Model.Category == "account")">Tài khoản</option>
                            <option value="other" selected="@(Model.Category == "other")">Khác</option>
                        </select>
                    </div>
                    
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="align-left" style="width:16px;height:16px"></i>
                            Mô tả chi tiết
                        </label>
                        <textarea class="admin-form-control" name="description" rows="8" required>@Model.Description</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">
                        <i data-lucide="x"></i>
                        Đóng
                    </button>
                    <button type="submit" class="admin-btn admin-btn-primary">
                        <i data-lucide="save"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Edit ticket function
        function editTicket() {
            const modal = new bootstrap.Modal(document.getElementById('editTicketModal'));
            modal.show();
        }

        // Auto-hide success/error messages
        setTimeout(function() {
            document.querySelectorAll('.admin-alert').forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);

        // Reinitialize icons after modal shown
        document.getElementById('editTicketModal')?.addEventListener('shown.bs.modal', function() {
            lucide.createIcons();
        });
    </script>
}

