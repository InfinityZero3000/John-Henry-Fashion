@model JohnHenryFashionWeb.Models.SupportTicket
@{
    ViewData["Title"] = $"Ticket #{Model.TicketNumber}";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Breadcrumb"] = $"<li class=\"breadcrumb-item\"><a href=\"{Url.Action("Index", "SupportManagement")}\">Support</a></li><li class=\"breadcrumb-item active\">#{Model.TicketNumber}</li>";
    
    var admins = ViewBag.Admins as List<dynamic>;
}

<div class="admin-content">
    <!-- Page Header -->
    <div class="admin-page-header">
        <div class="admin-flex-between">
            <div>
                <h1 class="admin-page-title">
                    <i data-lucide="ticket"></i>
                    Ticket #@Model.TicketNumber
                </h1>
                <p class="admin-page-description">@Model.Subject</p>
            </div>
            <div class="admin-header-actions">
                @{
                    var normalizedStatus = (Model.Status ?? string.Empty).ToLower();
                    var statusClass = normalizedStatus switch
                    {
                        "open" => "warning",
                        "in_progress" => "info",
                        "inprogress" => "info",
                        "resolved" => "success",
                        "closed" => "secondary",
                        _ => "secondary"
                    };
                    var statusText = normalizedStatus switch
                    {
                        "open" => "Chờ xử lý",
                        "in_progress" => "Đang xử lý",
                        "inprogress" => "Đang xử lý",
                        "resolved" => "Đã giải quyết",
                        "closed" => "Đã đóng",
                        _ => "Không xác định"
                    };
                    var priorityClass = (Model.Priority ?? string.Empty).ToLower() switch
                    {
                        "urgent" => "danger",
                        "high" => "danger",
                        "medium" => "warning",
                        "low" => "info",
                        _ => "secondary"
                    };
                }
                <span class="admin-badge admin-badge-@priorityClass">
                    <i data-lucide="flag" class="icon-xs"></i> @Model.Priority
                </span>
                <span class="admin-badge admin-badge-@statusClass">
                    <i data-lucide="circle" class="icon-xs"></i> @statusText
                </span>
                <a href="@Url.Action("Index", "SupportManagement")" class="admin-btn admin-btn-secondary">
                    <i data-lucide="arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="admin-alert admin-alert-success">
            <i data-lucide="check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="admin-alert admin-alert-danger">
            <i data-lucide="alert-circle"></i>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Main Content Grid -->
    <div class="ticket-grid">
        <!-- Left Column - Ticket Details & Description -->
        <div>
            <!-- Ticket Description -->
            <div class="admin-card admin-mb-lg">
                <div class="admin-card-header admin-flex-between">
                    <h3 class="admin-card-title">
                        <i data-lucide="file-text" class="icon-sm"></i>
                        Chi tiết yêu cầu
                    </h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="editTicket()">
                        <i data-lucide="edit-2"></i>
                        Chỉnh sửa
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="ticket-description">
                        @Model.Description
                    </div>

                    @if (!string.IsNullOrEmpty(Model.AttachmentUrls))
                    {
                        <div class="ticket-attachments">
                            <div class="ticket-attachments-title">
                                <i data-lucide="paperclip" class="icon-sm"></i>
                                Tệp đính kèm
                            </div>
                            <div class="ticket-attachments-list">
                                @foreach (var url in Model.AttachmentUrls.Split(','))
                                {
                                    var fileName = url.Split('/').LastOrDefault() ?? "Attachment";
                                    <a href="@url" target="_blank" class="admin-btn admin-btn-sm admin-btn-secondary">
                                        <i data-lucide="download"></i>
                                        @fileName
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Conversation / Replies -->
            <div class="admin-card">
                <div class="admin-card-header admin-flex-between">
                    <h3 class="admin-card-title">
                        <i data-lucide="message-circle" class="icon-sm"></i>
                        Lịch sử phản hồi
                        @if (Model.Replies != null && Model.Replies.Any())
                        {
                            <span class="admin-badge admin-badge-info admin-badge-count">@Model.Replies.Count</span>
                        }
                    </h3>
                </div>
                <div class="admin-card-body">
                    @if (Model.Replies != null && Model.Replies.Any())
                    {
                        <div class="ticket-replies">
                            @foreach (var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                            {
                                <div class="ticket-reply @(reply.IsInternal ? "internal" : "external")">
                                    <div class="reply-header">
                                        <div class="reply-author">
                                            <div class="reply-avatar">@(reply.User?.FullName?.Substring(0, 1).ToUpper() ?? "?")</div>
                                            <div class="reply-author-info">
                                                <div class="reply-author-name">@(reply.User?.FullName ?? reply.User?.Email ?? "Unknown")</div>
                                                @if (reply.IsInternal)
                                                {
                                                    <span class="admin-badge admin-badge-warning reply-internal-badge"><i data-lucide="lock" class="icon-xs"></i> Internal</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="reply-timestamp">
                                            <div class="reply-date">@reply.CreatedAt.ToString("dd/MM/yyyy")</div>
                                            <div class="reply-time">@reply.CreatedAt.ToString("HH:mm")</div>
                                        </div>
                                    </div>
                                    <div class="reply-body">@reply.Message</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="admin-empty admin-empty-md">
                            <i data-lucide="inbox" class="icon-lg muted"></i>
                            <p class="admin-empty-text">Chưa có phản hồi nào</p>
                        </div>
                    }

                    <!-- Reply Form -->
                    <div class="reply-form-card admin-mt-lg">
                        <h4 class="admin-form-title"><i data-lucide="send" class="icon-sm"></i> Trả lời ticket</h4>
                        <form method="post" asp-action="ReplyTicket" asp-route-id="@Model.Id">
                            @Html.AntiForgeryToken()
                            <div class="admin-form-group">
                                <label class="admin-form-label">Nội dung phản hồi</label>
                                <textarea name="message" class="admin-form-control" rows="5" placeholder="Nhập nội dung trả lời cho khách hàng..." required></textarea>
                            </div>

                            <div class="admin-form-group">
                                <label class="admin-checkbox">
                                    <input type="checkbox" name="isInternal">
                                    <span>Ghi chú nội bộ (chỉ admin xem được)</span>
                                </label>
                            </div>

                            <button type="submit" class="admin-btn admin-btn-primary">
                                <i data-lucide="send"></i>
                                Gửi phản hồi
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Info & Actions -->
        <div>
            <div class="admin-card admin-mb-lg">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">
                        <i data-lucide="info" class="icon-sm"></i>
                        Thông tin ticket
                    </h3>
                </div>
                <div class="admin-card-body admin-body-nopad">
                    <table class="admin-info-table">
                        <tr>
                            <td>
                                <div class="info-cell">
                                    <i data-lucide="user" class="icon-sm"></i>
                                    <span>Khách hàng</span>
                                </div>
                            </td>
                            <td>
                                @if (Model.User != null)
                                {
                                    <div class="info-value">@Model.User.FullName</div>
                                    <div class="info-meta">@Model.User.Email</div>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-secondary">N/A</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="info-cell">
                                    <i data-lucide="tag" class="icon-sm"></i>
                                    <span>Danh mục</span>
                                </div>
                            </td>
                            <td>
                                @{
                                    var categoryBadge = Model.Category?.ToLower() switch
                                    {
                                        "order" => "info",
                                        "product" => "primary",
                                        "payment" => "success",
                                        "technical" => "warning",
                                        _ => "secondary"
                                    };
                                }
                                <span class="admin-badge admin-badge-@categoryBadge">@Model.Category</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="info-cell">
                                    <i data-lucide="user-check" class="icon-sm"></i>
                                    <span>Người phụ trách</span>
                                </div>
                            </td>
                            <td>
                                @if (Model.AssignedAdmin != null)
                                {
                                    <div class="info-value">@Model.AssignedAdmin.FullName</div>
                                    <div class="info-meta">@Model.AssignedAdmin.Email</div>
                                }
                                else
                                {
                                    <span class="admin-badge admin-badge-secondary">Chưa phân công</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="info-cell">
                                    <i data-lucide="clock" class="icon-sm"></i>
                                    <span>Ngày tạo</span>
                                </div>
                            </td>
                            <td>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        </tr>
                        @if (Model.ResolvedAt.HasValue)
                        {
                            <tr>
                                <td>
                                    <div class="info-cell">
                                        <i data-lucide="check-circle" class="icon-sm"></i>
                                        <span>Đã giải quyết</span>
                                    </div>
                                </td>
                                <td class="resolved-date">@Model.ResolvedAt.Value.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                        @if (Model.ClosedAt.HasValue)
                        {
                            <tr>
                                <td>
                                    <div class="info-cell">
                                        <i data-lucide="x-circle" class="icon-sm"></i>
                                        <span>Đã đóng</span>
                                    </div>
                                </td>
                                <td class="closed-date">@Model.ClosedAt.Value.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                        @if (Model.RelatedOrderId.HasValue && Model.RelatedOrder != null)
                        {
                            <tr>
                                <td>
                                    <div class="info-cell">
                                        <i data-lucide="shopping-bag" class="icon-sm"></i>
                                        <span>Đơn hàng</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="@Url.Action("OrderDetails", "Admin", new { id = Model.RelatedOrderId })" class="admin-info-link">
                                        #@Model.RelatedOrder.OrderNumber
                                        <i data-lucide="external-link" class="icon-xs"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                        @if (Model.RelatedProductId.HasValue && Model.RelatedProduct != null)
                        {
                            <tr>
                                <td>
                                    <div class="info-cell">
                                        <i data-lucide="box" class="icon-sm"></i>
                                        <span>Sản phẩm</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="@Url.Action("Edit", "Products", new { id = Model.RelatedProductId })" class="admin-info-link">
                                        @Model.RelatedProduct.Name
                                        <i data-lucide="external-link" class="icon-xs"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>

            @if (Model.AssignedTo == null)
            {
                <div class="admin-card admin-mb-lg">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="user-plus" class="icon-sm"></i>
                            Phân công ticket
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <form method="post" asp-action="AssignTicket" asp-route-id="@Model.Id">
                            @Html.AntiForgeryToken()
                            <div class="admin-form-group">
                                <label class="admin-form-label">Chọn Admin</label>
                                <select name="adminId" class="admin-form-control" required>
                                    <option value="" disabled selected>-- Chọn Admin --</option>
                                    @if (admins != null)
                                    {
                                        foreach (var admin in admins)
                                        {
                                            <option value="@admin.Id">@admin.Email</option>
                                        }
                                    }
                                </select>
                            </div>
                            <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                                <i data-lucide="check"></i>
                                Gán cho Admin
                            </button>
                        </form>
                    </div>
                </div>
            }

            <div class="admin-card admin-mb-lg">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">
                        <i data-lucide="refresh-cw" class="icon-sm"></i>
                        Cập nhật trạng thái
                    </h3>
                </div>
                <div class="admin-card-body">
                    <form method="post" asp-action="UpdateTicketStatus" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="admin-form-group">
                            <label class="admin-form-label">Trạng thái</label>
                            <select name="status" class="admin-form-control" required>
                                <option value="Open" selected="@(Model.Status == "Open")">Mở</option>
                                <option value="InProgress" selected="@(Model.Status == "InProgress")">Đang xử lý</option>
                                <option value="Resolved" selected="@(Model.Status == "Resolved")">Đã giải quyết</option>
                                <option value="Closed" selected="@(Model.Status == "Closed")">Đã đóng</option>
                            </select>
                        </div>
                        <button type="submit" class="admin-btn admin-btn-success admin-btn-block">
                            <i data-lucide="save"></i>
                            Cập nhật
                        </button>
                    </form>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">
                        <i data-lucide="flag" class="icon-sm"></i>
                        Cập nhật độ ưu tiên
                    </h3>
                </div>
                <div class="admin-card-body">
                    <form method="post" asp-action="UpdateTicketPriority" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="admin-form-group">
                            <label class="admin-form-label">Độ ưu tiên</label>
                            <select name="priority" class="admin-form-control" required>
                                <option value="Low" selected="@(Model.Priority == "Low")">Thấp</option>
                                <option value="Medium" selected="@(Model.Priority == "Medium")">Trung bình</option>
                                <option value="High" selected="@(Model.Priority == "High")">Cao</option>
                                <option value="Urgent" selected="@(Model.Priority == "Urgent")">Khẩn cấp</option>
                            </select>
                        </div>
                        <button type="submit" class="admin-btn admin-btn-warning admin-btn-block">
                            <i data-lucide="save"></i>
                            Cập nhật
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ticket Modal -->
<div class="modal fade" id="editTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-lucide="edit-2"></i>
                    Chỉnh sửa Ticket #@Model.TicketNumber
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="EditTicket" asp-route-id="@Model.Id">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="type" class="icon-sm"></i>
                            Tiêu đề
                        </label>
                        <input type="text" class="admin-form-control" name="subject" 
                               value="@Model.Subject" required maxlength="500">
                    </div>
                    
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="tag" class="icon-sm"></i>
                            Danh mục
                        </label>
                        <select class="admin-form-control" name="category" required>
                            <option value="general" selected="@(Model.Category == "general")">Chung</option>
                            <option value="order" selected="@(Model.Category == "order")">Đơn hàng</option>
                            <option value="product" selected="@(Model.Category == "product")">Sản phẩm</option>
                            <option value="payment" selected="@(Model.Category == "payment")">Thanh toán</option>
                            <option value="technical" selected="@(Model.Category == "technical")">Kỹ thuật</option>
                            <option value="account" selected="@(Model.Category == "account")">Tài khoản</option>
                            <option value="other" selected="@(Model.Category == "other")">Khác</option>
                        </select>
                    </div>
                    
                    <div class="admin-form-group">
                        <label>
                            <i data-lucide="align-left" class="icon-sm"></i>
                            Mô tả chi tiết
                        </label>
                        <textarea class="admin-form-control" name="description" rows="8" required>@Model.Description</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">
                        <i data-lucide="x"></i>
                        Đóng
                    </button>
                    <button type="submit" class="admin-btn admin-btn-primary">
                        <i data-lucide="save"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Edit ticket function
        function editTicket() {
            const modal = new bootstrap.Modal(document.getElementById('editTicketModal'));
            modal.show();
        }

        // Auto-hide success/error messages
        setTimeout(function() {
            document.querySelectorAll('.admin-alert').forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);

        // Reinitialize icons after modal shown
        document.getElementById('editTicketModal')?.addEventListener('shown.bs.modal', function() {
            lucide.createIcons();
        });
    </script>
}

